<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>eProstutiBD ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‚Äî Details</title>

  <meta name="theme-color" content="#0b1220" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2f;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line: rgba(148,163,184,.14);
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.20), transparent 60%),
                  radial-gradient(900px 500px at 100% 10%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1220px;margin:0 auto;padding:18px 14px 60px}

    /* Header */
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.72));
      border-bottom: 1px solid var(--line);
    }
    .topbar .inner{max-width:1220px;margin:0 auto;padding:14px 14px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.95));
      box-shadow: 0 10px 35px rgba(34,197,94,.20);
      display:grid;place-items:center;font-weight:1000;color:#08121f;
    }
    .brand .t1{font-size:15px;line-height:1.1}
    .brand .t2{font-size:11px;color:var(--muted);font-weight:700}
    .grow{flex:1}
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(17,26,47,.7);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      transition:.2s;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.35)}
    .btn:active{transform: translateY(0px)}
    .btn.green{background: rgba(34,197,94,.14);border-color: rgba(34,197,94,.30)}
    .btn.blue{background: rgba(96,165,250,.14);border-color: rgba(96,165,250,.30)}
    .btn.red{background: rgba(239,68,68,.12);border-color: rgba(239,68,68,.28)}
    .pill{
      font-size:12px;font-weight:1000;padding:6px 10px;border-radius:999px;
      background: rgba(29,78,216,.10);border: 1px solid rgba(29,78,216,.18);
      color: var(--text);white-space:nowrap;
    }
    .marq{flex:1;overflow:hidden;white-space:nowrap;color: var(--muted);font-size:12px;}
    .marq span{display:inline-block;padding-left:100%;animation: ticker 18s linear infinite;}
    @keyframes ticker{
      0%{transform: translateX(0)}
      100%{transform: translateX(-100%)}
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .panel{
      background: linear-gradient(180deg, rgba(17,26,47,.9), rgba(15,23,42,.85));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel .hd b{font-size:13px}
    .panel .bd{padding:12px}

    /* Sidebar */
    .search{
      display:flex;gap:8px;align-items:center;
      background: rgba(2,6,23,.38);
      border:1px solid rgba(148,163,184,.14);
      padding:10px 10px;border-radius:14px;
    }
    .search input{
      width:100%;
      background:transparent;border:none;outline:none;
      color:var(--text);
      font-size:13px;
    }
    .list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .item{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.30);
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s;
    }
    .item:hover{border-color: rgba(96,165,250,.30); transform: translateY(-1px)}
    .item.active{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.08)}
    .item .t{font-weight:900;font-size:13px}
    .item .s{font-size:11px;color:var(--muted);margin-top:2px}

    /* Main */
    .toolbar{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    }
    .toolbar .right{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .select{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.30);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-size:13px;font-weight:800;
      outline:none;
    }
    .cards{
      display:grid;grid-template-columns: repeat(12, 1fr);
      gap:10px;margin-top:12px;
    }
    .card{
      grid-column: span 12;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      border-radius:16px;
      padding:12px;
    }
    .card .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .tag{font-size:11px;padding:5px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.16);color:var(--muted)}
    .q{margin-top:8px;font-size:14px;font-weight:900;line-height:1.4}
    .ans{margin-top:10px;color:var(--text);font-size:13px;line-height:1.55}
    .muted{color:var(--muted);font-size:12px}
    .btnSm{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(17,26,47,.55);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      cursor:pointer;font-size:12px;font-weight:900;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btnSm:hover{border-color: rgba(96,165,250,.35)}
    .btnSm.green{background: rgba(34,197,94,.14);border-color: rgba(34,197,94,.30)}
    .btnSm.red{background: rgba(239,68,68,.12);border-color: rgba(239,68,68,.28)}
    .btnSm.blue{background: rgba(96,165,250,.14);border-color: rgba(96,165,250,.30)}

    /* Modal */
    .overlay{
      position:fixed;inset:0;
      background: rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:14px;z-index:50;
    }
    .modal{
      width:min(860px, 100%);
      background: linear-gradient(180deg, rgba(17,26,47,.96), rgba(15,23,42,.96));
      border:1px solid rgba(148,163,184,.16);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhd{
      padding:12px 12px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .modal .mbd{padding:12px}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width:760px){ .grid2{grid-template-columns: 1fr} }
    .field{
      background: rgba(2,6,23,.28);
      border:1px solid rgba(148,163,184,.14);
      padding:10px 10px;border-radius:14px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:900}
    .field input, .field textarea, .field select{
      width:100%;
      background:transparent;border:none;outline:none;
      color:var(--text);font-size:13px;
      font-family: inherit;
      resize: vertical;
    }
    .field textarea{min-height:92px}
    .note{font-size:11px;color:var(--muted);margin-top:8px}
    .adBox{
      margin:14px 0 0;
      border:1px dashed rgba(148,163,184,.28);
      border-radius: 16px;
      padding:12px;
      background: rgba(2,6,23,.25);
    }
    .adHead{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  </style>
</head>

<body>

  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo">eP</div>
        <div>
          <div class="t1">eProstutiBD ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</div>
          <div class="t2">Details ‚Ä¢ MCQ/Written/Model Test</div>
        </div>
      </div>

      <div class="grow"></div>

      <div class="pill" id="userPill">Guest</div>
      <button class="btn blue" onclick="openMenu()">‚ò∞ Menu</button>
    </div>

    <div class="inner" style="padding-top:0;padding-bottom:10px;gap:10px">
      <div class="marq">
        <span id="tickerText">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶®‡¶§‡ßÅ‡¶® Subject ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚Ä¢ ‡¶®‡¶§‡ßÅ‡¶® Model Test ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚Ä¢ ‡¶®‡¶ø‡ßü‡¶Æ‡¶ø‡¶§ ‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ‚Ä¢ ‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶π‡ßã‡¶ï ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá</span>
      </div>
    </div>
  </div>

  <div class="wrap">

  <div class="adBox">
    <div class="adHead"><b>Ad Slot</b><span>Header ‡¶®‡¶ø‡¶ö‡ßá</span></div>
    <div class="muted" style="margin-top:6px">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá</div>
  </div>

  <div class="grid">
    <!-- Sidebar -->
    <div class="panel">
      <div class="hd">
        <b>Subjects</b>
        <span class="tag" id="subCount">0</span>
      </div>
      <div class="bd">
        <div class="search">
          üîé
          <input id="subSearch" placeholder="Subject ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
        </div>
        <div class="list" id="subjectList"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button class="btnSm green" onclick="openSubjectModal()">+ Subject</button>
          <button class="btnSm blue" onclick="refreshAll()">‚Üª Refresh</button>
        </div>
        <div class="note">‡¶®‡ßã‡¶ü: Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶≤‡ßá ‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂‡ßá MCQ/Written/Model Test ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</div>
      </div>
    </div>

    <!-- Main -->
    <div class="panel">
      <div class="hd">
        <b id="titleMain">Details</b>
        <div class="toolbar right">
          <select class="select" id="typeSelect">
            <option value="MCQ">MCQ</option>
            <option value="Written">Written</option>
            <option value="Model Test">Model Test</option>
          </select>
          <button class="btnSm green" onclick="openQuestionModal()">+ Add</button>
          <button class="btnSm blue" onclick="copyLink()">Copy Link</button>
          <button class="btnSm red" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="bd">
        <div class="toolbar">
          <div class="search" style="flex:1">
            üîé
            <input id="qSearch" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (keyword)..." />
          </div>
          <div class="right" style="display:flex;gap:8px;align-items:center">
            <span class="tag" id="qCount">0</span>
            <button class="btnSm" onclick="toggleSort()">Sort: <span id="sortMode">Newest</span></button>
          </div>
        </div>

        <div class="cards" id="cardWrap"></div>

        <div class="adBox">
          <div class="adHead"><b>Ad Slot</b><span>Content ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá</span></div>
          <div class="muted" style="margin-top:6px">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá</div>
        </div>

      </div>
    </div>
  </div>

  </div>

  <!-- Menu Modal -->
  <div class="overlay" id="menuOverlay" onclick="closeMenu(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhd">
        <b>Menu</b>
        <button class="btnSm" onclick="closeMenu()">‚úï Close</button>
      </div>
      <div class="mbd">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btnSm blue" onclick="gotoHome()">üè† Home</button>
          <button class="btnSm" onclick="gotoDashboard()">üìä Dashboard</button>
          <button class="btnSm" onclick="gotoAdmin()">üõ† Admin</button>
        </div>
        <div class="note">‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá account ‡¶¶‡¶ø‡ßü‡ßá login ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‡¶§‡¶æ‡¶∞ permission ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ options ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡•§</div>
      </div>
    </div>
  </div>

  <!-- Subject Modal -->
  <div class="overlay" id="subjectOverlay" onclick="closeSubjectModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhd">
        <b>Add / Edit Subject</b>
        <button class="btnSm" onclick="closeSubjectModal()">‚úï Close</button>
      </div>
      <div class="mbd">
        <div class="grid2">
          <div class="field">
            <label>Subject Name</label>
            <input id="subName" placeholder="e.g. ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞" />
          </div>
          <div class="field">
            <label>Category (optional)</label>
            <input id="subCat" placeholder="e.g. SSC / HSC / Admission" />
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button class="btnSm green" onclick="saveSubject()">Save</button>
          <button class="btnSm red" onclick="deleteSubject()">Delete</button>
        </div>
        <div class="note">Subject save ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ sidebar ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</div>
      </div>
    </div>
  </div>

  <!-- Question Modal -->
  <div class="overlay" id="questionOverlay" onclick="closeQuestionModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhd">
        <b>Add / Edit Question</b>
        <button class="btnSm" onclick="closeQuestionModal()">‚úï Close</button>
      </div>
      <div class="mbd">
        <div class="grid2">
          <div class="field">
            <label>Type</label>
            <select id="qType">
              <option value="MCQ">MCQ</option>
              <option value="Written">Written</option>
              <option value="Model Test">Model Test</option>
            </select>
          </div>
          <div class="field">
            <label>Difficulty (optional)</label>
            <select id="qDiff">
              <option value="">Select</option>
              <option value="Easy">Easy</option>
              <option value="Medium">Medium</option>
              <option value="Hard">Hard</option>
            </select>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Question</label>
          <textarea id="qText" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Answer / Explanation</label>
          <textarea id="aText" placeholder="‡¶â‡¶§‡ßç‡¶§‡¶∞ / ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>Tag (optional)</label>
            <input id="qTag" placeholder="e.g. Grammar / Math" />
          </div>
          <div class="field">
            <label>Order (optional)</label>
            <input id="qOrder" placeholder="e.g. 1" />
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button class="btnSm green" onclick="saveQuestion()">Save</button>
          <button class="btnSm red" onclick="deleteQuestion()">Delete</button>
        </div>
        <div class="note">‡¶®‡ßã‡¶ü: Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® Save ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // =============================
  // ‚úÖ Firebase Config (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶∞‡¶æ‡¶ñ‡¶æ)
  // =============================
  const firebaseConfig = {
    apiKey: "AIzaSyBo1bZiY6GprB_4fZj8iD_S_OH3o0uhQ3s",
    authDomain: "eprostutibd-firebase.firebaseapp.com",
    projectId: "eprostutibd-firebase",
    storageBucket: "eprostutibd-firebase.appspot.com",
    messagingSenderId: "630291178178",
    appId: "1:630291178178:web:5a5b3a4ab1f48e62062c12"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const $ = (id)=>document.getElementById(id);

  function openMenu(){ $("menuOverlay").style.display="flex"; }
  function closeMenu(e){
    if(!e || e.target.id==="menuOverlay") $("menuOverlay").style.display="none";
  }

  function openSubjectModal(){ editingSubjectId=null; $("subName").value=""; $("subCat").value=""; $("subjectOverlay").style.display="flex"; }
  function closeSubjectModal(e){ if(!e || e.target.id==="subjectOverlay") $("subjectOverlay").style.display="none"; }

  function openQuestionModal(){
    if(!selectedSubjectId){ alert("‡¶Ü‡¶ó‡ßá Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
    editingQuestionId=null;
    $("qType").value = $("typeSelect").value;
    $("qDiff").value="";
    $("qText").value="";
    $("aText").value="";
    $("qTag").value="";
    $("qOrder").value="";
    $("questionOverlay").style.display="flex";
  }
  function closeQuestionModal(e){ if(!e || e.target.id==="questionOverlay") $("questionOverlay").style.display="none"; }

  function gotoHome(){ location.href="index.html"; }
  function gotoDashboard(){ location.href="dashboard.html"; }
  function gotoAdmin(){ location.href="admin.html"; }

  function logout(){
    auth.signOut().then(()=>location.href="login.html").catch(()=>location.reload());
  }

  // =============================
  // ‚úÖ State
  // =============================
  let subjects = [];
  let questions = [];
  let selectedSubjectId = null;
  let selectedSubjectName = "";
  let editingSubjectId = null;
  let editingQuestionId = null;
  let sortNewest = true;

  // =============================
  // ‚úÖ Helpers
  // =============================
  function nowTS(){ return Date.now(); }

  function copyLink(){
    const params = new URLSearchParams();
    if(selectedSubjectId) params.set("subject", selectedSubjectId);
    params.set("type", $("typeSelect").value);
    const url = location.origin + location.pathname + "?" + params.toString();
    navigator.clipboard.writeText(url).then(()=>alert("Link copied!"));
  }

  function toggleSort(){
    sortNewest = !sortNewest;
    $("sortMode").textContent = sortNewest ? "Newest" : "Oldest";
    renderQuestions();
  }

  function refreshAll(){
    // Simply re-render based on current cached state
    renderSubjectList();
    renderQuestions();
  }

  function setUrlState(){
    const params = new URLSearchParams(location.search);
    if(selectedSubjectId) params.set("subject", selectedSubjectId);
    params.set("type", $("typeSelect").value);
    const newUrl = location.pathname + "?" + params.toString();
    history.replaceState({}, "", newUrl);
  }

  function loadFromUrl(){
    const params = new URLSearchParams(location.search);
    const sid = params.get("subject");
    const type = params.get("type");
    if(type) $("typeSelect").value = type;
    if(sid) selectedSubjectId = sid;
  }

  // =============================
  // ‚úÖ Auth Guard
  // =============================
  auth.onAuthStateChanged((user)=>{
    if(!user){
      $("userPill").textContent = "Guest";
      // redirect
      // location.href="login.html";
      // (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá ‡¶Ø‡ßá‡¶≠‡¶æ‡¶¨‡ßá ‡¶õ‡¶ø‡¶≤ ‡¶∏‡ßá‡¶≠‡¶æ‡¶¨‡ßá‡¶á ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)
    }else{
      $("userPill").textContent = user.email || "User";
    }
    init();
  });

  // =============================
  // ‚úÖ Firestore realtime
  // =============================
  let unsubSubjects = null;
  let unsubQuestions = null;

  function init(){
    loadFromUrl();

    // Subjects
    if(unsubSubjects) unsubSubjects();
    unsubSubjects = db.collection("prosnobank_subjects")
      .orderBy("createdAt","desc")
      .onSnapshot((snap)=>{
        subjects = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderSubjectList();
        applySelectedFromUrlOrFirst();
      });

    // Questions
    if(unsubQuestions) unsubQuestions();
    unsubQuestions = db.collection("prosnobank_questions")
      .orderBy("createdAt","desc")
      .onSnapshot((snap)=>{
        questions = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderQuestions();
      });

    $("subSearch").addEventListener("input", renderSubjectList);
    $("qSearch").addEventListener("input", renderQuestions);
    $("typeSelect").addEventListener("change", ()=>{
      // ticker update (safe)
      const tickerEl = $("tickerText");
      if (tickerEl) {
        tickerEl.textContent = selectedSubjectName
          ? `${selectedSubjectName} ‚Ä¢ MCQ/Written/Model Test`
          : "Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‚Ä¢ MCQ/Written/Model Test";
      }
      setUrlState();
      renderQuestions();
    });
  }

  function applySelectedFromUrlOrFirst(){
    if(selectedSubjectId){
      const found = subjects.find(s=>s.id===selectedSubjectId);
      if(found) selectSubject(found.id);
      else if(subjects[0]) selectSubject(subjects[0].id);
    }else{
      if(subjects[0]) selectSubject(subjects[0].id);
    }
  }

  // =============================
  // ‚úÖ Render Subjects
  // =============================
  function renderSubjectList(){
    const kw = ($("subSearch").value||"").trim().toLowerCase();
    const list = $("subjectList");
    list.innerHTML = "";
    const filtered = subjects.filter(s=>{
      const name=(s.name||"").toLowerCase();
      const cat=(s.category||"").toLowerCase();
      return !kw || name.includes(kw) || cat.includes(kw);
    });

    $("subCount").textContent = filtered.length;

    filtered.forEach(s=>{
      const div = document.createElement("div");
      div.className = "item" + (s.id===selectedSubjectId ? " active" : "");
      div.innerHTML = `
        <div class="t">${escapeHtml(s.name||"Unnamed")}</div>
        <div class="s">${escapeHtml(s.category||"")}</div>
      `;
      div.onclick = ()=> selectSubject(s.id);
      div.oncontextmenu = (e)=>{
        e.preventDefault();
        editingSubjectId = s.id;
        $("subName").value = s.name || "";
        $("subCat").value = s.category || "";
        $("subjectOverlay").style.display="flex";
      };
      list.appendChild(div);
    });
  }

  function selectSubject(id){
    selectedSubjectId = id;
    const s = subjects.find(x=>x.id===id);
    selectedSubjectName = s ? (s.name||"") : "";

    $("titleMain").textContent = selectedSubjectName ? `Details ‚Äî ${selectedSubjectName}` : "Details";

    // ‚úÖ ticker safe update
    const tickerEl = $("tickerText");
    if (tickerEl) {
      tickerEl.textContent = selectedSubjectName
        ? `${selectedSubjectName} ‚Ä¢ MCQ/Written/Model Test`
        : "Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‚Ä¢ MCQ/Written/Model Test";
    }

    renderSubjectList();
    renderQuestions();

    setUrlState();
  }

  // =============================
  // ‚úÖ Render Questions
  // =============================
  function renderQuestions(){
    const wrap = $("cardWrap");
    const kw = ($("qSearch").value||"").trim().toLowerCase();
    const type = $("typeSelect").value;

    let items = questions.filter(q=>{
      return q.subjectId===selectedSubjectId && q.type===type;
    });

    if(kw){
      items = items.filter(q=>{
        const qt=(q.question||"").toLowerCase();
        const at=(q.answer||"").toLowerCase();
        const tg=(q.tag||"").toLowerCase();
        return qt.includes(kw) || at.includes(kw) || tg.includes(kw);
      });
    }

    items.sort((a,b)=>{
      const aa = a.createdAt || 0;
      const bb = b.createdAt || 0;
      return sortNewest ? (bb-aa) : (aa-bb);
    });

    $("qCount").textContent = items.length;
    wrap.innerHTML = "";

    if(!selectedSubjectId){
      wrap.innerHTML = `<div class="card"><div class="muted">Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div></div>`;
      return;
    }

    if(items.length===0){
      wrap.innerHTML = `<div class="card"><div class="muted">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á</div></div>`;
      return;
    }

    items.forEach((q,idx)=>{
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML = `
        <div class="row">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="tag">${escapeHtml(q.type||"")}</span>
            ${q.diff ? `<span class="tag">Diff: ${escapeHtml(q.diff)}</span>` : ``}
            ${q.tag ? `<span class="tag">${escapeHtml(q.tag)}</span>` : ``}
            ${q.order ? `<span class="tag">#${escapeHtml(String(q.order))}</span>` : ``}
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btnSm blue" data-act="edit">‚úé Edit</button>
            <button class="btnSm" data-act="copy">‚ßâ Copy</button>
          </div>
        </div>

        <div class="q">${idx+1}. ${escapeHtml(q.question||"")}</div>
        <div class="ans">${nl2br(escapeHtml(q.answer||""))}</div>
        <div class="muted" style="margin-top:8px">Updated: ${fmtDate(q.updatedAt||q.createdAt)}</div>
      `;

      div.querySelector('[data-act="edit"]').onclick = ()=>{
        editingQuestionId = q.id;
        $("qType").value = q.type || "MCQ";
        $("qDiff").value = q.diff || "";
        $("qText").value = q.question || "";
        $("aText").value = q.answer || "";
        $("qTag").value = q.tag || "";
        $("qOrder").value = q.order || "";
        $("questionOverlay").style.display="flex";
      };

      div.querySelector('[data-act="copy"]').onclick = ()=>{
        const txt = `Q: ${q.question||""}\nA: ${q.answer||""}`;
        navigator.clipboard.writeText(txt).then(()=>alert("Copied!"));
      };

      wrap.appendChild(div);
    });
  }

  // =============================
  // ‚úÖ Subject CRUD
  // =============================
  function saveSubject(){
    const name = ($("subName").value||"").trim();
    const category = ($("subCat").value||"").trim();
    if(!name){ alert("Subject Name ‡¶¶‡¶ø‡¶®"); return; }

    const payload = {
      name, category,
      updatedAt: nowTS()
    };

    if(editingSubjectId){
      db.collection("prosnobank_subjects").doc(editingSubjectId).set(payload, {merge:true})
        .then(()=>{ closeSubjectModal(); editingSubjectId=null; })
        .catch(err=>alert(err.message));
    }else{
      payload.createdAt = nowTS();
      db.collection("prosnobank_subjects").add(payload)
        .then(()=> closeSubjectModal())
        .catch(err=>alert(err.message));
    }
  }

  function deleteSubject(){
    if(!editingSubjectId){ alert("Edit mode ‡¶•‡ßá‡¶ï‡ßá Delete ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
    if(!confirm("Subject delete ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;

    const sid = editingSubjectId;
    db.collection("prosnobank_subjects").doc(sid).delete()
      .then(()=>{
        closeSubjectModal();
        editingSubjectId=null;
        if(selectedSubjectId===sid){ selectedSubjectId=null; selectedSubjectName=""; }
      })
      .catch(err=>alert(err.message));
  }

  // =============================
  // ‚úÖ Question CRUD
  // =============================
  function saveQuestion(){
    if(!selectedSubjectId){ alert("‡¶Ü‡¶ó‡ßá Subject ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }

    const type = $("qType").value;
    const diff = $("qDiff").value;
    const question = ($("qText").value||"").trim();
    const answer = ($("aText").value||"").trim();
    const tag = ($("qTag").value||"").trim();
    const order = ($("qOrder").value||"").trim();

    if(!question){ alert("Question ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"); return; }

    const payload = {
      subjectId: selectedSubjectId,
      subjectName: selectedSubjectName || "",
      type, diff,
      question, answer,
      tag,
      order: order ? Number(order) : "",
      updatedAt: nowTS()
    };

    if(editingQuestionId){
      db.collection("prosnobank_questions").doc(editingQuestionId).set(payload,{merge:true})
        .then(()=>{ closeQuestionModal(); editingQuestionId=null; })
        .catch(err=>alert(err.message));
    }else{
      payload.createdAt = nowTS();
      db.collection("prosnobank_questions").add(payload)
        .then(()=> closeQuestionModal())
        .catch(err=>alert(err.message));
    }
  }

  function deleteQuestion(){
    if(!editingQuestionId){ alert("Edit mode ‡¶•‡ßá‡¶ï‡ßá Delete ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
    if(!confirm("Question delete ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;

    db.collection("prosnobank_questions").doc(editingQuestionId).delete()
      .then(()=>{ closeQuestionModal(); editingQuestionId=null; })
      .catch(err=>alert(err.message));
  }

  // =============================
  // ‚úÖ Utils
  // =============================
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function nl2br(s){ return (s||"").replace(/\n/g,"<br>"); }
  function fmtDate(ts){
    if(!ts) return "-";
    const d = new Date(ts);
    return d.toLocaleString("bn-BD", {year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }
  </script>

</body>
</html>
