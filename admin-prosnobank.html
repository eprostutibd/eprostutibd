<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>প্রশ্নব্যাংক অ্যাডমিন পেজ</title>

  <style>
    :root{
      --bg:#070c18;
      --panel: rgba(18,26,43,.88);
      --line: rgba(255,255,255,.10);
      --muted:#a3b0c9;
      --text:#eef3ff;
      --accent:#6aa6ff;
      --ok:#5ce3a4;
      --danger:#ff6a6a;
      --warn:#ffd36a;
      --shadow: 0 14px 40px rgba(0,0,0,.42);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 15%, rgba(106,166,255,.20), transparent 55%),
        radial-gradient(900px 650px at 85% 18%, rgba(92,227,164,.14), transparent 55%),
        radial-gradient(900px 650px at 50% 100%, rgba(255,211,106,.10), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(7,12,24,.72);
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:16px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,166,255,.95), rgba(92,227,164,.88));
      box-shadow: var(--shadow);
    }
    h1{margin:0; font-size:18px}
    .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .pill{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      min-width: 190px;
      justify-content:center;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .grid{
      display:grid;
      grid-template-columns: 310px 1fr;
      gap:14px;
      padding: 14px 0;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .bd{padding:14px}
    .note{font-size:12px; color:var(--muted); line-height:1.5}
    .small{font-size:12px; color:var(--muted)}
    .divider{height:1px; background: var(--line); margin:12px 0}

    .tabs{display:flex; flex-direction:column; gap:10px;}
    .tabbtn{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      transition:.15s;
    }
    .tabbtn:hover{border-color: rgba(255,255,255,.22)}
    .tabbtn.active{
      border-color: rgba(106,166,255,.55);
      background: rgba(106,166,255,.12);
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 620px){ .stats{grid-template-columns:1fr} }
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .stat b{font-size:18px; display:block; margin-bottom:4px}
    .stat span{font-size:12px; color:var(--muted)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px;}
    input, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(106,166,255,.55)}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{border-color: rgba(255,255,255,.22)}
    .btn.primary{border-color: rgba(106,166,255,.6); background: rgba(106,166,255,.16);}
    .btn.ok{border-color: rgba(92,227,164,.6); background: rgba(92,227,164,.12);}
    .btn.danger{border-color: rgba(255,106,106,.6); background: rgba(255,106,106,.12);}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{
      margin:0;
      font-size:15px;
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 560px;
    }
    .meta2{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(0,0,0,.08);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .modalback{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalback.show{display:flex}
    .modal{
      width:min(920px, 100%);
      background: rgba(18,26,43,.98);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mhd{padding: 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .mbd{padding: 14px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px; color: var(--muted);
      border:1px dashed var(--line);
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,.03);
      overflow:auto;
      white-space: pre-wrap;
    }

    .toast{
      position: fixed; right: 16px; bottom: 16px;
      background: rgba(18,26,43,.95);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
      max-width: 460px;
      display:none;
      z-index: 90;
    }
    .toast.show{display:block}
    .toast b{display:block; margin-bottom:4px}
    .toast .tmuted{color:var(--muted); font-size:12px}

    #authGate{
      position: fixed; inset: 0; z-index: 100;
      background: rgba(7,12,24,.92);
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
    }
    .authCard{
      width: min(560px, 100%);
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(18,26,43,.92);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .authCard h2{margin: 6px 0 4px; font-size: 18px;}
    .authRow{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    .authRow > *{flex:1}
  </style>
</head>

<body>

<!-- AUTH GATE -->
<div id="authGate">
  <div class="authCard">
    <div style="display:flex; gap:12px; align-items:center;">
      <div class="logo"></div>
      <div>
        <h2>Admin Access Required</h2>
        <div class="note">শুধু <b>eprostutibd@gmail.com</b> দিয়ে লগইন করলে admin পেজ ব্যবহার করা যাবে।</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="note" id="authStatus">Checking login...</div>
    <div class="authRow">
      <button class="btn primary" id="btnLogin">Login with Google</button>
      <button class="btn" id="btnLogout" disabled>Logout</button>
    </div>
    <div class="divider"></div>
    <div class="note">
      যদি error হয়: <b>Console (F12)</b> এ দেখাবে + এখানে message আসবে।
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>প্রশ্নব্যাংক অ্যাডমিন পেজ</h1>
          <div class="sub">Compat Firebase (no module) • Stable login • Marks removed</div>
        </div>
      </div>
      <div class="pill">
        <span id="connDot" class="dot"></span>
        <span id="connText">Login required</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <b>Admin Menu</b>
        <span class="small" id="whoami">Admin</span>
      </div>
      <div class="bd">
        <div class="stats">
          <div class="stat"><b id="statSubjects">0</b><span>Total Subjects</span></div>
          <div class="stat"><b id="statModelTests">0</b><span>Total Model Tests (selected subject)</span></div>
          <div class="stat"><b id="statQuestions">0</b><span>Total Questions (from subject counts)</span></div>
        </div>

        <div class="divider"></div>

        <div class="tabs">
          <button id="tabSubjects" class="tabbtn active" onclick="showTab('subjects')">
            <span>Subjects</span><span class="small">Add / Import / Delete</span>
          </button>
          <button id="tabModelTests" class="tabbtn" onclick="showTab('modeltests')">
            <span>Model Tests</span><span class="small">Add / Import / Delete</span>
          </button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" onclick="openHelp()">CSV/XLSX Format</button>
          <button class="btn ok" id="btnRefresh" onclick="manualRefresh()" disabled>Refresh</button>
        </div>

        <div class="divider"></div>

        <div class="note">
          ✅ MCQ header: <b>question, option1..4, right ans, note</b><br/>
          ✅ Written header: <b>question, right ans, note</b><br/>
          ✅ Only admin email can write
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <b id="pageTitle">Subjects</b>
        <div class="small" id="pageHint">Manage subjects & import questions</div>
      </div>

      <div class="bd">
        <!-- SUBJECTS -->
        <section id="subjectsSection">
          <div class="row">
            <div class="field">
              <label>নতুন Subject নাম</label>
              <input id="subjectName" placeholder="যেমন: Physics / গণিত / বাংলা" />
            </div>
            <div class="field" style="flex:0 0 190px">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnAddSubject" onclick="addSubject()" disabled style="width:100%">Add Subject</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Search Subject</label>
              <input id="subjectSearch" placeholder="টাইপ করে খুঁজুন..." oninput="renderSubjects()" />
            </div>
          </div>

          <div class="divider"></div>

          <div id="subjectsList" class="list"></div>
          <div id="subjectsEmpty" class="note" style="display:none">এখনও কোনো Subject নেই।</div>
        </section>

        <!-- MODEL TESTS -->
        <section id="modelTestsSection" style="display:none">
          <div class="row">
            <div class="field">
              <label>Subject Select</label>
              <select id="mtSubjectSelect" onchange="onMtSubjectChange()"></select>
            </div>
            <div class="field">
              <label>Model Test Title</label>
              <input id="mtTitle" placeholder="যেমন: Model Test 1" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Total Time (minutes)</label>
              <input id="mtTime" type="number" min="0" placeholder="যেমন: 60" />
            </div>
            <div class="field">
              <label>Total Marks</label>
              <input id="mtMarks" type="number" min="0" placeholder="যেমন: 100" />
            </div>
            <div class="field" style="flex:0 0 190px">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnAddModelTest" onclick="addModelTest()" disabled style="width:100%">Add Model Test</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Search Model Test</label>
              <input id="mtSearch" placeholder="টাইপ করে খুঁজুন..." oninput="renderModelTests()" />
            </div>
          </div>

          <div class="divider"></div>

          <div id="modelTestsList" class="list"></div>
          <div id="modelTestsEmpty" class="note" style="display:none">এই Subject এ এখনও কোনো Model Test নেই।</div>
        </section>
      </div>
    </div>

  </div>
</main>

<!-- IMPORT MODAL -->
<div id="importBack" class="modalback" onclick="closeImport(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhd">
      <b id="importTitle">Import Questions</b>
      <button class="btn" onclick="closeImport()">Close</button>
    </div>
    <div class="mbd">
      <div class="row">
        <div class="field">
          <label>Question Type</label>
          <select id="importType">
            <option value="mcq">MCQ</option>
            <option value="written">Written</option>
          </select>
        </div>
        <div class="field">
          <label>CSV / Excel File</label>
          <input id="importFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Answer Format</label>
          <select id="answerFormat">
            <option value="auto">Auto (A/B/C/D or 1/2/3/4 or option text)</option>
            <option value="letter">A/B/C/D only</option>
            <option value="number">1/2/3/4 only</option>
            <option value="text">Must match option text</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn ok" id="btnDoImport" onclick="doImport()" disabled style="width:100%">Start Import</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="note">Import করলে Firestore এ প্রশ্ন add হবে এবং counts auto update হবে।</div>
      <div class="divider"></div>
      <div class="kbd" id="importLog">Ready.</div>
    </div>
  </div>
</div>

<!-- HELP MODAL -->
<div id="helpBack" class="modalback" onclick="closeHelp(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhd">
      <b>CSV/XLSX Format</b>
      <button class="btn" onclick="closeHelp()">Close</button>
    </div>
    <div class="mbd">
      <div class="note">প্রথম row এ header থাকবে। Excel এও একই header রাখবে।</div>
      <div class="divider"></div>

      <b>MCQ</b>
      <div class="kbd">question, option1, option2, option3, option4, right ans, note</div>

      <div class="divider"></div>

      <b>Written</b>
      <div class="kbd">question, right ans, note</div>

      <div class="divider"></div>

      <div class="note">
        ✅ <b>right ans</b> = A/B/C/D অথবা 1/2/3/4 অথবা option text<br/>
        ✅ <b>note</b> explanation হিসেবে save হবে।<br/>
        ✅ marks নেই।
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">
  <b id="toastTitle">Message</b>
  <div id="toastMsg" class="tmuted"></div>
</div>

<!-- CSV / XLSX libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase compat (NO module) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>

<script>
  // ===== CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
    authDomain: "eprostutibd-webapp.firebaseapp.com",
    projectId: "eprostutibd-webapp",
    storageBucket: "eprostutibd-webapp.firebasestorage.app",
    messagingSenderId: "1044069942330",
    appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
    measurementId: "G-T2G55NMDQT"
  };
  const ADMIN_EMAIL = "eprostutibd@gmail.com";

  // ===== INIT =====
  firebase.initializeApp(firebaseConfig);
  try { firebase.analytics(); } catch(e){}

  const auth = firebase.auth();
  const db = firebase.firestore();

  const $ = (id)=>document.getElementById(id);

  // ===== UI helpers =====
  function toast(title, msg){
    $("toastTitle").textContent = title;
    $("toastMsg").textContent = msg;
    const t = $("toast");
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2800);
  }
  function setConn(ok, text){
    $("connDot").classList.toggle("ok", !!ok);
    $("connText").textContent = text;
  }
  function setAuthorizedUI(isAuthorized, userEmail){
    $("btnRefresh").disabled = !isAuthorized;
    $("btnAddSubject").disabled = !isAuthorized;
    $("btnAddModelTest").disabled = !isAuthorized;
    $("btnDoImport").disabled = !isAuthorized;

    $("btnLogout").disabled = !isAuthorized;
    $("btnLogin").disabled = isAuthorized;

    $("whoami").textContent = isAuthorized ? ("Admin: " + (userEmail || "")) : "Admin (blocked)";
    setConn(isAuthorized, isAuthorized ? "Connected (admin)" : "Login required");
  }
  function showGate(msg){
    $("authGate").style.display = "flex";
    $("authStatus").textContent = msg || "Please login with eprostutibd@gmail.com";
    setAuthorizedUI(false, "");
  }
  function hideGate(){ $("authGate").style.display = "none"; }

  function esc(str){
    return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ===== STATE =====
  let SUBJECTS = [];
  let MODEL_TESTS = [];
  let CURRENT_TAB = "subjects";
  let importTarget = null;

  let unsubSubjects = null;
  let unsubModelTests = null;

  function toMs(ts){
    try{
      if(!ts) return 0;
      if(typeof ts.toDate === "function") return ts.toDate().getTime();
      return 0;
    }catch{ return 0; }
  }

  // ===== AUTH =====
  async function login(){
    try{
      $("authStatus").textContent = "Opening Google login...";
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });

      const res = await auth.signInWithPopup(provider);
      await res.user.getIdToken(true); // refresh token (rules)

      const email = (res.user.email || "").toLowerCase();
      if(email !== ADMIN_EMAIL.toLowerCase()){
        $("authStatus").textContent = "❌ Not authorized. Signing out...";
        await auth.signOut();
        toast("Not authorized", "শুধু eprostutibd@gmail.com admin access পাবে।");
        return;
      }
    }catch(err){
      console.error(err);
      const msg = err?.message || String(err);
      $("authStatus").textContent = "Login failed: " + msg;
      toast("Login failed", msg);

      // Common helpful hint:
      if((err?.code||"") === "auth/unauthorized-domain"){
        toast("Fix needed", "Firebase Console → Auth → Authorized domains এ আপনার domain add করুন।");
      }
    }
  }
  async function logout(){ await auth.signOut(); }

  $("btnLogin").onclick = login;
  $("btnLogout").onclick = logout;

  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      detachAll();
      showGate("Please login with eprostutibd@gmail.com");
      return;
    }
    try{ await user.getIdToken(true); }catch(e){}

    const email = (user.email || "").toLowerCase();
    if(email !== ADMIN_EMAIL.toLowerCase()){
      detachAll();
      $("authStatus").textContent = "❌ Only admin allowed. Signing out...";
      await auth.signOut();
      showGate("❌ Only eprostutibd@gmail.com is allowed.");
      return;
    }

    hideGate();
    setAuthorizedUI(true, user.email);
    attachSubjectsSnapshot();
    toast("Welcome", "Admin access granted");
  });

  // ===== SNAPSHOTS =====
  function detachAll(){
    if(unsubSubjects){ unsubSubjects(); unsubSubjects=null; }
    if(unsubModelTests){ unsubModelTests(); unsubModelTests=null; }
  }

  function attachSubjectsSnapshot(){
    if(unsubSubjects){ unsubSubjects(); unsubSubjects=null; }

    unsubSubjects = db.collection("subjects")
      .onSnapshot((snap)=>{
        SUBJECTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        SUBJECTS.sort((a,b)=> (toMs(b.createdAt)||toMs(b.updatedAt)||0) - (toMs(a.createdAt)||toMs(a.updatedAt)||0));
        populateSubjectSelect();
        renderSubjects();
        refreshStats();

        if(CURRENT_TAB === "modeltests") attachModelTestsSnapshot();
      }, (err)=>{
        console.error(err);
        toast("Firestore error", err?.message || "Subjects snapshot failed");
        setConn(false, "Rules/Auth error?");
      });
  }

  function attachModelTestsSnapshot(){
    if(unsubModelTests){ unsubModelTests(); unsubModelTests=null; }

    const subjectId = $("mtSubjectSelect").value;
    if(!subjectId){
      MODEL_TESTS = [];
      renderModelTests();
      refreshStats();
      return;
    }

    // ✅ no orderBy (prevents “appears then disappears” issues)
    unsubModelTests = db.collection("model_tests")
      .where("subjectId","==",subjectId)
      .onSnapshot((snap)=>{
        MODEL_TESTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        MODEL_TESTS.sort((a,b)=> (toMs(b.createdAt)||toMs(b.updatedAt)||0) - (toMs(a.createdAt)||toMs(a.updatedAt)||0));
        renderModelTests();
        refreshStats();
      }, (err)=>{
        console.error(err);
        toast("Firestore error", err?.message || "Model tests snapshot failed");
      });
  }

  // ===== TABS =====
  function showTab(tab){
    CURRENT_TAB = tab;

    $("tabSubjects").classList.toggle("active", tab==="subjects");
    $("tabModelTests").classList.toggle("active", tab==="modeltests");

    $("subjectsSection").style.display = tab==="subjects" ? "block" : "none";
    $("modelTestsSection").style.display = tab==="modeltests" ? "block" : "none";

    $("pageTitle").textContent = tab==="subjects" ? "Subjects" : "Model Tests";
    $("pageHint").textContent = tab==="subjects"
      ? "Manage subjects & import questions"
      : "Manage model tests & import questions";

    if(tab==="modeltests") attachModelTestsSnapshot();
    else if(unsubModelTests){ unsubModelTests(); unsubModelTests=null; }
  }
  window.showTab = showTab;

  function manualRefresh(){
    populateSubjectSelect();
    renderSubjects();
    if(CURRENT_TAB==="modeltests") attachModelTestsSnapshot();
    toast("Refreshed", "UI updated");
  }
  window.manualRefresh = manualRefresh;

  // ===== STATS =====
  function refreshStats(){
    $("statSubjects").textContent = String(SUBJECTS.length);
    $("statModelTests").textContent = String(MODEL_TESTS.length);
    const approxQ = SUBJECTS.reduce((sum,s)=> sum + (s.counts?.mcq||0) + (s.counts?.written||0), 0);
    $("statQuestions").textContent = String(approxQ);
  }

  // ===== SUBJECT SELECT =====
  function populateSubjectSelect(){
    const sel = $("mtSubjectSelect");
    const prev = sel.value;
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = SUBJECTS.length ? "Select subject..." : "No subjects yet";
    sel.appendChild(opt0);

    SUBJECTS.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(s=>{
      const o = document.createElement("option");
      o.value = s.id;
      o.textContent = s.name;
      sel.appendChild(o);
    });

    if(prev) sel.value = prev;
    if(!sel.value && SUBJECTS.length) sel.value = SUBJECTS[0].id;
  }
  function onMtSubjectChange(){
    if(CURRENT_TAB==="modeltests") attachModelTestsSnapshot();
  }
  window.onMtSubjectChange = onMtSubjectChange;

  // ===== RENDER =====
  function renderSubjects(){
    const q = ($("subjectSearch").value||"").trim().toLowerCase();
    const list = $("subjectsList");
    list.innerHTML = "";

    const filtered = SUBJECTS.filter(s=>(s.name||"").toLowerCase().includes(q));
    $("subjectsEmpty").style.display = filtered.length ? "none" : "block";

    filtered.forEach(s=>{
      const counts = s.counts || { mcq:0, written:0 };
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="min-width:0">
          <p class="title">${esc(s.name||"(no name)")}</p>
          <div class="meta2">
            <span class="chip">MCQ: <b>${counts.mcq||0}</b></span>
            <span class="chip">Written: <b>${counts.written||0}</b></span>
            <span class="chip">ID: ${s.id}</span>
          </div>
          <div class="note" style="margin-top:8px">
            Import করলে <b>subject_questions</b> এ যাবে।
          </div>
        </div>
        <div class="actions">
          <button class="btn" onclick="editSubjectPrompt('${s.id}')">Edit</button>
          <button class="btn danger" onclick="deleteSubjectCascade('${s.id}')">Delete (Cascade)</button>
          <button class="btn ok" onclick="openSubjectImport('${s.id}')">Import</button>
        </div>
      `;
      list.appendChild(el);
    });

    refreshStats();
  }
  window.renderSubjects = renderSubjects;

  function renderModelTests(){
    const q = ($("mtSearch").value||"").trim().toLowerCase();
    const list = $("modelTestsList");
    list.innerHTML = "";

    const filtered = MODEL_TESTS.filter(m=>(m.title||"").toLowerCase().includes(q));
    $("modelTestsEmpty").style.display = filtered.length ? "none" : "block";

    filtered.forEach(m=>{
      const counts = m.counts || { mcq:0, written:0 };
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="min-width:0">
          <p class="title">${esc(m.title||"(no title)")}</p>
          <div class="meta2">
            <span class="chip">Time: <b>${m.totalTimeMin||0}</b> min</span>
            <span class="chip">Marks: <b>${m.totalMarks||0}</b></span>
            <span class="chip">MCQ: <b>${counts.mcq||0}</b></span>
            <span class="chip">Written: <b>${counts.written||0}</b></span>
            <span class="chip">ID: ${m.id}</span>
          </div>
        </div>
        <div class="actions">
          <button class="btn" onclick="editModelTestPrompt('${m.id}')">Edit</button>
          <button class="btn danger" onclick="deleteModelTestCascade('${m.id}')">Delete (Cascade)</button>
          <button class="btn ok" onclick="openModelTestImport('${m.id}')">Import</button>
        </div>
      `;
      list.appendChild(el);
    });

    refreshStats();
  }
  window.renderModelTests = renderModelTests;

  // ===== CRUD: SUBJECTS =====
  async function addSubject(){
    const name = ($("subjectName").value||"").trim();
    if(!name) return toast("Validation","Subject নাম দিন।");
    try{
      await db.collection("subjects").add({
        name,
        counts:{ mcq:0, written:0 },
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $("subjectName").value="";
      toast("Done","Subject added");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Add subject failed");
    }
  }
  window.addSubject = addSubject;

  async function editSubjectPrompt(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;
    const newName = prompt("Subject নাম:", s.name||"");
    if(newName===null) return;
    const name = newName.trim();
    if(!name) return toast("Validation","Empty not allowed");
    try{
      await db.collection("subjects").doc(subjectId).update({
        name,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      toast("Done","Subject updated");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Update failed");
    }
  }
  window.editSubjectPrompt = editSubjectPrompt;

  // ===== CRUD: MODEL TESTS =====
  async function addModelTest(){
    const subjectId = $("mtSubjectSelect").value;
    if(!subjectId) return toast("Validation","Subject select করুন।");
    const title = ($("mtTitle").value||"").trim();
    if(!title) return toast("Validation","Title দিন।");
    const totalTimeMin = Number($("mtTime").value||0) || 0;
    const totalMarks = Number($("mtMarks").value||0) || 0;

    try{
      await db.collection("model_tests").add({
        subjectId, title, totalTimeMin, totalMarks,
        counts:{ mcq:0, written:0 },
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $("mtTitle").value=""; $("mtTime").value=""; $("mtMarks").value="";
      toast("Done","Model test added");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Add model test failed");
    }
  }
  window.addModelTest = addModelTest;

  async function editModelTestPrompt(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;

    const title = prompt("Title:", mt.title||"");
    if(title===null) return;
    const t = title.trim();
    if(!t) return toast("Validation","Title empty not allowed");

    const newTime = prompt("Total Time (min):", String(mt.totalTimeMin ?? 0));
    if(newTime===null) return;
    const newMarks = prompt("Total Marks:", String(mt.totalMarks ?? 0));
    if(newMarks===null) return;

    try{
      await db.collection("model_tests").doc(modelTestId).update({
        title: t,
        totalTimeMin: Number(newTime)||0,
        totalMarks: Number(newMarks)||0,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      toast("Done","Model test updated");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Update failed");
    }
  }
  window.editModelTestPrompt = editModelTestPrompt;

  // ===== IMPORT MODAL =====
  function openHelp(){ $("helpBack").classList.add("show"); }
  function closeHelp(e){ if(!e || e.target.id==="helpBack") $("helpBack").classList.remove("show"); }
  window.openHelp = openHelp;
  window.closeHelp = closeHelp;

  function closeImport(e){ if(!e || e.target.id==="importBack") $("importBack").classList.remove("show"); }
  window.closeImport = closeImport;

  function logImport(msg){ $("importLog").textContent = msg; }

  function openImportModal(target){
    importTarget = target;
    $("importTitle").textContent = `Import Questions → ${target.title}`;
    $("importFile").value = "";
    $("importType").value = "mcq";
    $("answerFormat").value = "auto";
    logImport("Ready.");
    $("importBack").classList.add("show");
  }

  function openSubjectImport(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;
    openImportModal({ mode:"subject", subjectId, title:`Subject: ${s.name}` });
  }
  function openModelTestImport(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;
    openImportModal({ mode:"modeltest", modelTestId, subjectId: mt.subjectId, title:`Model Test: ${mt.title}` });
  }
  window.openSubjectImport = openSubjectImport;
  window.openModelTestImport = openModelTestImport;

  async function parseQuestionsFile(file){
    const ext = file.name.split(".").pop().toLowerCase();
    if(ext==="csv"){
      const text = await file.text();
      return new Promise((resolve,reject)=>{
        Papa.parse(text,{ header:true, skipEmptyLines:true, complete:(res)=>resolve(res.data||[]), error:reject });
      });
    }
    if(ext==="xlsx"||ext==="xls"){
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf);
      const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws);
    }
    throw new Error("Only CSV/XLSX supported");
  }

  function toStr(v){ return (v===undefined||v===null) ? "" : String(v); }

  function resolveCorrectIndex(ansRaw, options, ansMode){
    const a = (ansRaw||"").trim();
    if(!a) return -1;

    const upper = a.toUpperCase();
    const letterIndex = ["A","B","C","D"].indexOf(upper);
    const n = Number(a);

    if(ansMode === "letter") return letterIndex;
    if(ansMode === "number"){
      if(Number.isFinite(n) && n>=1 && n<=4) return n-1;
      return -1;
    }
    if(ansMode === "text"){
      return options.findIndex(o => (o||"").trim().toLowerCase() === a.toLowerCase());
    }

    // auto:
    if(letterIndex !== -1) return letterIndex;
    if(Number.isFinite(n) && n>=1 && n<=4) return n-1;
    return options.findIndex(o => (o||"").trim().toLowerCase() === a.toLowerCase());
  }

  function normalizeMCQ(row, ansMode){
    const question = toStr(row.question).trim();
    const options = [
      toStr(row.option1).trim(),
      toStr(row.option2).trim(),
      toStr(row.option3).trim(),
      toStr(row.option4).trim()
    ];
    const note = toStr(row["note"]).trim();
    const ansRaw = toStr(row["right ans"]).trim();
    const correctIndex = resolveCorrectIndex(ansRaw, options, ansMode);
    return { question, options, correctIndex, note };
  }

  function normalizeWritten(row){
    return {
      question: toStr(row.question).trim(),
      rightAns: toStr(row["right ans"]).trim(),
      note: toStr(row["note"]).trim()
    };
  }

  async function doImport(){
    if(!importTarget) return;
    const type = $("importType").value; // mcq/written
    const ansMode = $("answerFormat").value;
    const file = $("importFile").files?.[0];
    if(!file) return logImport("Please select a CSV/XLSX file.");

    try{
      logImport("Parsing: " + file.name);
      const rows = await parseQuestionsFile(file);

      let items = [];
      if(type==="mcq"){
        items = rows.map(r=>normalizeMCQ(r, ansMode))
          .filter(q => q.question && q.options.every(Boolean) && q.correctIndex>=0 && q.correctIndex<=3);
      }else{
        items = rows.map(r=>normalizeWritten(r)).filter(q => q.question);
      }
      if(!items.length) return logImport("No valid rows found. Check headers/values.");

      logImport(`Valid rows: ${items.length}. Uploading...`);

      if(importTarget.mode==="subject"){
        const n = await importToSubject(importTarget.subjectId, type, items);
        logImport(`✅ Imported ${n} to Subject`);
        toast("Import done", `${n} questions added`);
      }else{
        const n = await importToModelTest(importTarget.modelTestId, importTarget.subjectId, type, items);
        logImport(`✅ Imported ${n} to Model Test`);
        toast("Import done", `${n} questions added`);
      }
    }catch(err){
      console.error(err);
      logImport("❌ Error: " + (err?.message || String(err)));
      toast("Import error", err?.message || "Failed");
    }
  }
  window.doImport = doImport;

  async function importToSubject(subjectId, type, items){
    const batch = db.batch();
    const qcol = db.collection("subject_questions");

    items.forEach(q=>{
      const ref = qcol.doc();
      if(type==="mcq"){
        batch.set(ref, {
          subjectId, type,
          question: q.question,
          options: q.options,
          correctIndex: q.correctIndex,
          note: q.note,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }else{
        batch.set(ref, {
          subjectId, type,
          question: q.question,
          rightAns: q.rightAns,
          note: q.note,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });

    const sref = db.collection("subjects").doc(subjectId);
    const ssnap = await sref.get();
    const sdata = ssnap.data() || {};
    const counts = sdata.counts || { mcq:0, written:0 };
    const newCounts = { ...counts, [type]: (counts[type]||0) + items.length };

    batch.update(sref, {
      counts: newCounts,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await batch.commit();
    return items.length;
  }

  async function importToModelTest(modelTestId, subjectId, type, items){
    const batch = db.batch();
    const qcol = db.collection("model_test_questions");

    items.forEach(q=>{
      const ref = qcol.doc();
      if(type==="mcq"){
        batch.set(ref, {
          modelTestId, subjectId, type,
          question: q.question,
          options: q.options,
          correctIndex: q.correctIndex,
          note: q.note,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }else{
        batch.set(ref, {
          modelTestId, subjectId, type,
          question: q.question,
          rightAns: q.rightAns,
          note: q.note,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });

    const mtRef = db.collection("model_tests").doc(modelTestId);
    const mtSnap = await mtRef.get();
    const mtData = mtSnap.data() || {};
    const counts = mtData.counts || { mcq:0, written:0 };
    const newCounts = { ...counts, [type]: (counts[type]||0) + items.length };

    batch.update(mtRef, {
      counts: newCounts,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await batch.commit();
    return items.length;
  }

  // ===== CASCADE DELETE =====
  async function deleteByQueryInBatches(colName, field, value){
    while(true){
      const snap = await db.collection(colName).where(field,"==",value).limit(450).get();
      if(snap.empty) break;
      const batch = db.batch();
      snap.docs.forEach(d=>batch.delete(d.ref));
      await batch.commit();
    }
  }

  async function deleteModelTestCascade(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;
    const ok = confirm(`Delete model test "${mt.title}"?\nসব প্রশ্নও ডিলিট হবে।`);
    if(!ok) return;

    try{
      await deleteByQueryInBatches("model_test_questions","modelTestId",modelTestId);
      await db.collection("model_tests").doc(modelTestId).delete();
      toast("Done","Model test deleted (cascade)");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Cascade delete failed");
    }
  }
  window.deleteModelTestCascade = deleteModelTestCascade;

  async function deleteSubjectCascade(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;

    const ok = confirm(`Delete subject "${s.name}"?\n\nএটা করলে:\n- subject_questions\n- এই subject এর model_tests\n- সেই model_tests এর model_test_questions\nসব ডিলিট হবে।`);
    if(!ok) return;

    try{
      await deleteByQueryInBatches("subject_questions","subjectId",subjectId);

      const mtSnap = await db.collection("model_tests").where("subjectId","==",subjectId).get();
      const mtIds = mtSnap.docs.map(d=>d.id);

      for(const mtId of mtIds){
        await deleteByQueryInBatches("model_test_questions","modelTestId",mtId);
        await db.collection("model_tests").doc(mtId).delete();
      }

      await db.collection("subjects").doc(subjectId).delete();
      toast("Done","Subject deleted (cascade)");
    }catch(err){
      console.error(err);
      toast("Error", err?.message || "Cascade delete failed");
    }
  }
  window.deleteSubjectCascade = deleteSubjectCascade;

  // ===== HELPERS =====
  function openHelp(){ $("helpBack").classList.add("show"); }
  function closeHelp(e){ if(!e || e.target.id==="helpBack") $("helpBack").classList.remove("show"); }
  window.openHelp = openHelp;
  window.closeHelp = closeHelp;

  // expose import close
  window.closeImport = closeImport;

  // ===== Enable buttons when authorized =====
  function enableAdminButtons(){
    $("btnRefresh").disabled = false;
    $("btnAddSubject").disabled = false;
    $("btnAddModelTest").disabled = false;
    $("btnDoImport").disabled = false;
  }

  // when authorized ui state changes
  // (called inside auth handler via setAuthorizedUI)
  const _origSetAuthorizedUI = setAuthorizedUI;
  setAuthorizedUI = function(isAuthorized, email){
    _origSetAuthorizedUI(isAuthorized, email);
    if(isAuthorized) enableAdminButtons();
  }

  // initial
  showGate("Checking login...");
</script>
</body>
</html>
