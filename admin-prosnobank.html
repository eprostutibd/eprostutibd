<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>প্রশ্নব্যাংক অ্যাডমিন পেজ</title>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#9aa7c2; --text:#e9eefb;
      --line:rgba(255,255,255,.10); --accent:#6aa6ff; --danger:#ff6a6a;
      --ok:#5ce3a4; --warn:#ffd36a; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(106,166,255,.18), transparent 50%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(92,227,164,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{position:sticky; top:0; z-index:10; backdrop-filter: blur(10px); background: rgba(11,18,32,.75); border-bottom:1px solid var(--line);}
    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{width:42px;height:42px;border-radius:12px;background: linear-gradient(135deg, rgba(106,166,255,.9), rgba(92,227,164,.85)); box-shadow: var(--shadow);}
    h1{font-size:18px; margin:0}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}
    .pill{font-size:12px; color:var(--muted); border:1px solid var(--line); padding:8px 10px; border-radius:999px; display:flex; gap:8px; align-items:center;}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    main .wrap{padding-top:16px}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{background: rgba(18,26,43,.85); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow);}
    .card .hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .card .bd{padding:14px}
    .tabs{display:flex; flex-direction:column; gap:8px; padding:12px;}
    .tabbtn{width:100%; background: transparent; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius: 12px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; transition:.15s;}
    .tabbtn:hover{border-color: rgba(255,255,255,.22)}
    .tabbtn.active{border-color: rgba(106,166,255,.55); background: rgba(106,166,255,.10);}
    .small{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px;}
    input, select{width:100%; background: rgba(255,255,255,.04); border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius: 12px; outline:none;}
    input:focus, select:focus{border-color: rgba(106,166,255,.55)}
    .btn{appearance:none; border:1px solid var(--line); background: rgba(255,255,255,.05); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; transition:.15s; font-weight:600;}
    .btn:hover{border-color: rgba(255,255,255,.22)}
    .btn.primary{border-color: rgba(106,166,255,.55); background: rgba(106,166,255,.14);}
    .btn.danger{border-color: rgba(255,106,106,.55); background: rgba(255,106,106,.12);}
    .btn.ok{border-color: rgba(92,227,164,.55); background: rgba(92,227,164,.12);}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{border:1px solid var(--line); border-radius: 14px; padding:12px; background: rgba(255,255,255,.03); display:flex; gap:10px; align-items:flex-start; justify-content:space-between;}
    .item .meta{min-width:0}
    .title{font-weight:800; margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 520px;}
    .meta2{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted);}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .divider{height:1px; background: var(--line); margin:12px 0}
    .hidden{display:none !important}
    .note{font-size:12px; color:var(--muted); line-height:1.5;}
    .toast{position: fixed; right: 16px; bottom: 16px; background: rgba(18,26,43,.95); border: 1px solid var(--line); border-radius: 14px; box-shadow: var(--shadow); padding: 12px 12px; max-width: 420px; display:none;}
    .toast.show{display:block}
    .toast b{display:block; margin-bottom:4px}
    .toast .tmuted{color:var(--muted); font-size:12px}

    .modalback{position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding: 16px; z-index: 50;}
    .modalback.show{display:flex}
    .modal{width:min(900px, 100%); background: rgba(18,26,43,.98); border: 1px solid var(--line); border-radius: 16px; box-shadow: var(--shadow); overflow:hidden;}
    .modal .mhd{padding: 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .modal .mbd{padding: 14px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; color: var(--muted); border:1px dashed var(--line); padding:10px 12px; border-radius:12px; background: rgba(255,255,255,.03); overflow:auto; white-space: pre-wrap;}

    #authGate{position: fixed; inset: 0; z-index: 100; background: rgba(11,18,32,.95); display:flex; align-items:center; justify-content:center; padding: 18px;}
    .authCard{width: min(560px, 100%); border:1px solid var(--line); border-radius: 18px; background: rgba(18,26,43,.92); box-shadow: var(--shadow); padding: 16px;}
    .authCard h2{margin: 6px 0 4px; font-size: 18px;}
    .authRow{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    .authRow > *{flex:1}
  </style>
</head>

<body>

<!-- AUTH GATE -->
<div id="authGate">
  <div class="authCard">
    <div style="display:flex; gap:12px; align-items:center;">
      <div class="logo"></div>
      <div>
        <h2>Admin Access Required</h2>
        <div class="note">
          শুধু <b>eprostutibd@gmail.com</b> দিয়ে লগইন করলে admin পেজ ব্যবহার করা যাবে।
        </div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="note" id="authStatus">Checking login...</div>
    <div class="authRow">
      <button class="btn primary" id="btnLogin">Login with Google</button>
      <button class="btn" id="btnLogout" disabled>Logout</button>
    </div>
    <div class="divider"></div>
    <div class="note">
      ⚠️ Firestore Rules অবশ্যই admin-email-only write হতে হবে, না হলে সিকিউরিটি হবে না।
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>প্রশ্নব্যাংক অ্যাডমিন পেজ</h1>
          <div class="subtitle">Subjects + Model Tests + Import + Cascade Delete</div>
        </div>
      </div>
      <div class="pill">
        <span id="connDot" class="dot"></span>
        <span id="connText">Login required</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <b>মেনু</b>
          <span class="small" id="whoami">Admin</span>
        </div>
        <div class="tabs">
          <button id="tabSubjects" class="tabbtn active" onclick="showTab('subjects')">
            <span>Subjects</span><span class="small">Manage</span>
          </button>
          <button id="tabModelTests" class="tabbtn" onclick="showTab('modeltests')">
            <span>Model Tests</span><span class="small">Manage</span>
          </button>
          <div class="divider"></div>
          <div class="note">✅ Non-admin Gmail হলে auto signout + block হবে।</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <b id="pageTitle">Subjects</b>
          <div class="row" style="flex:0 0 auto; align-items:center; gap:8px;">
            <button class="btn" onclick="openHelp()">CSV/XLSX Format</button>
            <button class="btn" id="btnRefresh" onclick="manualRefresh()" disabled>Refresh</button>
          </div>
        </div>

        <div class="bd">
          <!-- SUBJECTS -->
          <section id="subjectsSection">
            <div class="row">
              <div class="field">
                <label>নতুন Subject নাম</label>
                <input id="subjectName" placeholder="যেমন: Physics / গণিত / বাংলা" />
              </div>
              <div class="field" style="flex:0 0 180px">
                <label>&nbsp;</label>
                <button class="btn primary" id="btnAddSubject" style="width:100%" onclick="addSubject()" disabled>Add Subject</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="field">
                <label>Search Subject</label>
                <input id="subjectSearch" placeholder="টাইপ করে খুঁজুন..." oninput="renderSubjects()" />
              </div>
            </div>

            <div class="divider"></div>

            <div id="subjectsList" class="list"></div>
            <div id="subjectsEmpty" class="note hidden">এখনও কোনো Subject নেই।</div>
          </section>

          <!-- MODEL TESTS -->
          <section id="modelTestsSection" class="hidden">
            <div class="row">
              <div class="field">
                <label>Subject Select</label>
                <select id="mtSubjectSelect" onchange="onMtSubjectChange()"></select>
              </div>
              <div class="field">
                <label>Model Test Title</label>
                <input id="mtTitle" placeholder="যেমন: Model Test 1" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>Total Time (minutes)</label>
                <input id="mtTime" type="number" min="0" placeholder="যেমন: 60" />
              </div>
              <div class="field">
                <label>Total Marks</label>
                <input id="mtMarks" type="number" min="0" placeholder="যেমন: 100" />
              </div>
              <div class="field" style="flex:0 0 180px">
                <label>&nbsp;</label>
                <button class="btn primary" id="btnAddModelTest" style="width:100%" onclick="addModelTest()" disabled>Add Model Test</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="field">
                <label>Search Model Test</label>
                <input id="mtSearch" placeholder="টাইপ করে খুঁজুন..." oninput="renderModelTests()" />
              </div>
            </div>

            <div class="divider"></div>

            <div id="modelTestsList" class="list"></div>
            <div id="modelTestsEmpty" class="note hidden">এই Subject এ এখনও কোনো Model Test নেই।</div>
          </section>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- Import Modal -->
<div id="importBack" class="modalback" onclick="closeImport(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhd">
      <b id="importTitle">Import Questions</b>
      <button class="btn" onclick="closeImport()">Close</button>
    </div>
    <div class="mbd">
      <div class="row">
        <div class="field">
          <label>Question Type</label>
          <select id="importType">
            <option value="mcq">MCQ</option>
            <option value="written">Written</option>
          </select>
        </div>
        <div class="field">
          <label>CSV / Excel File</label>
          <input id="importFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Correct Format (MCQ only)</label>
          <select id="correctFormat">
            <option value="auto">Auto (A/B/C/D or 0/1/2/3)</option>
            <option value="letter">A/B/C/D only</option>
            <option value="index">0/1/2/3 only</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn ok" id="btnDoImport" style="width:100%" onclick="doImport()" disabled>Start Import</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="note">Import করলে Firestore এ প্রশ্ন add হবে এবং counts auto update হবে।</div>
      <div class="divider"></div>
      <div class="kbd" id="importLog">Ready.</div>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpBack" class="modalback" onclick="closeHelp(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhd">
      <b>CSV/XLSX Format</b>
      <button class="btn" onclick="closeHelp()">Close</button>
    </div>
    <div class="mbd">
      <div class="note">প্রথম row এ header থাকবে। Excel এও একই header রাখবে।</div>
      <div class="divider"></div>
      <b>MCQ columns</b>
      <div class="kbd">question, optionA, optionB, optionC, optionD, correct, explanation, marks</div>
      <div class="divider"></div>
      <b>Written columns</b>
      <div class="kbd">question, answer, marks</div>
      <div class="divider"></div>
      <div class="note"><b>correct</b> = A/B/C/D অথবা 0/1/2/3 (Auto mode দিলে দুটোই চলবে)।</div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <b id="toastTitle">Message</b>
  <div id="toastMsg" class="tmuted"></div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    getDocs, getDoc, query, where, orderBy, serverTimestamp, writeBatch, onSnapshot, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== Firebase config (your) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
    authDomain: "eprostutibd-webapp.firebaseapp.com",
    projectId: "eprostutibd-webapp",
    storageBucket: "eprostutibd-webapp.firebasestorage.app",
    messagingSenderId: "1044069942330",
    appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
    measurementId: "G-T2G55NMDQT"
  };
  const ADMIN_EMAIL = "eprostutibd@gmail.com";

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (e) {}
  const db = getFirestore(app);

  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });

  const $ = (id)=>document.getElementById(id);

  function toast(title, msg){
    $("toastTitle").textContent = title;
    $("toastMsg").textContent = msg;
    const t = $("toast");
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2800);
  }
  function setConn(ok, text){
    $("connDot").classList.toggle("ok", !!ok);
    $("connText").textContent = text;
  }

  // ===== Auth gate UI helpers =====
  function setAuthorizedUI(isAuthorized, userEmail){
    // enable/disable buttons so non-admin can't click anything even if UI shows
    $("btnRefresh").disabled = !isAuthorized;
    $("btnAddSubject").disabled = !isAuthorized;
    $("btnAddModelTest").disabled = !isAuthorized;
    $("btnDoImport").disabled = !isAuthorized;

    $("btnLogout").disabled = !isAuthorized;
    $("btnLogin").disabled = isAuthorized;

    $("whoami").textContent = isAuthorized ? ("Admin: " + (userEmail || "")) : "Admin (blocked)";
    setConn(isAuthorized, isAuthorized ? "Connected (admin)" : "Login required");
  }

  async function login(){
    try{
      $("authStatus").textContent = "Opening Google login...";
      const res = await signInWithPopup(auth, provider);

      // IMPORTANT: refresh token so Rules email-claim is reliable
      await res.user.getIdToken(true);

      const email = (res.user?.email || "").toLowerCase();
      if(email !== ADMIN_EMAIL.toLowerCase()){
        $("authStatus").textContent = "❌ Not authorized. Signing out...";
        await signOut(auth);
        toast("Not authorized", "শুধু eprostutibd@gmail.com admin access পাবে।");
      }
    }catch(err){
      console.error(err);
      $("authStatus").textContent = "Login failed: " + (err.message || err);
      toast("Login failed", err.message || "Error");
    }
  }
  async function logout(){
    await signOut(auth);
  }
  $("btnLogin").onclick = login;
  $("btnLogout").onclick = logout;

  function showGate(msg){
    $("authGate").style.display = "flex";
    $("authStatus").textContent = msg || "Please login with eprostutibd@gmail.com";
    setAuthorizedUI(false, "");
  }
  function hideGate(){
    $("authGate").style.display = "none";
  }

  // ===== Realtime snapshots =====
  let SUBJECTS = [];
  let MODEL_TESTS = [];
  let CURRENT_TAB = "subjects";
  let importTarget = null;

  let unsubSubjects = null;
  let unsubModelTests = null;

  function detachSubjectsSnapshot(){
    if(unsubSubjects){ unsubSubjects(); unsubSubjects = null; }
  }
  function detachModelTestsSnapshot(){
    if(unsubModelTests){ unsubModelTests(); unsubModelTests = null; }
  }

  function attachSubjectsSnapshot(){
    detachSubjectsSnapshot();
    const qSubjects = query(collection(db, "subjects"), orderBy("createdAt", "desc"));
    unsubSubjects = onSnapshot(qSubjects, (snap)=>{
      SUBJECTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      populateSubjectSelect();
      renderSubjects();
      if(CURRENT_TAB === "modeltests") attachModelTestsSnapshot();
    }, (err)=>{
      console.error(err);
      toast("Firestore error", err.message || "Subjects snapshot failed");
      setConn(false, "Rules/Auth error?");
    });
  }

  function attachModelTestsSnapshot(){
    detachModelTestsSnapshot();
    const subjectId = $("mtSubjectSelect").value;
    if(!subjectId){ MODEL_TESTS=[]; renderModelTests(); return; }
    const qMT = query(collection(db, "model_tests"), where("subjectId","==",subjectId), orderBy("createdAt","desc"));
    unsubModelTests = onSnapshot(qMT, (snap)=>{
      MODEL_TESTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderModelTests();
    }, (err)=>{
      console.error(err);
      toast("Firestore error", err.message || "Model tests snapshot failed");
    });
  }

  // ===== Tabs =====
  window.showTab = function(tab){
    CURRENT_TAB = tab;
    $("tabSubjects").classList.toggle("active", tab === "subjects");
    $("tabModelTests").classList.toggle("active", tab === "modeltests");
    $("subjectsSection").classList.toggle("hidden", tab !== "subjects");
    $("modelTestsSection").classList.toggle("hidden", tab !== "modeltests");
    $("pageTitle").textContent = tab === "subjects" ? "Subjects" : "Model Tests";

    if(tab === "modeltests") attachModelTestsSnapshot();
    else detachModelTestsSnapshot();
  }

  // ===== Modals =====
  window.openHelp = ()=>$("helpBack").classList.add("show");
  window.closeHelp = (e)=>{ if(!e || e.target.id==="helpBack") $("helpBack").classList.remove("show"); }

  function openImportModal(target){
    importTarget = target;
    $("importTitle").textContent = `Import Questions → ${target.title}`;
    $("importLog").textContent = "Ready.";
    $("importFile").value = "";
    $("importType").value = "mcq";
    $("correctFormat").value = "auto";
    $("importBack").classList.add("show");
  }
  window.closeImport = (e)=>{ if(!e || e.target.id==="importBack") $("importBack").classList.remove("show"); }

  // ===== Manual refresh =====
  window.manualRefresh = function(){
    // snapshots already keep it updated; this just re-renders and re-attaches safely
    populateSubjectSelect();
    renderSubjects();
    if(CURRENT_TAB === "modeltests") attachModelTestsSnapshot();
    toast("Refreshed", "UI updated");
  }

  // ===== Select =====
  function populateSubjectSelect(){
    const sel = $("mtSubjectSelect");
    const prev = sel.value;
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = SUBJECTS.length ? "Select subject..." : "No subjects yet";
    sel.appendChild(opt0);

    SUBJECTS.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(s=>{
      const o = document.createElement("option");
      o.value = s.id;
      o.textContent = s.name;
      sel.appendChild(o);
    });

    if(prev) sel.value = prev;
    if(!sel.value && SUBJECTS.length) sel.value = SUBJECTS[0].id;
  }
  window.onMtSubjectChange = function(){
    if(CURRENT_TAB === "modeltests") attachModelTestsSnapshot();
  }

  // ===== Render =====
  window.renderSubjects = function(){
    const q = ($("subjectSearch").value||"").trim().toLowerCase();
    const list = $("subjectsList");
    list.innerHTML = "";
    const filtered = SUBJECTS.filter(s=>(s.name||"").toLowerCase().includes(q));
    $("subjectsEmpty").classList.toggle("hidden", filtered.length !== 0);

    filtered.forEach(s=>{
      const counts = s.counts || { mcq:0, written:0 };
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="meta">
          <p class="title">${esc(s.name||"(no name)")}</p>
          <div class="meta2">
            <span class="chip">MCQ: <b>${counts.mcq||0}</b></span>
            <span class="chip">Written: <b>${counts.written||0}</b></span>
            <span class="chip">ID: ${s.id}</span>
          </div>
          <div class="note" style="margin-top:8px">
            Delete (Cascade) করলে: subject_questions + model_tests + model_test_questions সব ডিলিট হবে।
          </div>
        </div>
        <div class="actions">
          <button class="btn" onclick="editSubjectPrompt('${s.id}')">Edit</button>
          <button class="btn danger" onclick="deleteSubjectCascade('${s.id}')">Delete (Cascade)</button>
          <button class="btn ok" onclick="openSubjectImport('${s.id}')">Import Questions</button>
        </div>
      `;
      list.appendChild(el);
    });
  }

  window.renderModelTests = function(){
    const q = ($("mtSearch").value||"").trim().toLowerCase();
    const list = $("modelTestsList");
    list.innerHTML = "";
    const filtered = MODEL_TESTS.filter(m=>(m.title||"").toLowerCase().includes(q));
    $("modelTestsEmpty").classList.toggle("hidden", filtered.length !== 0);

    filtered.forEach(m=>{
      const counts = m.counts || { mcq:0, written:0 };
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="meta">
          <p class="title">${esc(m.title||"(no title)")}</p>
          <div class="meta2">
            <span class="chip">Time: <b>${m.totalTimeMin||0}</b> min</span>
            <span class="chip">Marks: <b>${m.totalMarks||0}</b></span>
            <span class="chip">MCQ: <b>${counts.mcq||0}</b></span>
            <span class="chip">Written: <b>${counts.written||0}</b></span>
            <span class="chip">ID: ${m.id}</span>
          </div>
        </div>
        <div class="actions">
          <button class="btn" onclick="editModelTestPrompt('${m.id}')">Edit</button>
          <button class="btn danger" onclick="deleteModelTestCascade('${m.id}')">Delete (Cascade)</button>
          <button class="btn ok" onclick="openModelTestImport('${m.id}')">Import Questions</button>
        </div>
      `;
      list.appendChild(el);
    });
  }

  // ===== CRUD =====
  window.addSubject = async function(){
    const name = ($("subjectName").value||"").trim();
    if(!name) return toast("Validation", "Subject নাম দিন।");
    try{
      await addDoc(collection(db,"subjects"), {
        name,
        counts:{ mcq:0, written:0 },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      $("subjectName").value = "";
      toast("Done", "Subject added");
    }catch(err){
      console.error(err);
      toast("Error", err.message || "Add subject failed (Rules?)");
    }
  }

  window.editSubjectPrompt = async function(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;
    const newName = prompt("Subject নাম:", s.name||"");
    if(newName===null) return;
    const name = newName.trim();
    if(!name) return toast("Validation","Empty not allowed");
    try{
      await updateDoc(doc(db,"subjects",subjectId), { name, updatedAt: serverTimestamp() });
      toast("Done","Subject updated");
    }catch(err){
      console.error(err);
      toast("Error", err.message||"Update failed");
    }
  }

  window.addModelTest = async function(){
    const subjectId = $("mtSubjectSelect").value;
    if(!subjectId) return toast("Validation","Subject select করুন।");
    const title = ($("mtTitle").value||"").trim();
    if(!title) return toast("Validation","Title দিন।");
    const totalTimeMin = Number($("mtTime").value||0) || 0;
    const totalMarks = Number($("mtMarks").value||0) || 0;

    try{
      await addDoc(collection(db,"model_tests"), {
        subjectId, title, totalTimeMin, totalMarks,
        counts:{ mcq:0, written:0 },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      $("mtTitle").value=""; $("mtTime").value=""; $("mtMarks").value="";
      toast("Done","Model test added");
    }catch(err){
      console.error(err);
      toast("Error", err.message||"Add model test failed");
    }
  }

  window.editModelTestPrompt = async function(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;

    const title = prompt("Title:", mt.title||"");
    if(title===null) return;
    const t = title.trim();
    if(!t) return toast("Validation","Title empty not allowed");

    const newTime = prompt("Total Time (min):", String(mt.totalTimeMin ?? 0));
    if(newTime===null) return;
    const newMarks = prompt("Total Marks:", String(mt.totalMarks ?? 0));
    if(newMarks===null) return;

    const totalTimeMin = Number(newTime) || 0;
    const totalMarks = Number(newMarks) || 0;

    try{
      await updateDoc(doc(db,"model_tests",modelTestId), { title:t, totalTimeMin, totalMarks, updatedAt: serverTimestamp() });
      toast("Done","Model test updated");
    }catch(err){
      console.error(err);
      toast("Error", err.message||"Update failed");
    }
  }

  // ===== Import open =====
  window.openSubjectImport = function(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;
    openImportModal({ mode:"subject", subjectId, title:`Subject: ${s.name}` });
  }
  window.openModelTestImport = function(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;
    openImportModal({ mode:"modeltest", modelTestId, subjectId: mt.subjectId, title:`Model Test: ${mt.title}` });
  }

  // ===== File parse + normalize =====
  async function parseQuestionsFile(file){
    const ext = file.name.split(".").pop().toLowerCase();
    if(ext==="csv"){
      const text = await file.text();
      return new Promise((resolve,reject)=>{
        Papa.parse(text,{ header:true, skipEmptyLines:true, complete:(res)=>resolve(res.data||[]), error:reject });
      });
    }
    if(ext==="xlsx"||ext==="xls"){
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf);
      const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws);
    }
    throw new Error("Only CSV/XLSX supported");
  }
  function toStr(v){ return (v===undefined||v===null) ? "" : String(v); }
  function numOr(v, fb){ const n = Number(v); return Number.isFinite(n)?n:fb; }

  function normalizeMCQ(row, correctMode){
    const question = toStr(row.question).trim();
    const options = [toStr(row.optionA),toStr(row.optionB),toStr(row.optionC),toStr(row.optionD)].map(s=>s.trim());
    const explanation = toStr(row.explanation).trim();
    const marks = numOr(row.marks, 1);
    const correctRaw = toStr(row.correct).trim();
    const letterIndex = ["A","B","C","D"].indexOf(correctRaw.toUpperCase());
    let correctIndex = -1;

    if(correctMode==="letter") correctIndex = letterIndex;
    else if(correctMode==="index"){
      const n = Number(correctRaw); correctIndex = Number.isFinite(n)?n:-1;
    } else {
      if(letterIndex!==-1) correctIndex = letterIndex;
      else { const n = Number(correctRaw); correctIndex = Number.isFinite(n)?n:-1; }
    }
    return { question, options, correctIndex, explanation, marks };
  }
  function normalizeWritten(row){
    return { question: toStr(row.question).trim(), answer: toStr(row.answer).trim(), marks: numOr(row.marks, 1) };
  }

  // ===== Import process =====
  window.doImport = async function(){
    if(!importTarget) return;
    const type = $("importType").value;
    const correctMode = $("correctFormat").value;
    const file = $("importFile").files?.[0];
    if(!file) return logImport("Please select a CSV/XLSX file.");

    try{
      logImport(`Parsing: ${file.name}`);
      const rows = await parseQuestionsFile(file);
      let items = [];

      if(type==="mcq"){
        items = rows.map(r=>normalizeMCQ(r, correctMode))
          .filter(q=>q.question && q.options.length===4 && q.options.every(Boolean) && q.correctIndex>=0 && q.correctIndex<=3);
      } else {
        items = rows.map(r=>normalizeWritten(r)).filter(q=>q.question);
      }
      if(!items.length) return logImport("No valid rows found. Check columns/values.");

      logImport(`Valid rows: ${items.length}. Uploading...`);

      if(importTarget.mode==="subject"){
        const n = await importToSubject(importTarget.subjectId, type, items);
        logImport(`✅ Imported ${n} to Subject`);
        toast("Import done", `${n} questions added`);
      } else {
        const n = await importToModelTest(importTarget.modelTestId, importTarget.subjectId, type, items);
        logImport(`✅ Imported ${n} to Model Test`);
        toast("Import done", `${n} questions added`);
      }
    }catch(err){
      console.error(err);
      logImport(`❌ Error: ${err.message||err}`);
      toast("Import error", err.message||"Failed");
    }
  }
  function logImport(msg){ $("importLog").textContent = msg; }

  async function importToSubject(subjectId, type, items){
    const batch = writeBatch(db);
    let addCount = 0;
    const qcol = collection(db,"subject_questions");

    for(const q of items){
      const ref = doc(qcol);
      batch.set(ref, { subjectId, type, ...q, createdAt: serverTimestamp() });
      addCount++;
    }

    const sref = doc(db,"subjects",subjectId);
    const ssnap = await getDoc(sref);
    const sdata = ssnap.data() || {};
    const counts = sdata.counts || { mcq:0, written:0 };
    const newCounts = { ...counts, [type]: (counts[type]||0) + addCount };

    batch.update(sref, { counts: newCounts, updatedAt: serverTimestamp() });
    await batch.commit();
    return addCount;
  }

  async function importToModelTest(modelTestId, subjectId, type, items){
    const batch = writeBatch(db);
    let addCount = 0;
    const qcol = collection(db,"model_test_questions");

    for(const q of items){
      const ref = doc(qcol);
      batch.set(ref, { modelTestId, subjectId, type, ...q, createdAt: serverTimestamp() });
      addCount++;
    }

    const mtRef = doc(db,"model_tests",modelTestId);
    const mtSnap = await getDoc(mtRef);
    const mtData = mtSnap.data() || {};
    const counts = mtData.counts || { mcq:0, written:0 };
    const newCounts = { ...counts, [type]: (counts[type]||0) + addCount };

    batch.update(mtRef, { counts: newCounts, updatedAt: serverTimestamp() });
    await batch.commit();
    return addCount;
  }

  // ===== Cascade delete helpers =====
  async function deleteByQueryInBatches(colName, field, value){
    let total = 0;
    while(true){
      const qDel = query(collection(db, colName), where(field,"==",value), limit(450));
      const snap = await getDocs(qDel);
      if(snap.empty) break;

      const batch = writeBatch(db);
      snap.docs.forEach(d=>batch.delete(d.ref));
      await batch.commit();
      total += snap.size;
    }
    return total;
  }

  window.deleteModelTestCascade = async function(modelTestId){
    const mt = MODEL_TESTS.find(x=>x.id===modelTestId);
    if(!mt) return;
    const ok = confirm(`Delete model test "${mt.title}"?\n\nএটা করলে এই model test এর সব প্রশ্নও ডিলিট হবে।`);
    if(!ok) return;

    try{
      toast("Working...", "Deleting model_test_questions...");
      await deleteByQueryInBatches("model_test_questions","modelTestId",modelTestId);
      await deleteDoc(doc(db,"model_tests",modelTestId));
      toast("Done", "Model test deleted (cascade)");
    }catch(err){
      console.error(err);
      toast("Error", err.message||"Cascade delete failed");
    }
  }

  window.deleteSubjectCascade = async function(subjectId){
    const s = SUBJECTS.find(x=>x.id===subjectId);
    if(!s) return;

    const ok = confirm(`Delete subject "${s.name}"?\n\nএটা করলে:\n- subject_questions ডিলিট\n- এই subject এর সব model_tests ডিলিট\n- সেই model_tests এর সব model_test_questions ডিলিট\nসব হবে।`);
    if(!ok) return;

    try{
      toast("Working...", "Deleting subject_questions...");
      await deleteByQueryInBatches("subject_questions","subjectId",subjectId);

      toast("Working...", "Loading model tests...");
      const mtSnap = await getDocs(query(collection(db,"model_tests"), where("subjectId","==",subjectId)));
      const mtIds = mtSnap.docs.map(d=>d.id);

      for(const mtId of mtIds){
        toast("Working...", `Deleting model_test_questions for ${mtId}...`);
        await deleteByQueryInBatches("model_test_questions","modelTestId",mtId);
        await deleteDoc(doc(db,"model_tests",mtId));
      }

      await deleteDoc(doc(db,"subjects",subjectId));
      toast("Done", "Subject deleted (cascade)");
    }catch(err){
      console.error(err);
      toast("Error", err.message||"Cascade delete failed");
    }
  }

  function esc(str){
    return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ===== AUTH STATE (FIXED) =====
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      detachSubjectsSnapshot();
      detachModelTestsSnapshot();
      showGate("Please login with eprostutibd@gmail.com");
      return;
    }

    // Force refresh token so Rules sees correct email claim
    try{ await user.getIdToken(true); } catch(e){}

    const email = (user.email || "").toLowerCase();
    if(email !== ADMIN_EMAIL.toLowerCase()){
      // hard block non-admin
      detachSubjectsSnapshot();
      detachModelTestsSnapshot();
      $("authStatus").textContent = "❌ Not authorized. Signing out...";
      await signOut(auth);
      showGate("❌ Only eprostutibd@gmail.com is allowed.");
      toast("Not authorized", "Only admin email allowed");
      return;
    }

    // authorized
    hideGate();
    setAuthorizedUI(true, user.email);

    // attach snapshots
    attachSubjectsSnapshot();
    if(CURRENT_TAB === "modeltests") attachModelTestsSnapshot();
  });

  // initial
  showGate("Checking login...");
</script>
</body>
</html>
