<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start Model Test ‚Äî eProstutiBD</title>
  <meta name="theme-color" content="#1d4ed8" />

  <!-- ‚úÖ Optional: Bengali font for UI (PDF is image-based so it‚Äôs safe) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700;800;900;1000&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f6f8ff; --bg2:#eef6ff;
      --line: rgba(18, 28, 55, .10);
      --line2: rgba(18, 28, 55, .08);
      --text:#0f1730; --muted:#5a6685;

      --shadow: 0 16px 44px rgba(15,23,48,.12);
      --shadow2: 0 10px 26px rgba(15,23,48,.08);

      --brandA:#1d4ed8;
      --brandB:#0ea5e9;

      --ok:#16a34a;
      --danger:#dc2626;

      --safeBottom: env(safe-area-inset-bottom, 0px);
      --headerH: 64px;

      --footTop:#0b1f3f;
      --footBottom:#07152e;
      --footLine: rgba(255,255,255,.14);
      --footText: rgba(255,255,255,.86);
      --footMuted: rgba(255,255,255,.70);
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(800px 560px at 92% 14%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding-bottom:0;
    }
    a{color:inherit}

    .container{
      max-width: 1320px;
      margin: 0 auto;
      padding-left: clamp(12px, 4vw, 48px);
      padding-right: clamp(12px, 4vw, 48px);
      padding-top: 10px;
      padding-bottom: 14px;
    }

    /* ===== Header (same style as your template) ===== */
    header{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(135deg, rgba(29,78,216,.96), rgba(14,165,233,.92));
      border-bottom: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 34px rgba(29,78,216,.18);
    }
    .topbar{
      max-width: 1320px;
      margin:0 auto;
      padding-left: clamp(12px, 4vw, 48px);
      padding-right: clamp(12px, 4vw, 48px);
      padding-top: 10px;
      padding-bottom: 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{display:flex;flex-direction:column;gap:3px;flex:0 0 auto;min-width:0;}
    .brand .name{color:#fff;font-weight:1000;letter-spacing:.2px;font-size:15px;line-height:1;white-space:nowrap;}
    /* ‚úÖ Header tag will NOT show model test name (your requirement) */
    .brand .tag{color:rgba(255,255,255,.88);font-size:12px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 260px;}

    .nav{display:flex;gap:8px;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;flex:1;}
    .nav::-webkit-scrollbar{display:none}
    .nav a{
      flex:0 0 auto;text-decoration:none;color:#fff;font-size:12px;font-weight:1000;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);white-space:nowrap;transition:.15s;
    }
    .nav a:hover{background: rgba(255,255,255,.16)}
    .nav a.active{background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.26)}

    .menuBtn{
      flex:0 0 auto;margin-left:auto;display:none;
      border:1px solid rgba(255,255,255,.22);background: rgba(255,255,255,.14);color:#fff;
      border-radius: 12px;padding: 8px 10px;font-weight:1000;font-size:12px;cursor:pointer;line-height:1;
    }
    @media (max-width: 860px){
      .nav{display:none;}
      .menuBtn{display:inline-flex;align-items:center;gap:8px;}
      .brand .tag{max-width: 55vw;}
    }

    .mobileMenu{display:none;position:fixed;inset:0;z-index:9999;}
    .mobileMenu .overlay{position:absolute;inset:0;background:transparent;}
    .mobileMenu .drawer{
      position:absolute;top:64px;right:12px;width:min(320px, calc(100vw - 24px));
      border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,.28);
      background: rgba(8, 20, 55, .78);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 38px rgba(0,0,0,.35);
    }
    .mobileMenu a{
      display:block;text-decoration:none;color:#fff;font-weight:1000;font-size:13px;
      padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);margin-bottom:8px;
      white-space:nowrap;
    }
    .mobileMenu a.active{border-color: rgba(255,255,255,.28);background: rgba(255,255,255,.12);}

    /* ===== Notice bar ===== */
    .noticeBar{
      margin-top:10px;border:1px solid var(--line);background: rgba(255,255,255,.72);
      border-radius:16px;overflow:hidden;box-shadow: var(--shadow2);
    }
    .noticeRow{display:flex;align-items:center;gap:10px;padding:10px 12px;}
    .noticeTag{
      font-size:12px;font-weight:1000;padding:6px 10px;border-radius:999px;
      background: rgba(29,78,216,.10);border: 1px solid rgba(29,78,216,.18);
      color: var(--text);white-space:nowrap;
    }
    .marq{flex:1;overflow:hidden;white-space:nowrap;color: var(--muted);font-size:12px;}
    .marq span{display:inline-block;padding-left:100%;animation: ticker 18s linear infinite;}
    @keyframes ticker{0%{transform: translateX(0)}100%{transform: translateX(-100%)}}

    /* ===== Layout (Side Ads + Main) ===== */
    .grid{
      display:grid;
      grid-template-columns: 280px minmax(0, 1fr) 280px;
      gap: 12px;
      align-items:start;
      margin-top: 12px;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr;}
      .sideAd{display:none;}
    }

    /* ‚úÖ plain look: no card/panel for main */
    .mainArea{min-width:0;}

    /* ===== Meta header (centered info) ===== */
    .metaCenter{
      margin-top: 12px;
      text-align:center;
    }
    .metaTitle{
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.25;
      margin: 0 0 8px;
    }
    .metaRow{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted);
      font-size:12px;
      font-weight: 900;
    }
    .chip{
      border:1px solid rgba(18,28,55,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 6px 10px;
      white-space:nowrap;
    }
    .metaActions{
      margin-top: 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.86);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 10px 22px rgba(15,23,48,.05);
      transition:.15s;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .btn.primary{border-color: rgba(29,78,216,.22);background: rgba(29,78,216,.10); color: rgba(29,78,216,1);}
    .btn.danger{border-color: rgba(220,38,38,.28);background: rgba(220,38,38,.10); color: var(--danger);}

    /* ===== Paper feel (plain text) ===== */
    .paper{
      margin-top: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.96)),
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 25px,
          rgba(18,28,55,.055) 26px
        );
      border: 1px solid rgba(18,28,55,.10);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(15,23,48,.10);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(900px 260px at 20% 0%, rgba(29,78,216,.05), transparent 60%),
                  radial-gradient(900px 260px at 80% 0%, rgba(14,165,233,.04), transparent 60%);
      pointer-events:none;
    }

    /* ‚úÖ Questions list: 2 columns on desktop */
    .qList{
      position: relative;
      z-index: 1;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    @media (min-width: 981px){
      .qList{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        column-gap: 0;
        row-gap: 0;
      }
      .qRow:nth-child(2n){
        border-left: 1px solid var(--line2);
      }
      .qRow:nth-child(n+3){
        border-top: 1px solid var(--line2);
      }
    }
    @media (max-width: 980px){
      .qRow + .qRow{ border-top: 1px solid var(--line2); }
    }

    .qRow{
      padding: 12px 12px;
      background: transparent;
    }
    .qHead{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:flex-start;
    }
    .qNo{
      flex:0 0 auto;
      font-size:11px;
      font-weight:1000;
      padding: 5px 8px;
      border-radius:999px;
      border: 1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.70);
      color: var(--muted);
      white-space:nowrap;
    }
    .qText{
      margin:0;
      font-weight:800;
      font-size:12.8px;
      line-height:1.55;
      flex:1;
      letter-spacing:.1px;
    }
    .noteInline{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }
    .noteInline b{color: var(--text);}

    /* ===== Options (NO box) + tick mark on select ===== */
    .opts{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }
    @media (max-width: 560px){
      .opts{grid-template-columns: 1fr 1fr;}
    }

    .optLine{
      display:grid;
      grid-template-columns: 18px 22px 1fr;
      column-gap: 6px;
      align-items:start;
      cursor:pointer;
      user-select:none;
      padding: 2px 0;
    }
    .optLine.locked{cursor:default;}
    .tick{
      width: 18px; height: 18px;
      display:grid; place-items:center;
      font-weight:1000;
      font-size:13px;
      color: transparent;
      transform: translateY(1px);
    }
    .optKey{font-weight:1000;font-size:12px;color: var(--muted);line-height:1.5;}
    .optTxt{font-size:12.6px;line-height:1.5;color: var(--text);}

    /* ‚úÖ selected => green + bold + tick */
    .optLine.selected .tick{color: var(--ok);}
    .optLine.selected .optTxt{color: var(--ok); font-weight: 1000;}
    .optLine.selected .optKey{color: var(--ok);}

    /* Written */
    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      border: 1px solid rgba(18,28,55,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      background: rgba(255,255,255,.78);
      font-family: inherit;
      font-size: 13px;
      line-height: 1.6;
      box-shadow: 0 10px 22px rgba(15,23,48,.05);
    }

    /* ===== Inline Ads inside paper ===== */
    .inlineAd{
      border: 1px dashed rgba(18,28,55,.22);
      background: rgba(255,255,255,.78);
      border-radius: 16px;
      padding: 12px;
      min-height: 86px;
      display:grid;
      place-items:center;
      text-align:center;
      color: var(--muted);
      box-shadow: 0 10px 22px rgba(15,23,48,.04);
      margin: 12px 0;
    }
    .inlineAd .tag{
      display:inline-block;font-weight:1000;color: var(--text);
      padding: 6px 10px;border-radius:999px;border:1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.86);margin-bottom: 6px;font-size:12px;
    }

    /* ===== Side Ads slots ===== */
    .adBox{
      border:1px dashed rgba(18,28,55,.22);
      border-radius:16px;
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position: sticky;
      top: calc(var(--headerH, 64px) + 12px);
    }
    .adHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(18,28,55,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:12px;color: var(--muted);
    }
    .adHead b{color: var(--text)}
    .adBody{
      min-height: 420px;
      display:grid;
      place-items:center;
      padding: 10px;
      text-align:center;
      color: var(--muted);
    }

    /* ===== Toast ===== */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 82px;
      z-index: 99999;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(18,28,55,.12);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 18px 44px rgba(15,23,48,.12);
      font-size: 12px;
      font-weight: 1000;
      color: var(--text);
      display:none;
      max-width: calc(100vw - 24px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .loading{color: var(--muted); font-size:12px; font-weight:900;}
    .err{color: var(--danger); font-size:12px; font-weight:1000;}

    /* ===== Footer (same style as your template) ===== */
    footer{
      margin-top: 14px;
      margin-bottom: 0 !important;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(900px 320px at 80% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--footTop), var(--footBottom));
      border-top: 1px solid var(--footLine);
      color: var(--footText);
    }
    .footGrid{
      max-width: 1320px;
      margin:0 auto;
      padding: 18px clamp(12px, 4vw, 48px) 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px 18px;
      align-items:start;
    }
    .footTitle{font-weight:1000;color:#fff;font-size:13px;margin-bottom: 8px;}
    .footText{color: var(--footMuted);font-size:12px;line-height:1.6;}
    .footLinks{display:flex;flex-direction:column;gap: 8px;}
    .footLinks a{text-decoration:none;color: var(--footMuted);font-size:12px;}
    .footLinks a:hover{color:#fff;text-decoration:underline;text-underline-offset:4px;}
    .socialCol{display:flex;flex-direction:column;gap: 10px;}
    .socialCol a{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color: var(--footMuted);font-size:12px;}
    .socialCol a:hover{color:#fff;}
    .socialCol svg{width:18px;height:18px;fill:#fff;opacity:.92}

    @media (max-width: 980px){
      .footGrid{
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px 10px;
      }
      .footBrandCol{display:none !important;}
    }
    .copy{
      max-width: 1320px;
      margin:0 auto;
      padding: 12px clamp(12px, 4vw, 48px) 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.68);
      font-size:12px;
      text-align:center;
      line-height:1.6;
      white-space:normal;
    }

    @media (prefers-reduced-motion: reduce){
      .marq span{ animation:none; padding-left:0; }
    }

    /* ===== Print/PDF hidden area ===== */
    .pdfArea{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 800px;
      background:#fff;
      color:#111;
      padding: 20px;
      font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .pdfTitle{font-size:18px;font-weight:1000;margin:0 0 10px;}
    .pdfMeta{font-size:12px;color:#333;margin:0 0 12px;display:flex;gap:10px;flex-wrap:wrap;}
    .pdfQ{
      font-size:12.5px;
      line-height:1.55;
      margin: 10px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .pdfQ b{font-weight:1000}
    .pdfOpt{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 10px;
      margin-top: 6px;
    }
    .pdfOpt div{font-size:12px;line-height:1.4;}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="name">eProstutiBD</div>
      <div class="tag" id="headerTag">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶π‡ßã‡¶ï ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá</div>
    </div>

    <nav class="nav" aria-label="Main navigation">
      <a href="#">‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡ßÄ</a>
      <a class="active" href="#">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</a>
      <a href="#">‡¶è‡¶°‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
      <a href="#">‡¶ú‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
      <a href="#">‡¶Æ‡¶°‡ßá‡¶≤ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü</a>
      <a href="#">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶´‡ßá‡ßü‡¶æ‡¶∞‡ßç‡¶∏</a>
      <a href="#">IELTS</a>
      <a href="#">BCS</a>
      <a href="#">‡¶®‡ßã‡¶ü‡¶ø‡¶∂</a>
      <a href="#">‡¶¨‡ßç‡¶≤‡¶ó</a>
      <a href="#">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡¶æ‡¶∞</a>
    </nav>

    <button class="menuBtn" id="menuBtn" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu" onclick="toggleMenu()">‚ò∞</button>
  </div>

  <div class="mobileMenu" id="mobileMenu">
    <div class="overlay" onclick="closeMenu()"></div>
    <div class="drawer" role="dialog" aria-label="Menu" onclick="event.stopPropagation()">
      <a href="#">‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡ßÄ</a>
      <a class="active" href="#">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</a>
      <a href="#">‡¶è‡¶°‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
      <a href="#">‡¶ú‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
      <a href="#">‡¶Æ‡¶°‡ßá‡¶≤ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü</a>
      <a href="#">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶´‡ßá‡ßü‡¶æ‡¶∞‡ßç‡¶∏</a>
      <a href="#">IELTS</a>
      <a href="#">BCS</a>
      <a href="#">‡¶®‡ßã‡¶ü‡¶ø‡¶∂</a>
      <a href="#">‡¶¨‡ßç‡¶≤‡¶ó</a>
      <a href="#">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡¶æ‡¶∞</a>
    </div>
  </div>
</header>

<div class="container">
  <div class="noticeBar" role="region" aria-label="Notice">
    <div class="noticeRow">
      <span class="noticeTag">Model Test</span>
      <div class="marq">
        <span id="tickerText">Test ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚Ä¢ ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ñ‡ßá‡ßü‡¶æ‡¶≤ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® ‚Ä¢ Submit ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶®‡¶ø‡¶®</span>
      </div>
    </div>
  </div>

  <main class="grid">
    <!-- LEFT AD -->
    <aside class="sideAd">
      <div class="adBox">
        <div class="adHead"><b>Ad Slot</b><span>Left Sidebar</span></div>
        <div class="adBody" id="ad_left">
          Paste AdSense / Ad code here
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <section class="mainArea">
      <div class="metaCenter">
        <h1 class="metaTitle" id="mtName">Loading‚Ä¶</h1>
        <div class="metaRow">
          <span class="chip">‚è± Time: <b id="mtTime">--</b> min</span>
          <span class="chip">üßÆ Mark: <b id="mtMark">--</b></span>
          <span class="chip">üìå Total Q: <b id="mtTotalQ">0</b></span>
          <span class="chip">‚è≥ Left: <b id="timeLeft">--:--</b></span>
        </div>

        <div class="metaActions">
          <button class="btn" id="btnPDF" onclick="downloadPDF()">‚¨áÔ∏è PDF Download</button>
          <button class="btn danger" id="btnReset" onclick="resetAnswers()">Reset Answers</button>
        </div>
      </div>

      <div class="paper" id="paper">
        <div id="content">
          <div class="loading">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>
        </div>

        <!-- ‚úÖ Submit button must be under all questions -->
        <div style="margin-top:14px; display:flex; justify-content:center;">
          <button class="btn primary" id="btnSubmit" onclick="submitTest()">Submit</button>
        </div>
      </div>
    </section>

    <!-- RIGHT AD -->
    <aside class="sideAd">
      <div class="adBox">
        <div class="adHead"><b>Ad Slot</b><span>Right Sidebar</span></div>
        <div class="adBody" id="ad_right">
          Paste AdSense / Ad code here
        </div>
      </div>
    </aside>
  </main>
</div>

<div class="toast" id="toast"></div>

<!-- Hidden PDF render area -->
<div class="pdfArea" id="pdfArea" aria-hidden="true"></div>

<footer>
  <div class="footGrid">
    <div class="footBrandCol">
      <div class="footTitle">eProstutiBD</div>
      <div class="footText">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶π‡ßã‡¶ï ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá</div>
    </div>

    <div>
      <div class="footTitle">‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶™‡ßá‡¶ú</div>
      <div class="footLinks">
        <a href="#">About</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms</a>
        <a href="#">Contact</a>
      </div>
    </div>

    <div>
      <div class="footTitle">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</div>
      <div class="footLinks">
        <a href="#">Notice</a>
        <a href="#">Blog</a>
        <a href="#">Career</a>
        <a href="#">Help</a>
      </div>
    </div>

    <div>
      <div class="footTitle">Social</div>
      <div class="socialCol" aria-label="Social icons">
        <a href="#" aria-label="Facebook">
          <svg viewBox="0 0 24 24"><path d="M14 9h3V6h-3c-2.76 0-5 2.24-5 5v3H6v3h3v6h3v-6h3l1-3h-4v-3c0-.55.45-1 1-1Z"/></svg>
          Facebook
        </a>
        <a href="#" aria-label="YouTube">
          <svg viewBox="0 0 24 24"><path d="M21.6 7.2a3 3 0 0 0-2.1-2.1C17.8 4.6 12 4.6 12 4.6s-5.8 0-7.5.5A3 3 0 0 0 2.4 7.2 31 31 0 0 0 2 12a31 31 0 0 0 .4 4.8 3 3 0 0 0 2.1 2.1c1.7.5 7.5.5 7.5.5s5.8 0 7.5-.5a3 3 0 0 0 2.1-2.1A31 31 0 0 0 22 12a31 31 0 0 0-.4-4.8ZM10 15.5v-7l6 3.5-6 3.5Z"/></svg>
          YouTube
        </a>
        <a href="#" aria-label="Telegram">
          <svg viewBox="0 0 24 24"><path d="M21.9 5.6 19 19.2c-.2 1-.8 1.2-1.6.8l-4.4-3.2-2.1 2c-.2.2-.4.4-.8.4l.3-4.7 8.6-7.8c.4-.3-.1-.5-.6-.2l-10.6 6.7-4.6-1.4c-1-.3-1 .2-1.5 0L20 4.6c.9-.4 1.7.2 1.9 1Z"/></svg>
          Telegram
        </a>
        <a href="#" aria-label="Instagram">
          <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm-5 3.5A4.5 4.5 0 1 1 7.5 12 4.5 4.5 0 0 1 12 7.5Zm0 2A2.5 2.5 0 1 0 14.5 12 2.5 2.5 0 0 0 12 9.5ZM17.8 6.9a1 1 0 1 1-1 1 1 1 0 0 1 1-1Z"/></svg>
          Instagram
        </a>
      </div>
    </div>
  </div>

  <div class="copy">
    ¬© <span id="year"></span> eProstutiBD ‚Äî All rights reserved
  </div>
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<!-- ‚úÖ PDF libs (image-based => Bengali safe) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // ===== footer year =====
  document.getElementById("year").textContent = new Date().getFullYear();

  // ===== menu =====
  const $ = (id)=>document.getElementById(id);
  function openMenu(){ $("mobileMenu").style.display="block"; $("menuBtn").setAttribute("aria-expanded","true"); }
  function closeMenu(){ $("mobileMenu").style.display="none"; $("menuBtn").setAttribute("aria-expanded","false"); }
  function toggleMenu(){ const m=$("mobileMenu"); (m.style.display==="block")?closeMenu():openMenu(); }
  window.openMenu=openMenu; window.closeMenu=closeMenu; window.toggleMenu=toggleMenu;
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>{ t.style.display = "none"; }, 1700);
  }

  function esc(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
    authDomain: "eprostutibd-webapp.firebaseapp.com",
    projectId: "eprostutibd-webapp",
    storageBucket: "eprostutibd-webapp.firebasestorage.app",
    messagingSenderId: "1044069942330",
    appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
    measurementId: "G-T2G55NMDQT"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== Collections =====
  const COL_SUBJECT_MODEL_TESTS = "subject_model_tests";
  const QUESTION_COLLECTION_CANDIDATES = [
    "modeltest_questions",
    "model_test_questions",
    "modeltest_question",
    "modelTest_questions",
    "modeltestQuestions"
  ];

  // ===== Query params =====
  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name) || "";
  }
  const modelTestId = getParam("modelTestId");

  // ===== helpers =====
  function normalize(s){
    return String(s||"").toLowerCase()
      .replace(/[^\p{L}\p{N}\s]+/gu, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function getTitleField(data){
    return data?.title ?? data?.name ?? data?.modelTestName ?? "Model Test";
  }
  function getTimeMinFromDoc(data){
    const keys = ["totalTimeMin","totalTime","total_time","duration","time","minutes","min"];
    for(const k of keys){
      const v = data?.[k];
      if(v === undefined || v === null || v === "") continue;
      const n = Number(v);
      if(!Number.isNaN(n) && n > 0) return n;
    }
    return 0;
  }
  function getMarkFromDoc(data){
    const keys = ["totalMarks","totalMark","total_mark","mark","marks"];
    for(const k of keys){
      const v = data?.[k];
      if(v === undefined || v === null || v === "") continue;
      return v;
    }
    return "-";
  }
  function pickQuestionText(q){
    return (
      q.question ??
      q.questionText ??
      q.q ??
      q.title ??
      q.name ??
      q.ques ??
      q.qus ??
      q.question_title ??
      ""
    ).toString();
  }
  function getOptions(q){
    if(Array.isArray(q.options) && q.options.length) return q.options.slice(0,4).map(x=>String(x ?? ""));
    if(Array.isArray(q.choices) && q.choices.length) return q.choices.slice(0,4).map(x=>String(x ?? ""));
    if(Array.isArray(q.opts) && q.opts.length) return q.opts.slice(0,4).map(x=>String(x ?? ""));

    const o1 = q.option1 ?? q.opt1 ?? q.a ?? q.A ?? q.optionA ?? q.optA ?? q.choiceA;
    const o2 = q.option2 ?? q.opt2 ?? q.b ?? q.B ?? q.optionB ?? q.optB ?? q.choiceB;
    const o3 = q.option3 ?? q.opt3 ?? q.c ?? q.C ?? q.optionC ?? q.optC ?? q.choiceC;
    const o4 = q.option4 ?? q.opt4 ?? q.d ?? q.D ?? q.optionD ?? q.optD ?? q.choiceD;
    return [o1,o2,o3,o4].map(x=>String(x ?? ""));
  }
  function isWrittenQuestion(q){
    const t = (q.type ?? q.qType ?? q.questionType ?? q.kind ?? "").toString().toLowerCase();
    return t === "written" || t === "cq" || t === "short" || t === "essay";
  }

  // ===== state =====
  let mtDoc = null;
  let questions = [];

  // answers
  const mcqAns = new Map();     // qid -> optionIndex
  const writtenAns = new Map(); // qid -> text

  // ===== timer (persist endAt) =====
  let endAtMs = 0;
  let timerHandle = null;

  function formatMMSS(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function startTimer(minutes){
    const totalSeconds = Math.max(0, Math.floor((minutes || 0) * 60));
    if(!totalSeconds){
      $("timeLeft").textContent = "--:--";
      return;
    }

    const key = `epbd_mt_end_${modelTestId}`;
    const saved = localStorage.getItem(key);
    const now = Date.now();

    if(saved){
      const v = Number(saved);
      if(!Number.isNaN(v) && v > now + 3000){
        endAtMs = v;
      }else{
        endAtMs = now + totalSeconds * 1000;
        localStorage.setItem(key, String(endAtMs));
      }
    }else{
      endAtMs = now + totalSeconds * 1000;
      localStorage.setItem(key, String(endAtMs));
    }

    const tick = ()=>{
      const left = Math.max(0, Math.floor((endAtMs - Date.now()) / 1000));
      $("timeLeft").textContent = formatMMSS(left);

      if(left <= 60){
        $("timeLeft").style.color = "var(--danger)";
      }else{
        $("timeLeft").style.color = "var(--text)";
      }

      if(left <= 0){
        clearInterval(timerHandle);
        timerHandle = null;
        showToast("‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑! ‡¶Ö‡¶ü‡ßã ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶");
        setTimeout(()=>submitTest(true), 350);
      }
    };

    tick();
    clearInterval(timerHandle);
    timerHandle = setInterval(tick, 1000);
  }

  // ===== persist answers =====
  function persistAnswers(){
    const key = `epbd_mt_ans_${modelTestId}`;
    const payload = {
      mcq: Array.from(mcqAns.entries()),
      written: Array.from(writtenAns.entries()),
      savedAt: Date.now()
    };
    localStorage.setItem(key, JSON.stringify(payload));
  }

  function restoreAnswers(){
    const key = `epbd_mt_ans_${modelTestId}`;
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return;
      const st = JSON.parse(raw);
      (st?.mcq || []).forEach(([qid, v])=> mcqAns.set(qid, v));
      (st?.written || []).forEach(([qid, v])=> writtenAns.set(qid, v));
    }catch(e){}
  }

  function resetAnswers(){
    if(!confirm("‡¶∏‡¶¨ Answer ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) return;
    mcqAns.clear();
    writtenAns.clear();
    persistAnswers();
    renderAll();
    showToast("Reset done");
  }
  window.resetAnswers = resetAnswers;

  // ===== load data =====
  async function loadModelTestDoc(id){
    const snap = await db.collection(COL_SUBJECT_MODEL_TESTS).doc(id).get();
    if(snap.exists) return { id: snap.id, ...snap.data() };
    return null;
  }

  async function fetchQuestionsFromCollection(colName, mtId){
    // no pagination, bring all
    try{
      const s = await db.collection(colName)
        .where("modelTestId","==", mtId)
        .orderBy("createdAt","asc")
        .get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){
      const s = await db.collection(colName)
        .where("modelTestId","==", mtId)
        .get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }
  }

  async function fetchQuestionsFromSubcollection(mtId){
    const ref = db.collection(COL_SUBJECT_MODEL_TESTS).doc(mtId).collection("questions");
    try{
      const s = await ref.orderBy("createdAt","asc").get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){
      const s = await ref.get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }
  }

  function setMetaHeader(){
    const title = getTitleField(mtDoc);
    $("mtName").textContent = title;
    $("tickerText").textContent = `${title} ‚Ä¢ Test ‡¶ö‡¶≤‡¶õ‡ßá ‚Ä¢ Submit ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶®‡¶ø‡¶®`;

    const mins = getTimeMinFromDoc(mtDoc);
    $("mtTime").textContent = mins ? String(mins) : "--";
    $("mtMark").textContent = String(getMarkFromDoc(mtDoc));
    $("mtTotalQ").textContent = String(questions.length || 0);
  }

  // ===== render all questions (single page) =====
  function renderAll(){
    const wrap = $("content");
    wrap.innerHTML = "";

    if(!questions.length){
      wrap.innerHTML = `<div class="err">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
      return;
    }

    const list = document.createElement("div");
    list.className = "qList";
    const letters = ["A","B","C","D"];

    // We'll inject 2 inline ads total ( ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá )
    const total = questions.length;
    const adPos1 = total >= 6 ? Math.floor(total/3) : 3;       // approx 1/3
    const adPos2 = total >= 10 ? Math.floor((2*total)/3) : 7;  // approx 2/3

    questions.forEach((q, i)=>{
      const qno = i + 1;
      const qid = q.id;

      // inline ad slot #1
      if(i === adPos1){
        const ad = document.createElement("div");
        ad.className = "inlineAd";
        ad.innerHTML = `
          <div>
            <div class="tag">Ad Slot</div>
            <div style="font-size:12px;">Inline Ad #1 (Paste code here)</div>
            <div id="ad_inline_1" style="margin-top:8px;">Paste AdSense code here</div>
          </div>
        `;
        list.appendChild(ad);
      }

      // inline ad slot #2
      if(i === adPos2){
        const ad = document.createElement("div");
        ad.className = "inlineAd";
        ad.innerHTML = `
          <div>
            <div class="tag">Ad Slot</div>
            <div style="font-size:12px;">Inline Ad #2 (Paste code here)</div>
            <div id="ad_inline_2" style="margin-top:8px;">Paste AdSense code here</div>
          </div>
        `;
        list.appendChild(ad);
      }

      const row = document.createElement("div");
      row.className = "qRow";
      row.dataset.qid = qid;

      const qt = pickQuestionText(q);
      const noteTxt = (q.note ?? q.explain ?? q.explanation ?? q.noteText ?? "").toString().trim();
      row.innerHTML = `
        <div class="qHead">
          <span class="qNo">Q${qno}</span>
          <p class="qText">${esc(qt || "(No question text)")}</p>
        </div>
        <div class="noteInline"><b>Note:</b> ${esc(noteTxt || "-")}</div>
      `;

      if(isWrittenQuestion(q)){
        const ta = document.createElement("textarea");
        ta.placeholder = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‚Ä¶";
        ta.value = (writtenAns.get(qid) ?? "").toString();
        ta.oninput = ()=>{
          writtenAns.set(qid, ta.value);
          persistAnswers();
        };
        row.appendChild(ta);
      }else{
        const opts = getOptions(q);
        const chosen = mcqAns.get(qid);

        const optWrap = document.createElement("div");
        optWrap.className = "opts";

        opts.slice(0,4).forEach((op, oi)=>{
          const opt = document.createElement("div");
          opt.className = "optLine" + (chosen === oi ? " selected" : "");
          opt.innerHTML = `
            <span class="tick">‚úì</span>
            <span class="optKey">${letters[oi]}.</span>
            <span class="optTxt">${esc(op || "")}</span>
          `;
          opt.onclick = ()=>{
            mcqAns.set(qid, oi);
            persistAnswers();
            // update just this question block quickly
            renderAll(); // simple + safe (you can optimize later)
          };
          optWrap.appendChild(opt);
        });

        row.appendChild(optWrap);
      }

      list.appendChild(row);
    });

    wrap.appendChild(list);
  }

  // ===== unanswered detection + submit warning =====
  function getUnanswered(){
    const missing = [];
    questions.forEach((q, i)=>{
      const qid = q.id;
      if(isWrittenQuestion(q)){
        const txt = (writtenAns.get(qid) ?? "").toString().trim();
        if(!txt) missing.push({ index: i, id: qid, type:"written" });
      }else{
        const v = mcqAns.get(qid);
        if(v === undefined || v === null || v === "") missing.push({ index: i, id: qid, type:"mcq" });
      }
    });
    return missing;
  }

  function scrollToQuestion(qid){
    const el = document.querySelector(`[data-qid="${CSS.escape(qid)}"]`);
    if(el){
      try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }
      catch(e){ el.scrollIntoView(); }
      el.style.outline = "2px solid rgba(220,38,38,.35)";
      el.style.outlineOffset = "4px";
      setTimeout(()=>{ el.style.outline=""; el.style.outlineOffset=""; }, 1800);
    }
  }

  function calcUsedSec(){
    const mins = getTimeMinFromDoc(mtDoc);
    const endKey = `epbd_mt_end_${modelTestId}`;
    const endRaw = localStorage.getItem(endKey);
    const endMs = endRaw ? Number(endRaw) : 0;
    const totalMs = mins ? mins*60*1000 : 0;
    if(!totalMs || !endMs) return null;

    const leftMs = Math.max(0, endMs - Date.now());
    const usedMs = Math.max(0, totalMs - leftMs);
    return Math.floor(usedMs/1000);
  }

  function submitTest(isAuto=false){
    if(!modelTestId) return;

    const missing = getUnanswered();

    if(!isAuto && missing.length){
      // ‚úÖ warning on submit
      const ok = confirm(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${missing.length} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶§‡¶¨‡ßÅ‡¶ì Submit ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`);
      if(!ok){
        scrollToQuestion(missing[0].id);
        return;
      }
    }else if(!isAuto){
      const ok = confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá Submit ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
      if(!ok) return;
    }

    const payload = {
      modelTestId,
      title: getTitleField(mtDoc),
      submittedAt: Date.now(),
      isAuto: !!isAuto,
      score: null, // you can compute later if needed
      answers: {
        mcq: Array.from(mcqAns.entries()),
        written: Array.from(writtenAns.entries())
      },
      usedSec: calcUsedSec()
    };

    localStorage.setItem(`epbd_result_${modelTestId}`, JSON.stringify(payload));
    location.href = `model-test-reasult.html?modelTestId=${encodeURIComponent(modelTestId)}`;
  }
  window.submitTest = submitTest;

  // ===== PDF download (Bangla safe => canvas/image based) =====
  async function downloadPDF(){
    try{
      if(!questions.length){
        showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á");
        return;
      }

      showToast("PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶");

      // build hidden PDF content (simple clean)
      const pdfArea = $("pdfArea");
      const title = getTitleField(mtDoc);
      const mins = getTimeMinFromDoc(mtDoc);
      const mark = getMarkFromDoc(mtDoc);

      const parts = [];
      parts.push(`<div class="pdfTitle">${esc(title)}</div>`);
      parts.push(`<div class="pdfMeta">
        <span>‡¶∏‡¶Æ‡ßü: ${esc(mins ? mins : "-")} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</span>
        <span>‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï: ${esc(mark)}</span>
        <span>‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${esc(questions.length)}</span>
      </div>`);

      const letters = ["A","B","C","D"];
      questions.forEach((q, i)=>{
        const qno = i+1;
        const qt = pickQuestionText(q);
        const noteTxt = (q.note ?? q.explain ?? q.explanation ?? q.noteText ?? "").toString().trim();
        const written = isWrittenQuestion(q);

        parts.push(`<div class="pdfQ">
          <div><b>Q${qno}.</b> ${esc(qt)}</div>
          <div style="margin-top:4px;color:#555;font-size:11.5px;"><b>Note:</b> ${esc(noteTxt || "-")}</div>
          ${
            written
              ? `<div style="margin-top:8px;font-size:12px;color:#333;"><b>Answer:</b> ____________________________</div>`
              : (()=> {
                  const opts = getOptions(q);
                  const optHtml = opts.slice(0,4).map((op, oi)=>`<div>${letters[oi]}. ${esc(op || "")}</div>`).join("");
                  return `<div class="pdfOpt">${optHtml}</div>`;
                })()
          }
        </div>`);
      });

      pdfArea.innerHTML = parts.join("");

      // render to canvas (raster => Bengali safe)
      const canvas = await html2canvas(pdfArea, {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true
      });

      const imgData = canvas.toDataURL("image/jpeg", 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Fit image to width, split into pages
      const imgW = pageW;
      const imgH = (canvas.height * imgW) / canvas.width;

      let y = 0;
      let page = 0;

      // Create a temp canvas to slice pages
      const sliceCanvas = document.createElement("canvas");
      const sliceCtx = sliceCanvas.getContext("2d");

      const scale = canvas.width / imgW; // px per pt
      const pagePxH = Math.floor(pageH * scale);

      sliceCanvas.width = canvas.width;
      sliceCanvas.height = pagePxH;

      while(y < canvas.height){
        sliceCtx.clearRect(0, 0, sliceCanvas.width, sliceCanvas.height);
        sliceCtx.drawImage(canvas, 0, y, canvas.width, pagePxH, 0, 0, canvas.width, pagePxH);

        const sliceData = sliceCanvas.toDataURL("image/jpeg", 0.95);

        if(page > 0) pdf.addPage();
        pdf.addImage(sliceData, "JPEG", 0, 0, pageW, pageH);

        y += pagePxH;
        page++;
      }

      const safeName = title.replace(/[\\/:*?"<>|]+/g, "_").trim() || "question-paper";
      pdf.save(`${safeName}.pdf`);

      showToast("PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá");
    }catch(e){
      console.error(e);
      showToast("PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
    }
  }
  window.downloadPDF = downloadPDF;

  // ===== boot =====
  async function loadAll(){
    if(!modelTestId){
      $("content").innerHTML = `<div class="err">modelTestId ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ URL: Start-model-test.html?modelTestId=XXXX</div>`;
      return;
    }

    restoreAnswers();

    try{
      const mt = await loadModelTestDoc(modelTestId);
      if(!mt){
        $("content").innerHTML = `<div class="err">‡¶è‡¶á Model Test ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
        return;
      }
      mtDoc = mt;

      // questions: try candidates then subcollection
      let qs = [];
      for(const col of QUESTION_COLLECTION_CANDIDATES){
        try{
          const got = await fetchQuestionsFromCollection(col, modelTestId);
          if(got && got.length){
            qs = got;
            break;
          }
        }catch(e){}
      }
      if(!qs.length){
        try{ qs = await fetchQuestionsFromSubcollection(modelTestId); }catch(e){}
      }

      questions = qs || [];
      setMetaHeader();

      // start timer
      const mins = getTimeMinFromDoc(mtDoc);
      startTimer(mins);

      renderAll();
      persistAnswers();
    }catch(err){
      console.error(err);
      $("content").innerHTML = `<div class="err">‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>`;
    }
  }

  // save on exit
  window.addEventListener("beforeunload", ()=> {
    try{ persistAnswers(); }catch(e){}
  });

  loadAll();
</script>
</body>
</html>
