<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Result Sheet (Ranking) ‚Äî eProstutiBD</title>

  <meta name="description" content="eProstutiBD Model Test Result Sheet ‚Äî Ranking + Filters + Popup Details + PDF" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#1d4ed8" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="https://www.gstatic.com" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

  <!-- Bengali + Handwriting-ish font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700;800;900;1000&family=Caveat:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f6f8ff; --bg2:#eef6ff;
      --line: rgba(18, 28, 55, .10);
      --text:#0f1730; --muted:#5a6685;

      --shadow2: 0 10px 26px rgba(15,23,48,.08);

      --ok:#16a34a;
      --danger:#dc2626;
      --warn:#f59e0b;

      --footTop:#0b1f3f;
      --footBottom:#07152e;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(800px 560px at 92% 14%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit}
    .srOnly{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding-left: clamp(8px, 2vw, 20px);
      padding-right: clamp(8px, 2vw, 20px);
      padding-top: 12px;
      padding-bottom: 18px;
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(135deg, rgba(29,78,216,.96), rgba(14,165,233,.92));
      border-bottom: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 34px rgba(29,78,216,.18);
    }
    .topbar{
      max-width: 1200px;
      margin:0 auto;
      padding: 10px clamp(8px, 2vw, 20px);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{display:flex;flex-direction:column;gap:3px;flex:0 0 auto;min-width:0;}
    .brand .name{color:#fff;font-weight:1000;letter-spacing:.2px;font-size:15px;line-height:1;white-space:nowrap;}
    .brand .tag{color:rgba(255,255,255,.88);font-size:12px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 520px;}

    nav.nav{display:flex;gap:8px;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;flex:1;}
    nav.nav::-webkit-scrollbar{display:none}
    nav.nav a{
      flex:0 0 auto;text-decoration:none;color:#fff;font-size:12px;font-weight:1000;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);white-space:nowrap;transition:.15s;
    }
    nav.nav a:hover{background: rgba(255,255,255,.16)}
    nav.nav a.active{background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.26)}

    .menuBtn{
      flex:0 0 auto;margin-left:auto;display:none;
      border:1px solid rgba(255,255,255,.22);background: rgba(255,255,255,.14);color:#fff;
      border-radius: 12px;padding: 8px 10px;font-weight:1000;font-size:12px;cursor:pointer;line-height:1;
    }
    @media (max-width: 860px){
      nav.nav{display:none;}
      .menuBtn{display:inline-flex;align-items:center;gap:8px;}
      .brand .tag{max-width: 55vw;}
    }

    .mobileMenu{display:none;position:fixed;inset:0;z-index:9999;}
    .mobileMenu .overlay{position:absolute;inset:0;background:transparent;}
    .mobileMenu .drawer{
      position:absolute;top:64px;right:12px;width:min(320px, calc(100vw - 24px));
      border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,.28);
      background: rgba(8, 20, 55, .78);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 38px rgba(0,0,0,.35);
    }
    .mobileMenu a{
      display:block;text-decoration:none;color:#fff;font-weight:1000;font-size:13px;
      padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);margin-bottom:8px;white-space:nowrap;
    }
    .mobileMenu a.active{border-color: rgba(255,255,255,.28);background: rgba(255,255,255,.12);}

    /* ===== Cards ===== */
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
    }
    .title{ margin:0; font-size: 18px; font-weight:1000; line-height:1.28; text-align:center; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 12.8px; font-weight: 900; line-height:1.55; text-align:center; }

    .tableWrap{
      margin-top: 12px;
      border:1px solid rgba(18,28,55,.10);
      border-radius: 16px;
      overflow:auto;
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 22px rgba(15,23,48,.04);
    }
    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(18,28,55,.08);
      font-size: 13px;
      vertical-align: top;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 1000;
      background: rgba(29,78,216,.06);
      white-space:nowrap;
    }
    td{
      font-weight: 1000;
      color: var(--text);
      background: rgba(255,255,255,.64);
    }
    tr:last-child td{border-bottom:none;}

    /* ‚úÖ Zebra rows (green/white) */
    #rankBody tr:nth-child(odd) td{ background: rgba(22,163,74,.06) !important; }
    #rankBody tr:nth-child(even) td{ background: rgba(255,255,255,.70) !important; }

    /* ‚úÖ Highlight selected result row (from resultId) */
    #rankBody tr.hl td{
      background: rgba(245,158,11,.22) !important;
      box-shadow: inset 0 0 0 2px rgba(245,158,11,.55);
    }
    #rankBody tr.hl{ animation: popHL 1.15s ease-in-out 1; }
    @keyframes popHL{
      0%{transform: scale(1);}
      40%{transform: scale(1.01);}
      100%{transform: scale(1);}
    }

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:1000;
      border:1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.10); color: rgba(22,163,74,1);}
    .badge.bad{border-color: rgba(220,38,38,.22); background: rgba(220,38,38,.10); color: rgba(220,38,38,1);}
    .badge.warn{border-color: rgba(245,158,11,.24); background: rgba(245,158,11,.14); color: rgba(245,158,11,1);}

    /* ‚úÖ No Ans badge red */
    .badge.noAnsRed{
      border-color: rgba(220,38,38,.30);
      background: rgba(220,38,38,.12);
      color: rgba(220,38,38,1);
    }

    .actions{ margin-top: 12px; display:flex; gap: 10px; justify-content:center; flex-wrap:wrap; }
    .btn{
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 12.5px;
      font-weight: 1000;
      cursor:pointer;
      border: 1px solid rgba(29,78,216,.28);
      background: rgba(29,78,216,.12);
      color: rgba(29,78,216,1);
      box-shadow: 0 10px 22px rgba(15,23,48,.05);
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .btnGhost{ border:1px solid rgba(18,28,55,.14); background: rgba(255,255,255,.70); color: var(--text); }
    .btnDanger{ border:1px solid rgba(220,38,38,.28); background: rgba(220,38,38,.10); color: var(--danger); }

    /* ===== Filters ===== */
    .filterBar{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
    }
    .filterCard{
      flex: 1 1 520px;
      max-width: 980px;
      border-radius: 18px;
      border: 1px solid rgba(18,28,55,.12);
      background:
        radial-gradient(600px 200px at 10% 0%, rgba(29,78,216,.10), transparent 60%),
        radial-gradient(600px 200px at 90% 0%, rgba(14,165,233,.10), transparent 60%),
        rgba(255,255,255,.78);
      box-shadow: 0 14px 34px rgba(15,23,48,.06);
      padding: 12px;
    }
    .filterGrid{ display:grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items:center; }
    @media (max-width: 740px){ .filterGrid{grid-template-columns: 1fr;} }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; font-weight:1000; color: var(--muted); display:flex; gap:8px; align-items:center; }
    .pillDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(29,78,216,.35);
      box-shadow: 0 0 0 4px rgba(29,78,216,.10);
      flex:0 0 auto;
    }
    .field input{
      border: 1px solid rgba(18,28,55,.14);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      outline:none;
      background: rgba(255,255,255,.90);
      transition: .15s;
    }
    .field input:focus{
      border-color: rgba(29,78,216,.35);
      box-shadow: 0 0 0 5px rgba(29,78,216,.10);
    }
    .filterBtns{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    @media (max-width: 740px){ .filterBtns{justify-content:center;} }

    /* ===== Pager ===== */
    .pager{
      margin-top: 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-weight:1000;
      font-size:12px;
    }

    /* ===== Popup ===== */
    .modal{ display:none; position:fixed; inset:0; z-index:99999; }
    .modal.show{display:block;}
    .modalOverlay{
      position:absolute; inset:0;
      background: rgba(2, 6, 23, .45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .modalDialog{
      position:relative;
      margin: 70px auto 24px;
      width: min(980px, calc(100vw - 18px));
      max-height: calc(100vh - 100px);
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      background:
        linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92)),
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 26px,
          rgba(18,28,55,.055) 27px
        );
      padding: 14px;
    }
    .modalClose{
      position:sticky; top: 0;
      display:flex; justify-content:flex-end;
      padding: 6px 4px 10px; z-index: 5;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
    }
    .xBtn{
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      border: 1px solid rgba(18,28,55,.18);
      background: rgba(255,255,255,.80);
      color: var(--text);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .paperFrame{
      position: relative;
      z-index: 1;
      border: 1.6px solid rgba(18,28,55,.18);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255,255,255,.55);
      overflow:hidden;
      min-height: 220px;
    }

    .detailsTopBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }

    .markStamp{
      position:absolute;
      top: 58px;
      left: 14px;
      transform: rotate(-10deg);
      padding: 10px 12px 8px;
      border-radius: 12px;
      border: 2px solid rgba(15,23,48,.22);
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 24px rgba(15,23,48,.10);
      user-select:none;
      pointer-events:none;
      display:none;
      min-width: 150px;
    }
    .markStamp .score{
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 34px;
      font-weight: 700;
      letter-spacing: .6px;
      color: rgba(15,23,48,.92);
      line-height: 1.05;
      text-align:left;
    }
    .markStamp .pf{
      margin-top: 4px;
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .4px;
      text-align:left;
    }
    .markStamp .pf.pass{ color: rgba(22,163,74,.95); }
    .markStamp .pf.fail{ color: rgba(220,38,38,.95); }
    .markStamp .note{
      margin-top: 2px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(90,102,133,.9);
      text-align:left;
    }

    .sheetHead{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 8px;
      border-bottom: 1px solid rgba(18,28,55,.10);
      padding-bottom: 12px;
      margin-bottom: 12px;
      text-align:center;
    }
    .sheetTitle{ margin:0; font-size: 15px; font-weight: 1000; line-height:1.35; }
    .sheetSub{ margin:0; color: var(--muted); font-size: 12.5px; font-weight: 900; line-height:1.55; }
    .sheetStats{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; justify-content:center; }

    .qList{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0;
      border: 1px solid rgba(18,28,55,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.60);
    }
    @media (max-width: 980px){ .qList{grid-template-columns: 1fr;} }
    .qRow{ padding: 12px 12px; border-bottom: 1px solid rgba(18,28,55,.08); }
    @media (min-width: 981px){
      .qRow:nth-child(2n){border-left: 1px solid rgba(18,28,55,.08);}
      .qRow:nth-last-child(-n+2){border-bottom:none;}
    }
    @media (max-width: 980px){ .qRow:last-child{border-bottom:none;} }

    .qHead{display:flex;gap:10px;align-items:flex-start;}
    .qNo{
      flex:0 0 auto;
      font-size:12px;font-weight:1000;
      padding: 6px 9px;border-radius:999px;
      border: 1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.70);
      color: var(--muted);white-space:nowrap;
      transform: translateY(1px);
    }
    .qText{margin:0;font-weight:1000;font-size:14px;line-height:1.6;flex:1;}

    .opts{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 14px;
    }
    .optLine{
      display:grid;
      grid-template-columns: 20px 20px 1fr;
      gap: 6px;
      align-items:flex-start;
      padding: 2px 0;
      font-size: 13px;
      line-height: 1.55;
    }
    .markIcon{
      width:20px;height:20px;border-radius:999px;
      display:grid;place-items:center;
      font-weight:1000;
      font-size:12px;
      border: 1px solid rgba(18,28,55,.14);
      background: rgba(255,255,255,.70);
      color: transparent;
      transform: translateY(1px);
    }
    .markIcon.ok{
      border-color: rgba(22,163,74,.25);
      background: rgba(22,163,74,.10);
      color: rgba(22,163,74,1);
    }
    .markIcon.bad{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.10);
      color: rgba(220,38,38,1);
    }
    .markIcon.warn{
      border-color: rgba(245,158,11,.30);
      background: rgba(245,158,11,.16);
      color: rgba(245,158,11,1);
    }

    .optKey{font-weight:1000;color: var(--muted);}
    .optTxt{font-weight: 900;color: var(--text);}
    .optTxt.ok{color: rgba(22,163,74,1);}
    .optTxt.bad{color: rgba(220,38,38,1);}
    .optTxt.warn{color: rgba(245,158,11,1);}

    .noAnsText{ margin-top: 8px; font-weight: 1000; font-size: 13px; color: rgba(220,38,38,1); }
    .loading{color: var(--muted); font-weight:1000; font-size:13px;}
    .err{color: var(--danger); font-weight:1000; font-size:13px;}

    /* ===== PDF render area ===== */
    .pdfPageArea{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px;
      background:#fff;
      color:#111;
      padding: 16px;
      font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .pdfFrame{
      position: relative;
      border: 2px solid #111;
      padding: 14px;
      min-height: 1040px;
      background:#fff;
      overflow:hidden;
    }
    .pdfWatermark{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      user-select:none;
    }
    .pdfWatermark span{
      transform: rotate(-22deg);
      font-size: 84px;
      font-weight: 1000;
      letter-spacing: 2px;
      opacity: .08;
      color:#111;
      white-space:nowrap;
    }

    .pdfMark{
      position:absolute;
      top: 16px;
      left: 16px;
      transform: rotate(-10deg);
      padding: 8px 10px 6px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.35);
      background: rgba(255,255,255,.72);
      min-width: 140px;
    }
    .pdfMark .score{
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 30px;
      font-weight: 700;
      color:#111;
      line-height:1.05;
    }
    .pdfMark .pf{
      margin-top: 2px;
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 18px;
      font-weight: 700;
    }
    .pdfMark .pf.pass{ color: #16a34a; }
    .pdfMark .pf.fail{ color: #dc2626; }

    .pdfH1{text-align:center;font-weight:1000;font-size:16px;margin: 52px 0 2px;}
    .pdfH2{text-align:center;font-weight:900;font-size:13px;margin: 0 0 10px;}
    .pdfStatsRow{
      display:flex;
      justify-content:center;
      gap: 8px;
      flex-wrap:wrap;
      margin: 8px 0 10px;
      font-size: 12px;
      font-weight: 1000;
    }
    .pdfPill{
      display:inline-flex;gap:8px;align-items:center;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(0,0,0,.03);
      white-space:nowrap;
    }
    .pdfPill.ok{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.10); color:#0b3d1f;}
    .pdfPill.bad{border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.10); color:#5c0b0b;}
    .pdfPill.warn{border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.14); color:#4a2d00;}

    .pdfQuestions{
      column-count: 2;
      column-gap: 16px;
      margin-top: 10px;
    }
    .pdfQ{
      break-inside: avoid;
      -webkit-column-break-inside: avoid;
      page-break-inside: avoid;
      font-size:12px;
      line-height:1.45;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px dashed rgba(0,0,0,.18);
    }
    .pdfQ .qline{font-weight:1000;margin-bottom: 4px;}
    .pdfOpt{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 10px;
      font-size:11.6px;
    }
    .pdfOpt .ok{color: #16a34a; font-weight:1000;}
    .pdfOpt .bad{color: #dc2626; font-weight:1000;}
    .pdfOpt .warn{color: #f59e0b; font-weight:1000;}
    .pdfOpt .dim{color: #111;}

    .pdfNoAns{ margin-top: 4px; font-weight: 1000; color:#dc2626; font-size: 11.6px; }

    .pdfFooter{
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:11px;
      font-weight:900;
      opacity:.75;
    }

    /* ===== Footer ===== */
    footer{
      margin-top: 14px;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(900px 320px at 80% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--footTop), var(--footBottom));
      border-top: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
    }
    .footGrid{
      max-width: 1200px;
      margin:0 auto;
      padding: 18px clamp(8px, 2vw, 20px) 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px 18px;
      align-items:start;
    }
    .footTitle{font-weight:1000;color:#fff;font-size:13px;margin-bottom: 8px;}
    .footText{color: rgba(255,255,255,.70);font-size:12px;line-height:1.6;}
    .footLinks{display:flex;flex-direction:column;gap: 8px;}
    .footLinks a{text-decoration:none;color: rgba(255,255,255,.70);font-size:12px;}
    .footLinks a:hover{color:#fff;text-decoration:underline;text-underline-offset:4px;}

    .socials{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .soc{
      width:36px;height:36px;border-radius:999px;
      display:grid;place-items:center;
      text-decoration:none;
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      font-weight:1000;
      line-height:1;
      user-select:none;
    }
    .soc:hover{background: rgba(255,255,255,.18);}

    .copy{
      max-width: 1200px;
      margin:0 auto;
      padding: 12px clamp(8px, 2vw, 20px) 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.68);
      font-size:12px;
      text-align:center;
      line-height:1.6;
      white-space:normal;
    }
    @media (max-width: 980px){
      .footGrid{grid-template-columns: repeat(2, minmax(0, 1fr));gap: 10px 10px;}
    }
  </style>
</head>

<body>
  <h1 class="srOnly">Model Test Result Sheet</h1>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="name">eProstutiBD</div>
        <div class="tag" id="headerTag">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶π‡ßã‡¶ï ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá</div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="#">‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡ßÄ</a>
        <a href="#">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</a>
        <a href="#">‡¶è‡¶°‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
        <a href="#">‡¶ú‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
        <a class="active" href="#" aria-current="page">‡¶Æ‡¶°‡ßá‡¶≤ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü</a>
        <a href="#">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶´‡ßá‡ßü‡¶æ‡¶∞‡ßç‡¶∏</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">‡¶®‡ßã‡¶ü‡¶ø‡¶∂</a>
        <a href="#">‡¶¨‡ßç‡¶≤‡¶ó</a>
        <a href="#">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡¶æ‡¶∞</a>
      </nav>

      <button class="menuBtn" id="menuBtn" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu" onclick="toggleMenu()">‚ò∞</button>
    </div>

    <div class="mobileMenu" id="mobileMenu">
      <div class="overlay" onclick="closeMenu()"></div>
      <div class="drawer" role="dialog" aria-label="Menu" onclick="event.stopPropagation()">
        <a href="#">‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡ßÄ</a>
        <a href="#">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</a>
        <a href="#">‡¶è‡¶°‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
        <a href="#">‡¶ú‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü</a>
        <a class="active" href="#" aria-current="page">‡¶Æ‡¶°‡ßá‡¶≤ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü</a>
        <a href="#">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶´‡ßá‡ßü‡¶æ‡¶∞‡ßç‡¶∏</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">‡¶®‡ßã‡¶ü‡¶ø‡¶∂</a>
        <a href="#">‡¶¨‡ßç‡¶≤‡¶ó</a>
        <a href="#">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡¶æ‡¶∞</a>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="card" aria-label="Result sheet">
      <!-- ‚úÖ Model Test Name ‡¶â‡¶™‡¶∞‡ßá -->
      <h2 class="title" id="modelTestTitle">Model Test</h2>
      <!-- ‚úÖ Result Sheet (Ranking) ‡¶®‡¶ø‡¶ö‡ßá -->
      <p class="sub" id="pageTitle">Result Sheet (Ranking)</p>

      <!-- ‚úÖ Filters -->
      <div class="filterBar" aria-label="Filters">
        <div class="filterCard">
          <div class="filterGrid">
            <div class="field">
              <label for="fName"><span class="pillDot"></span> Name</label>
              <input id="fName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‚Ä¶" autocomplete="off" />
            </div>
            <div class="field">
              <label for="fZila"><span class="pillDot"></span> Zila</label>
              <input id="fZila" placeholder="‡¶ú‡ßá‡¶≤‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‚Ä¶" autocomplete="off" />
            </div>
            <div class="filterBtns">
              <button class="btn btnGhost" type="button" onclick="resetFilters()">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tableWrap">
        <table style="min-width:1140px;">
          <thead>
            <tr>
              <th style="width:60px;">Rank</th>
              <th>Name</th>
              <th>Address</th>
              <th style="width:180px;">Submit date &amp; time</th>
              <th style="width:90px;">Right</th>
              <th style="width:90px;">Wrong</th>
              <th style="width:90px;">No Ans</th>
              <th style="width:90px;">Mark</th>
              <th style="width:120px;">Time Taken</th>
              <th style="width:100px;">Pass/Fail</th>
              <th style="width:90px;">Details</th>
            </tr>
          </thead>
          <tbody id="rankBody">
            <tr><td colspan="11">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <!-- ‚úÖ pager (25 per page) -->
      <div class="pager">
        <button class="btn btnGhost" type="button" onclick="prevPage()">Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="btn btnGhost" type="button" onclick="nextPage()">Next</button>
      </div>

      <div class="actions">
        <button class="btnGhost btn" type="button" onclick="backToTest()">Back to Test</button>
      </div>
    </section>
  </div>

  <!-- ‚úÖ Popup Details Modal -->
  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modalOverlay" onclick="closeDetails()"></div>
    <div class="modalDialog" role="dialog" aria-label="Details Popup" onclick="event.stopPropagation()">
      <div class="modalClose">
        <button class="xBtn" type="button" onclick="closeDetails()">‚úï Close</button>
      </div>

      <div class="paperFrame" id="paperFrame">
        <div class="detailsTopBar">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <span class="badge" id="detailTimeTaken">Time: --</span>
          </div>
          <button class="btn btnDanger" type="button" onclick="downloadResultPDF()">Download Result PDF</button>
        </div>

        <div class="markStamp" id="markStamp"></div>

        <div class="sheetHead">
          <div>
            <p class="sheetTitle" id="sheetTitle">Details</p>
            <p class="sheetSub" id="sheetSub">‚Äî</p>
          </div>
          <div class="sheetStats" id="sheetStats"></div>
        </div>

        <div id="detailContent">
          <div class="loading">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <!-- hidden offscreen for PDF rendering -->
  <div class="pdfPageArea" id="pdfPageArea" aria-hidden="true"></div>

  <footer>
    <div class="footGrid">
      <div>
        <div class="footTitle">eProstutiBD</div>
        <div class="footText">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶π‡ßã‡¶ï ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá</div>
      </div>

      <div>
        <div class="footTitle">‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶™‡ßá‡¶ú</div>
        <div class="footLinks">
          <a href="#">About</a>
          <a href="#">Privacy Policy</a>
          <a href="#">Terms</a>
          <a href="#">Contact</a>
        </div>
      </div>

      <div>
        <div class="footTitle">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</div>
        <div class="footLinks">
          <a href="#">Notice</a>
          <a href="#">Blog</a>
          <a href="#">Career</a>
          <a href="#">Help</a>
        </div>
      </div>

      <div>
        <div class="footTitle">Follow Us</div>
        <div class="socials">
          <a class="soc" href="#" aria-label="Facebook" target="_blank" rel="noopener">f</a>
          <a class="soc" href="#" aria-label="LinkedIn" target="_blank" rel="noopener">in</a>
          <a class="soc" href="#" aria-label="YouTube" target="_blank" rel="noopener">‚ñ∂</a>
        </div>
      </div>
    </div>

    <div class="copy">¬© <span id="year"></span> eProstutiBD ‚Äî All rights reserved</div>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  document.getElementById("year").textContent = new Date().getFullYear();
  const $ = (id)=>document.getElementById(id);

  // ===== menu =====
  function openMenu(){ $("mobileMenu").style.display="block"; $("menuBtn").setAttribute("aria-expanded","true"); }
  function closeMenu(){ $("mobileMenu").style.display="none"; $("menuBtn").setAttribute("aria-expanded","false"); }
  function toggleMenu(){ const m=$("mobileMenu"); (m.style.display==="block")?closeMenu():openMenu(); }
  window.toggleMenu = toggleMenu;
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

  // ===== utils =====
  function esc(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name) || "";
  }
  function fmtTime(ms){
    const n = Number(ms);
    if(!Number.isFinite(n) || n <= 0) return "--";
    return new Date(n).toLocaleString("bn-BD", { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }
  function safeNum(x, fallback){
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }

  // ‚úÖ parse timeTakenText to seconds (for tie-break)
  function parseTimeTakenTextToSeconds(t){
    const s = String(t ?? "").trim().toLowerCase();
    if(!s) return Number.POSITIVE_INFINITY;

    if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){
      const parts = s.split(":").map(x=>Number(x));
      if(parts.some(n=>!Number.isFinite(n))) return Number.POSITIVE_INFINITY;
      if(parts.length === 2) return parts[0]*60 + parts[1];
      if(parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
    }
    if(/^\d+(\.\d+)?s$/.test(s)){
      const n = Number(s.replace("s",""));
      return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY;
    }

    let total = 0;
    let matched = false;

    const h = s.match(/(\d+)\s*(h|hr|hrs|hour|hours|‡¶ò‡¶£‡ßç‡¶ü‡¶æ)/);
    if(h){ total += Number(h[1]) * 3600; matched = true; }

    const m = s.match(/(\d+)\s*(m|min|mins|minute|minutes|‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)/);
    if(m){ total += Number(m[1]) * 60; matched = true; }

    const sec = s.match(/(\d+)\s*(s|sec|secs|second|seconds|‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°)/);
    if(sec){ total += Number(sec[1]); matched = true; }

    return matched ? total : Number.POSITIVE_INFINITY;
  }

  function setUrlResultId(resId){
    const u = new URL(location.href);
    if(modelTestId) u.searchParams.set("modelTestId", modelTestId);
    u.searchParams.set("resultId", resId);
    history.replaceState({}, "", u.toString());
  }
  function clearUrlResultId(){
    const u = new URL(location.href);
    u.searchParams.delete("resultId");
    history.replaceState({}, "", u.toString());
  }

  // ‚úÖ 5s highlight helper
  function highlightRowForSeconds(resId, sec=5){
    if(!resId) return;
    clearHighlights();
    const tr = document.querySelector(`#rankBody tr[data-result-id="${CSS.escape(resId)}"]`);
    if(!tr) return;
    tr.classList.add("hl");
    tr.scrollIntoView({ behavior:"smooth", block:"center" });

    clearTimeout(highlightRowForSeconds._tm);
    highlightRowForSeconds._tm = setTimeout(()=>{
      tr.classList.remove("hl");
    }, sec * 1000);
  }

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
    authDomain: "eprostutibd-webapp.firebaseapp.com",
    projectId: "eprostutibd-webapp",
    storageBucket: "eprostutibd-webapp.firebasestorage.app",
    messagingSenderId: "1044069942330",
    appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
    measurementId: "G-T2G55NMDQT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ==========================================
  // ‚úÖ MATCH WITH START PAGE (OLD + NEW SOURCES)
  // ==========================================
  const COL_RESULTS = "model_test_result";

  // OLD meta/questions
  const COL_SUBJECT_MODEL_TESTS = "subject_model_tests";
  const QUESTION_COLLECTION_CANDIDATES = [
    "modeltest_questions","model_test_questions","modeltest_question","modelTest_questions","modeltestQuestions"
  ];

  // ‚úÖ NEW (admin) meta/questions
  const COL_ADMISSION_SUBJECT_TESTS = "admission_subject_tests";
  const COL_ADMISSION_SUBJECT_TEST_QUESTIONS = "admission_subject_test_questions"; // field: testId
  const COL_ADMISSION_TESTS = "admission_tests";
  const COL_ADMISSION_TEST_QUESTIONS = "admission_test_questions"; // field: testId

  // ‚úÖ URL params
  let modelTestId = getParam("modelTestId");
  const resultIdFromUrl = getParam("resultId");

  // ===== state =====
  let resultPayload = null;
  let questions = [];
  let mtSource = ""; // which meta collection matched

  let allRows = [];
  let filteredRows = [];
  let page = 1;
  const PAGE_SIZE = 25;

  // ‚úÖ highlight target (resultId)
  let highlightResultId = resultIdFromUrl || "";

  function backToTest(){
    if(!modelTestId) location.href = "Start-model-test.html";
    else location.href = `Start-model-test.html?modelTestId=${encodeURIComponent(modelTestId)}`;
  }
  window.backToTest = backToTest;

  // ===== answers map =====
  function getMcqMap(p){
    const o = p?.answers?.mcq;
    if(o && typeof o === "object" && !Array.isArray(o)) return o;
    if(Array.isArray(p?.answers?.mcq)){
      const out = {};
      try{ p.answers.mcq.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
      return out;
    }
    return {};
  }
  function getWrittenMap(p){
    const o = p?.answers?.written;
    if(o && typeof o === "object" && !Array.isArray(o)) return o;
    if(Array.isArray(p?.answers?.written)){
      const out = {};
      try{ p.answers.written.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
      return out;
    }
    return {};
  }

  // ===== question helpers =====
  function getQText(q){
    return (q.question ?? q.questionText ?? q.q ?? q.title ?? q.name ?? q.ques ?? q.qus ?? q.question_title ?? "").toString();
  }
  function getOptions(q){
    if(Array.isArray(q.options) && q.options.length) return q.options.slice(0,4).map(x=>String(x ?? ""));
    if(Array.isArray(q.choices) && q.choices.length) return q.choices.slice(0,4).map(x=>String(x ?? ""));
    if(Array.isArray(q.opts) && q.opts.length) return q.opts.slice(0,4).map(x=>String(x ?? ""));
    const o1 = q.option1 ?? q.opt1 ?? q.a ?? q.A ?? q.optionA ?? q.optA ?? q.choiceA;
    const o2 = q.option2 ?? q.opt2 ?? q.b ?? q.B ?? q.optionB ?? q.optB ?? q.choiceB;
    const o3 = q.option3 ?? q.opt3 ?? q.c ?? q.C ?? q.optionC ?? q.optC ?? q.choiceC;
    const o4 = q.option4 ?? q.opt4 ?? q.d ?? q.D ?? q.optionD ?? q.optD ?? q.choiceD;
    return [o1,o2,o3,o4].map(x=>String(x ?? ""));
  }
  function getCorrectIndex(q){
    const v = Number(q.correctIndex);
    return Number.isFinite(v) ? v : -1;
  }
  function isWrittenQuestion(q){
    const t = (q.type ?? q.qType ?? q.questionType ?? q.kind ?? "").toString().toLowerCase();
    return t === "written" || t === "cq" || t === "short" || t === "essay";
  }

  // ===========================
  // ‚úÖ FETCH HELPERS (old + new)
  // ===========================
  async function fetchQuestionsByField(colName, fieldName, fieldValue){
    try{
      const s = await db.collection(colName).where(fieldName,"==", fieldValue).orderBy("createdAt","asc").get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){
      const s = await db.collection(colName).where(fieldName,"==", fieldValue).get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }
  }

  async function fetchQuestionsFromSubcollection(mtId){
    const ref = db.collection(COL_SUBJECT_MODEL_TESTS).doc(mtId).collection("questions");
    try{
      const s = await ref.orderBy("createdAt","asc").get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){
      const s = await ref.get();
      return s.docs.map(d=>({ id:d.id, ...d.data() }));
    }
  }

  async function loadQuestionsOnce(){
    if(questions.length) return questions;
    if(!modelTestId) return [];

    // A) OLD: candidate collections (field modelTestId)
    for(const col of QUESTION_COLLECTION_CANDIDATES){
      try{
        const got = await fetchQuestionsByField(col, "modelTestId", modelTestId);
        if(got && got.length){ questions = got; return questions; }
      }catch(e){}
    }

    // B) OLD: subcollection
    try{
      const gotSub = await fetchQuestionsFromSubcollection(modelTestId);
      if(gotSub && gotSub.length){ questions = gotSub; return questions; }
    }catch(e){}

    // C) NEW: admission_subject_test_questions (field testId)
    try{
      const got = await fetchQuestionsByField(COL_ADMISSION_SUBJECT_TEST_QUESTIONS, "testId", modelTestId);
      if(got && got.length){ questions = got; return questions; }
    }catch(e){}

    // D) NEW: admission_test_questions (field testId)
    try{
      const got = await fetchQuestionsByField(COL_ADMISSION_TEST_QUESTIONS, "testId", modelTestId);
      if(got && got.length){ questions = got; return questions; }
    }catch(e){}

    questions = [];
    return questions;
  }

  // ‚úÖ meta loader (same logic as Start page)
  function getTitleField(data){
    return data?.title ?? data?.name ?? data?.modelTestName ?? data?.modelTestTitle ?? "Model Test";
  }
  async function loadModelTestMeta(mtId){
    // OLD
    const s1 = await db.collection(COL_SUBJECT_MODEL_TESTS).doc(mtId).get();
    if(s1.exists) return { source: COL_SUBJECT_MODEL_TESTS, doc: { id:s1.id, ...s1.data() } };

    // NEW: admission_subject_tests
    const s2 = await db.collection(COL_ADMISSION_SUBJECT_TESTS).doc(mtId).get();
    if(s2.exists) return { source: COL_ADMISSION_SUBJECT_TESTS, doc: { id:s2.id, ...s2.data() } };

    // NEW: admission_tests
    const s3 = await db.collection(COL_ADMISSION_TESTS).doc(mtId).get();
    if(s3.exists) return { source: COL_ADMISSION_TESTS, doc: { id:s3.id, ...s3.data() } };

    return { source:"", doc:null };
  }

  function calcNoAns(r){
    const totalQ = safeNum(r?.totalQuestion, NaN);
    const right = safeNum(r?.right, NaN);
    const wrong = safeNum(r?.wrong, NaN);

    if(Number.isFinite(safeNum(r?.noAnswer, NaN))) return safeNum(r?.noAnswer, 0);
    if(Number.isFinite(totalQ) && Number.isFinite(right) && Number.isFinite(wrong)){
      const na = totalQ - (right + wrong);
      return na >= 0 ? na : 0;
    }
    return "--";
  }

  function getPassFail(obtained, total){
    const o = safeNum(obtained, 0);
    const t = safeNum(total, 0);
    if(t <= 0) return { ok: null, label: "‚Äî" };
    const pct = (o / t) * 100;
    if(pct < 30) return { ok: false, label: "FAIL" };
    return { ok: true, label: "PASS" };
  }

  function normalizeText(s){ return String(s ?? "").toLowerCase().trim(); }

  function applyFilters(){
    const nameQ = normalizeText($("fName").value);
    const zilaQ = normalizeText($("fZila").value);

    filteredRows = allRows.filter(x=>{
      const p = x.p || {};
      const name = normalizeText(p.studentName);
      const zila = normalizeText(p.studentDistrict || p.studentAddress || p.address);
      const okName = !nameQ || name.includes(nameQ);
      const okZila = !zilaQ || zila.includes(zilaQ);
      return okName && okZila;
    });

    page = 1;
    renderPage();

    // üî• if a highlight id is set, jump to it after filtering
    if(highlightResultId) jumpToAndHighlightResult(highlightResultId, true);
  }

  function resetFilters(){
    $("fName").value = "";
    $("fZila").value = "";
    applyFilters();
  }
  window.resetFilters = resetFilters;

  function nextPage(){
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));
    if(page < totalPages){ page++; renderPage(); }
    if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
  }
  function prevPage(){
    if(page > 1){ page--; renderPage(); }
    if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
  }
  window.nextPage = nextPage;
  window.prevPage = prevPage;

  function renderPage(){
    const total = filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if(page > totalPages) page = totalPages;

    const start = (page - 1) * PAGE_SIZE;
    const slice = filteredRows.slice(start, start + PAGE_SIZE);

    if(!slice.length){
      $("rankBody").innerHTML = `<tr><td colspan="11">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
      $("pageInfo").textContent = `Page 1 / 1`;
      return;
    }

    const html = slice.map((x, idx)=>{
      const p = x.p, r = x.r;
      const name = p.studentName || "--";
      const addr = p.studentDistrict || p.studentAddress || p.address || "--";
      const submitted = fmtTime(p.submittedAt);

      const right = (r.right ?? "--");
      const wrong = (r.wrong ?? "--");
      const noAns = calcNoAns(r);
      const mark = (r.obtainedMark ?? x.obtained ?? "--");
      const timeTakenText = (p.timeTakenText ?? "--");

      const pf = getPassFail(r.obtainedMark, r.totalMark);
      const pfBadge = pf.ok === true
        ? `<span class="badge ok">PASS</span>`
        : pf.ok === false
          ? `<span class="badge bad">FAIL</span>`
          : `<span class="badge">‚Äî</span>`;

      const globalRank = start + idx + 1;

      return `
        <tr data-result-id="${esc(p.id)}">
          <td><span class="badge">${globalRank}</span></td>
          <td style="white-space:nowrap;">${esc(name)}</td>
          <td style="white-space:nowrap;">${esc(addr)}</td>
          <td style="white-space:nowrap;">${esc(submitted)}</td>
          <td>${esc(right)}</td>
          <td>${esc(wrong)}</td>
          <td><span class="badge noAnsRed">${esc(noAns)}</span></td>
          <td><span class="badge warn">${esc(mark)}</span></td>
          <td><span class="badge">${esc(timeTakenText)}</span></td>
          <td>${pfBadge}</td>
          <td>
            <button class="btn" style="padding:6px 10px;font-size:12px;"
              type="button" onclick="openDetailsByResultId('${esc(p.id)}')">Details</button>
          </td>
        </tr>
      `;
    }).join("");

    $("rankBody").innerHTML = html;
    $("pageInfo").textContent = `Page ${page} / ${totalPages}`;

    if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
  }

  function clearHighlights(){
    document.querySelectorAll("#rankBody tr.hl").forEach(tr=>tr.classList.remove("hl"));
  }
  function applyHighlightOnCurrentPage(resId){
    clearHighlights();
    const tr = document.querySelector(`#rankBody tr[data-result-id="${CSS.escape(resId)}"]`);
    if(tr) tr.classList.add("hl");
  }

  // ‚úÖ jump: (1) go page, (2) apply highlight, (3) optional 5s auto-remove
  function jumpToAndHighlightResult(resId, autoRemove=false){
    if(!resId) return;

    const idx = filteredRows.findIndex(x => x?.p?.id === resId);
    if(idx < 0) return;

    const targetPage = Math.floor(idx / PAGE_SIZE) + 1;
    if(page !== targetPage){
      page = targetPage;
      renderPage();
    }else{
      applyHighlightOnCurrentPage(resId);
    }

    setTimeout(()=>{
      const tr = document.querySelector(`#rankBody tr[data-result-id="${CSS.escape(resId)}"]`);
      if(tr) tr.scrollIntoView({ behavior:"smooth", block:"center" });

      if(autoRemove){
        highlightRowForSeconds(resId, 5);
      }
    }, 80);
  }

  // ‚úÖ See all result button support:
  // Call this from your "See all result" button onclick.
  // Example: <button onclick="seeAllResult()">See all result</button>
  function seeAllResult(){
    // Close details + clear filters so the row is visible
    closeDetails();

    // Reset filters (will call applyFilters + jump)
    resetFilters();

    // üî• highlight for 5 sec if we have a target result id
    if(highlightResultId){
      setTimeout(()=> jumpToAndHighlightResult(highlightResultId, true), 120);
    }
  }
  window.seeAllResult = seeAllResult;

  // ===== Popup (Details) open/close =====
  function openDetailsPopup(){
    $("detailsModal").classList.add("show");
    $("detailsModal").setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closeDetails(){
    $("detailsModal").classList.remove("show");
    $("detailsModal").setAttribute("aria-hidden","true");
    $("markStamp").style.display = "none";
    $("detailContent").innerHTML = `<div class="loading">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>`;
    clearUrlResultId();
    document.body.style.overflow = "";
  }
  window.closeDetails = closeDetails;

  document.addEventListener("keydown",(e)=>{
    if(e.key === "Escape"){
      closeMenu();
      closeDetails();
    }
  });

  function buildStatBadges(){
    const r = resultPayload?.result || {};
    const right = (r.right ?? "--");
    const wrong = (r.wrong ?? "--");
    const totalQ = (r.totalQuestion ?? "--");
    const noAns = calcNoAns(r);
    return `
      <span class="badge">${esc(totalQ)} Q</span>
      <span class="badge ok">‚úì ${esc(right)} Right</span>
      <span class="badge bad">‚úó ${esc(wrong)} Wrong</span>
      <span class="badge warn">${esc(noAns)} No Ans</span>
    `;
  }

  function renderMarkStamp(){
    const r = resultPayload?.result || {};
    const obtained = (r.obtainedMark ?? "--");
    const total = (r.totalMark ?? "--");
    const pf = getPassFail(r.obtainedMark, r.totalMark);

    const el = $("markStamp");
    el.innerHTML = `
      <div class="score">${esc(obtained)} / ${esc(total)}</div>
      <div class="pf ${pf.ok === true ? "pass" : pf.ok === false ? "fail" : ""}">${esc(pf.label)}</div>
      <div class="note">Teacher Checked</div>
    `;
    el.style.display = "block";
  }

  function renderDetails(){
    const p = resultPayload || {};
    const r = p.result || {};
    const name = p.studentName || "--";
    const dist = p.studentDistrict || p.studentAddress || p.address || "--";
    const test = p.modelTestName || "Model Test";
    const timeTakenText = p.timeTakenText || "--";

    $("detailTimeTaken").textContent = `Time: ${timeTakenText}`;

    $("sheetTitle").textContent = `${test} ‚Äî Details Sheet`;
    $("sheetSub").textContent = `${name} (${dist}) ‚Ä¢ Submitted: ${fmtTime(p.submittedAt)}`;

    $("sheetStats").innerHTML = buildStatBadges();
    renderMarkStamp();

    const mcqMap = getMcqMap(p);
    const wrMap = getWrittenMap(p);
    const letters = ["A","B","C","D"];

    if(!questions.length){
      $("detailContent").innerHTML = `<div class="err">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
      return;
    }

    const wrap = document.createElement("div");
    wrap.className = "qList";

    questions.forEach((q, i)=>{
      const qid = q.id;
      const qno = i + 1;
      const qt = getQText(q) || "(No question text)";

      const row = document.createElement("div");
      row.className = "qRow";
      row.innerHTML = `
        <div class="qHead">
          <span class="qNo">Q${qno}</span>
          <p class="qText">${esc(qt)}</p>
        </div>
      `;

      if(isWrittenQuestion(q)){
        const ans = (wrMap[qid] ?? "").toString().trim();
        const box = document.createElement("div");
        box.style.marginTop = "10px";
        box.style.padding = "10px 12px";
        box.style.border = "1px solid rgba(18,28,55,.12)";
        box.style.borderRadius = "12px";
        box.style.background = "rgba(255,255,255,.75)";
        box.innerHTML = `
          <div style="font-size:12px;color:var(--muted);font-weight:1000;">Your Answer (Written)</div>
          <div style="margin-top:6px;font-weight:900;line-height:1.6;">${esc(ans || "(No Answer)")}</div>
        `;
        row.appendChild(box);
        wrap.appendChild(row);
        return;
      }

      const opts = getOptions(q);
      const correctIdx = getCorrectIndex(q);
      const chosenIdx = Number(mcqMap[qid]);

      const hasChosen = Number.isFinite(chosenIdx) && chosenIdx >= 0;
      const hasCorrect = Number.isFinite(correctIdx) && correctIdx >= 0;

      const optWrap = document.createElement("div");
      optWrap.className = "opts";

      opts.slice(0,4).forEach((op, oi)=>{
        const isCorrect = (hasCorrect && oi === correctIdx);
        const isChosen = (hasChosen && oi === chosenIdx);

        let iconCls = "";
        let iconTxt = "";
        let txtCls = "";

        if(!hasChosen && isCorrect){
          iconCls = "warn"; iconTxt = "‚úì"; txtCls = "warn";
        }else if(hasChosen && isCorrect){
          iconCls = "ok"; iconTxt = "‚úì"; txtCls = "ok";
        }
        if(isChosen && !isCorrect){
          iconCls = "bad"; iconTxt = "‚úó"; txtCls = "bad";
        }

        const div = document.createElement("div");
        div.className = "optLine";
        div.innerHTML = `
          <span class="markIcon ${iconCls}">${iconTxt || ""}</span>
          <span class="optKey">${letters[oi]}.</span>
          <span class="optTxt ${txtCls}">${esc(op || "")}</span>
        `;
        optWrap.appendChild(div);
      });

      row.appendChild(optWrap);

      if(!hasChosen){
        const note = document.createElement("div");
        note.className = "noAnsText";
        note.textContent = "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§! ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø";
        row.appendChild(note);
      }

      wrap.appendChild(row);
    });

    $("detailContent").innerHTML = "";
    $("detailContent").appendChild(wrap);
  }

  async function openDetailsByResultId(resId){
    try{
      setUrlResultId(resId);

      $("detailContent").innerHTML = `<div class="loading">Details ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>`;
      openDetailsPopup();

      const doc = await db.collection(COL_RESULTS).doc(resId).get();
      if(!doc.exists){
        $("detailContent").innerHTML = `<div class="err">Result ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
        return;
      }

      resultPayload = { id: doc.id, ...doc.data() };

      // ‚úÖ ensure modelTestId is present
      if(!modelTestId && resultPayload.modelTestId){
        modelTestId = resultPayload.modelTestId;
      }

      // ‚úÖ keep highlight id for "see all result"
      highlightResultId = resId;

      await loadModelTestTitle();
      await loadQuestionsOnce();
      renderDetails();
    }catch(e){
      console.error(e);
      $("detailContent").innerHTML = `<div class="err">Details ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§</div>`;
    }
  }
  window.openDetailsByResultId = openDetailsByResultId;

  // ===== Load ranking table =====
  async function loadResultSheet(){
    try{
      const snap = await db.collection(COL_RESULTS)
        .where("modelTestId","==", modelTestId)
        .get();

      if(snap.empty){
        $("rankBody").innerHTML = `<tr><td colspan="11">‡¶è‡¶á modelTestId ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã result ‡¶®‡ßá‡¶á</td></tr>`;
        allRows = [];
        filteredRows = [];
        renderPage();
        return;
      }

      allRows = snap.docs.map(d => {
        const p = { id: d.id, ...d.data() };
        const r = p.result || {};
        const obtained = safeNum(r.obtainedMark, 0);
        const submittedAt = safeNum(p.submittedAt, Number.POSITIVE_INFINITY);

        const timeTakenText = p.timeTakenText || "";
        const timeTakenSec = parseTimeTakenTextToSeconds(timeTakenText);

        return { p, r, obtained, submittedAt, timeTakenSec };
      });

      // ‚úÖ Rank rule:
      // 1) obtainedMark DESC
      // 2) timeTakenSec ASC
      // 3) submittedAt ASC
      allRows.sort((a,b)=>{
        if(b.obtained !== a.obtained) return b.obtained - a.obtained;
        if(a.timeTakenSec !== b.timeTakenSec) return a.timeTakenSec - b.timeTakenSec;
        return a.submittedAt - b.submittedAt;
      });

      filteredRows = allRows.slice();
      page = 1;
      renderPage();
    }catch(e){
      console.error(e);
      $("rankBody").innerHTML = `<tr><td colspan="11">Result Sheet ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá</td></tr>`;
    }
  }

  // ===== ‚úÖ Model Test Title loader (now supports 3 meta sources) =====
  async function loadModelTestTitle(){
    try{
      // If details already open, trust payload name first
      const payloadName = resultPayload?.modelTestName;
      if(payloadName){
        $("modelTestTitle").textContent = payloadName;
        return;
      }

      if(!modelTestId){
        $("modelTestTitle").textContent = "Model Test";
        return;
      }

      const meta = await loadModelTestMeta(modelTestId);
      if(meta.doc){
        mtSource = meta.source;
        $("modelTestTitle").textContent = getTitleField(meta.doc);
        return;
      }

      // fallback
      $("modelTestTitle").textContent = "Model Test";
    }catch(e){
      $("modelTestTitle").textContent = resultPayload?.modelTestName || "Model Test";
    }
  }

  // ===== PDF helpers =====
  async function renderPageToCanvas(html){
    const area = $("pdfPageArea");
    area.innerHTML = html;
    try{ await document.fonts.ready; }catch(e){}
    return await html2canvas(area, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
  }

  function buildPdfMark(){
    const r = resultPayload?.result || {};
    const obtained = r.obtainedMark ?? "--";
    const total = r.totalMark ?? "--";
    const pf = getPassFail(r.obtainedMark, r.totalMark);
    return `
      <div class="pdfMark">
        <div class="score">${esc(obtained)} / ${esc(total)}</div>
        <div class="pf ${pf.ok === true ? "pass" : pf.ok === false ? "fail" : ""}">${esc(pf.label)}</div>
      </div>
    `;
  }

  function chunk(arr, size){
    const out = [];
    for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
    return out;
  }

  function buildPdfQuestionsHtml(qs, startNo){
    const p = resultPayload || {};
    const mcqMap = getMcqMap(p);
    const wrMap = getWrittenMap(p);
    const letters = ["A","B","C","D"];

    return qs.map((q, idx)=>{
      const qno = startNo + idx;
      const qt = getQText(q) || "(No question text)";
      const qid = q.id;

      if(isWrittenQuestion(q)){
        const ans = (wrMap[qid] ?? "").toString().trim();
        return `
          <div class="pdfQ">
            <div class="qline">Q${qno}. ${esc(qt)}</div>
            <div class="pdfOpt">
              <div class="dim" style="grid-column:1 / -1;">Your Answer: ${esc(ans || "(No Answer)")}</div>
            </div>
          </div>
        `;
      }

      const opts = getOptions(q);
      const correctIdx = getCorrectIndex(q);
      const chosenIdx = Number(mcqMap[qid]);
      const hasChosen = Number.isFinite(chosenIdx) && chosenIdx >= 0;
      const hasCorrect = Number.isFinite(correctIdx) && correctIdx >= 0;

      const optHtml = opts.slice(0,4).map((op, oi)=>{
        const isCorrect = (hasCorrect && oi === correctIdx);
        const isChosen = (hasChosen && oi === chosenIdx);

        let cls = "dim";
        let prefix = `${letters[oi]}. `;

        if(!hasChosen && isCorrect){
          cls = "warn"; prefix = `‚úì ${letters[oi]}. `;
        }else if(hasChosen && isCorrect){
          cls = "ok"; prefix = `‚úì ${letters[oi]}. `;
        }
        if(isChosen && !isCorrect){
          cls = "bad"; prefix = `‚úó ${letters[oi]}. `;
        }
        return `<div class="${cls}">${prefix}${esc(op || "")}</div>`;
      }).join("");

      const noAns = !hasChosen ? `<div class="pdfNoAns">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</div>` : ``;

      return `
        <div class="pdfQ">
          <div class="qline">Q${qno}. ${esc(qt)}</div>
          <div class="pdfOpt">${optHtml}</div>
          ${noAns}
        </div>
      `;
    }).join("");
  }

  function buildPdfPage1_DetailsLike(firstQs){
    const p = resultPayload || {};
    const r = p.result || {};
    const name = p.studentName || "--";
    const dist = p.studentDistrict || p.studentAddress || p.address || "--";
    const test = p.modelTestName || "Model Test";
    const timeTakenText = p.timeTakenText || "--";

    const right = r.right ?? "--";
    const wrong = r.wrong ?? "--";
    const noAns = calcNoAns(r);

    const qHtml = buildPdfQuestionsHtml(firstQs, 1);

    return `
      <div class="pdfFrame">
        <div class="pdfWatermark"><span>eProstutiBD</span></div>
        ${buildPdfMark()}

        <div class="pdfH1">${esc(test)} ‚Äî Details Sheet</div>
        <div class="pdfH2">${esc(name)} (${esc(dist)}) ‚Ä¢ Submitted: ${esc(fmtTime(p.submittedAt))} ‚Ä¢ Time: ${esc(timeTakenText)}</div>

        <div class="pdfStatsRow">
          <span class="pdfPill">Total: ${esc(r.totalQuestion ?? "--")} Q</span>
          <span class="pdfPill ok">‚úì Right: ${esc(right)}</span>
          <span class="pdfPill bad">‚úó Wrong: ${esc(wrong)}</span>
          <span class="pdfPill warn">No Ans: ${esc(noAns)}</span>
        </div>

        <div class="pdfQuestions">${qHtml}</div>

        <div class="pdfFooter">
          <span>eProstutiBD</span>
          <span>Questions</span>
        </div>
      </div>
    `;
  }

  function buildPdfQuestionsOnlyPage(qs, startNo, pageIndex, totalPages){
    const qHtml = buildPdfQuestionsHtml(qs, startNo);
    return `
      <div class="pdfFrame">
        <div class="pdfWatermark"><span>eProstutiBD</span></div>
        <div class="pdfQuestions" style="margin-top:0;">${qHtml}</div>
        <div class="pdfFooter">
          <span>Questions</span>
          <span>Page ${pageIndex} / ${totalPages}</span>
        </div>
      </div>
    `;
  }

  // ‚úÖ PDF: per page 20 questions
  const PDF_FIRST_PAGE_Q = 20;
  const PDF_NEXT_PAGE_Q  = 20;

  async function downloadResultPDF(){
    try{
      if(!resultPayload){
        alert("Details ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶ú‡¶®‡ßá‡¶∞ result ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }
      await loadQuestionsOnce();

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      let first = true;
      const addCanvas = (canvas)=>{
        const imgData = canvas.toDataURL("image/jpeg", 0.95);
        if(!first) pdf.addPage();
        first = false;
        pdf.addImage(imgData, "JPEG", 0, 0, pageW, pageH);
      };

      const firstChunk = questions.slice(0, PDF_FIRST_PAGE_Q);
      addCanvas(await renderPageToCanvas(buildPdfPage1_DetailsLike(firstChunk)));

      const rest = questions.slice(PDF_FIRST_PAGE_Q);
      const restChunks = chunk(rest, PDF_NEXT_PAGE_Q);

      const totalPages = 1 + restChunks.length;
      for(let i=0;i<restChunks.length;i++){
        const startNo = PDF_FIRST_PAGE_Q + (i * PDF_NEXT_PAGE_Q) + 1;
        addCanvas(await renderPageToCanvas(buildPdfQuestionsOnlyPage(restChunks[i], startNo, (i+2), totalPages)));
      }

      const testName = (resultPayload.modelTestName || "model-test").replace(/[\\/:*?"<>|]+/g, "_").trim();
      const name = (resultPayload.studentName || "student").replace(/[\\/:*?"<>|]+/g, "_").trim();
      pdf.save(`${testName}-${name}-result.pdf`);
    }catch(e){
      console.error(e);
      alert("PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ Console ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
    }
  }
  window.downloadResultPDF = downloadResultPDF;

  // ===== Boot =====
  async function boot(){
    // ‚úÖ if only resultId is provided, infer modelTestId from that result
    if(!modelTestId && resultIdFromUrl){
      try{
        const doc = await db.collection(COL_RESULTS).doc(resultIdFromUrl).get();
        if(doc.exists){
          const p = { id: doc.id, ...doc.data() };
          if(p.modelTestId) modelTestId = p.modelTestId;
        }
      }catch(e){}
    }

    if(!modelTestId && !resultIdFromUrl){
      $("modelTestTitle").textContent = "modelTestId ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø";
      $("rankBody").innerHTML = `<tr><td colspan="11">URL ‡¶è ‡¶¶‡¶ø‡¶®: result-sheet.html?modelTestId=XXXX ‡¶Ö‡¶•‡¶¨‡¶æ result-sheet.html?resultId=YYYY</td></tr>`;
      return;
    }

    $("fName").addEventListener("input", ()=> applyFilters());
    $("fZila").addEventListener("input", ()=> applyFilters());

    await loadModelTestTitle();

    if(modelTestId){
      await loadResultSheet();
      loadQuestionsOnce().catch(()=>{});
    }

    // ‚úÖ when coming from another page: jump + highlight 5 sec
    if(resultIdFromUrl){
      highlightResultId = resultIdFromUrl;
      setTimeout(()=>{ jumpToAndHighlightResult(resultIdFromUrl, true); }, 160);
    }
  }

  boot();
</script>

</body>
</html>
