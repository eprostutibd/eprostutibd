<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Result Sheet (Ranking) — eProstutiBD</title>

  <meta name="description" content="eProstutiBD Model Test Result Sheet — Ranking + Details + PDF" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#1d4ed8" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="https://www.gstatic.com" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

  <!-- Bengali + Handwriting-ish font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700;800;900;1000&family=Caveat:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f6f8ff; --bg2:#eef6ff;
      --line: rgba(18, 28, 55, .10);
      --text:#0f1730; --muted:#5a6685;

      --shadow2: 0 10px 26px rgba(15,23,48,.08);

      --ok:#16a34a;
      --danger:#dc2626;
      --warn:#f59e0b;

      --footTop:#0b1f3f;
      --footBottom:#07152e;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(800px 560px at 92% 14%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit}
    .srOnly{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding-left: clamp(8px, 2vw, 20px);
      padding-right: clamp(8px, 2vw, 20px);
      padding-top: 12px;
      padding-bottom: 18px;
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(135deg, rgba(29,78,216,.96), rgba(14,165,233,.92));
      border-bottom: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 34px rgba(29,78,216,.18);
    }
    .topbar{
      max-width: 1200px;
      margin:0 auto;
      padding: 10px clamp(8px, 2vw, 20px);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{display:flex;flex-direction:column;gap:3px;flex:0 0 auto;min-width:0;}
    .brand .name{color:#fff;font-weight:1000;letter-spacing:.2px;font-size:15px;line-height:1;white-space:nowrap;}
    .brand .tag{color:rgba(255,255,255,.88);font-size:12px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 520px;}

    nav.nav{display:flex;gap:8px;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;flex:1;}
    nav.nav::-webkit-scrollbar{display:none}
    nav.nav a{
      flex:0 0 auto;text-decoration:none;color:#fff;font-size:12px;font-weight:1000;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);white-space:nowrap;transition:.15s;
    }
    nav.nav a:hover{background: rgba(255,255,255,.16)}
    nav.nav a.active{background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.26)}

    .menuBtn{
      flex:0 0 auto;margin-left:auto;display:none;
      border:1px solid rgba(255,255,255,.22);background: rgba(255,255,255,.14);color:#fff;
      border-radius: 12px;padding: 8px 10px;font-weight:1000;font-size:12px;cursor:pointer;line-height:1;
    }
    @media (max-width: 860px){
      nav.nav{display:none;}
      .menuBtn{display:inline-flex;align-items:center;gap:8px;}
      .brand .tag{max-width: 55vw;}
    }

    .mobileMenu{display:none;position:fixed;inset:0;z-index:9999;}
    .mobileMenu .overlay{position:absolute;inset:0;background:transparent;}
    .mobileMenu .drawer{
      position:absolute;top:64px;right:12px;width:min(320px, calc(100vw - 24px));
      border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,.28);
      background: rgba(8, 20, 55, .78);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 38px rgba(0,0,0,.35);
    }
    .mobileMenu a{
      display:block;text-decoration:none;color:#fff;font-weight:1000;font-size:13px;
      padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);margin-bottom:8px;white-space:nowrap;
    }
    .mobileMenu a.active{border-color: rgba(255,255,255,.28);background: rgba(255,255,255,.12);}

    /* ===== Cards ===== */
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
    }
    .title{ margin:0; font-size: 18px; font-weight:1000; line-height:1.28; text-align:center; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 12.8px; font-weight: 900; line-height:1.55; text-align:center; }

    .tableWrap{
      margin-top: 12px;
      border:1px solid rgba(18,28,55,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 22px rgba(15,23,48,.04);
    }
    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(18,28,55,.08);
      font-size: 13px;
      vertical-align: top;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 1000;
      background: rgba(29,78,216,.06);
      white-space:nowrap;
    }
    td{
      font-weight: 1000;
      color: var(--text);
      background: rgba(255,255,255,.64);
    }
    tr:last-child td{border-bottom:none;}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:1000;
      border:1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.10); color: rgba(22,163,74,1);}
    .badge.bad{border-color: rgba(220,38,38,.22); background: rgba(220,38,38,.10); color: rgba(220,38,38,1);}
    .badge.warn{border-color: rgba(245,158,11,.24); background: rgba(245,158,11,.14); color: rgba(245,158,11,1);}

    .actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btn{
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 12.5px;
      font-weight: 1000;
      cursor:pointer;
      border: 1px solid rgba(29,78,216,.28);
      background: rgba(29,78,216,.12);
      color: rgba(29,78,216,1);
      box-shadow: 0 10px 22px rgba(15,23,48,.05);
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .btnGhost{
      border:1px solid rgba(18,28,55,.14);
      background: rgba(255,255,255,.70);
      color: var(--text);
    }
    .btnDanger{
      border:1px solid rgba(220,38,38,.28);
      background: rgba(220,38,38,.10);
      color: var(--danger);
    }

    /* ===== Details Sheet ===== */
    .detailSheet{ margin-top: 12px; display:none; }
    .detailSheet.show{display:block;}

    .paper{
      margin-top: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.96)),
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 26px,
          rgba(18,28,55,.055) 27px
        );
      border: 2px solid rgba(18,28,55,.14);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(15,23,48,.10);
      padding: 18px;
      position: relative;
      overflow:hidden;
    }
    .paperFrame{
      position: relative;
      z-index: 1;
      border: 1.6px solid rgba(18,28,55,.18);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255,255,255,.55);
      overflow:hidden;
      min-height: 220px;
    }

    /* ✅ top actions in details (Download moved UP) */
    .detailsTopBar{
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }

    /* ✅ details header centered */
    .sheetHead{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 8px;
      border-bottom: 1px solid rgba(18,28,55,.10);
      padding-bottom: 12px;
      margin-bottom: 12px;
      text-align:center;
    }
    .sheetTitle{ margin:0; font-size: 15px; font-weight: 1000; line-height:1.35; }
    .sheetSub{ margin:0; color: var(--muted); font-size: 12.5px; font-weight: 900; line-height:1.55; }
    .sheetStats{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; justify-content:center; }

    /* ✅ mark on LEFT, handwriting vibe + PASS/FAIL */
    .markStamp{
      position:absolute;
      top: 56px;          /* leave room for topbar */
      left: 14px;
      transform: rotate(-10deg);
      padding: 10px 12px 8px;
      border-radius: 12px;
      border: 2px solid rgba(15,23,48,.22);
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 24px rgba(15,23,48,.10);
      user-select:none;
      pointer-events:none;
      display:none;
      min-width: 150px;
    }
    .markStamp .score{
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 34px;
      font-weight: 700;
      letter-spacing: .6px;
      color: rgba(15,23,48,.92);
      line-height: 1.05;
      text-align:left;
    }
    .markStamp .pf{
      margin-top: 4px;
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .4px;
      text-align:left;
    }
    .markStamp .pf.pass{ color: rgba(22,163,74,.95); }
    .markStamp .pf.fail{ color: rgba(220,38,38,.95); }
    .markStamp .note{
      margin-top: 2px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(90,102,133,.9);
      text-align:left;
    }

    /* ✅ Web details: 1 column options so "1 page a sokol kisu thakbe" feel */
    .qList{
      display:block;
      border: 1px solid rgba(18,28,55,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.60);
    }
    .qRow{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(18,28,55,.08);
    }
    .qRow:last-child{border-bottom:none;}

    .qHead{display:flex;gap:10px;align-items:flex-start;}
    .qNo{
      flex:0 0 auto;
      font-size:12px;font-weight:1000;
      padding: 6px 9px;border-radius:999px;
      border: 1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.70);
      color: var(--muted);white-space:nowrap;
      transform: translateY(1px);
    }
    .qText{margin:0;font-weight:1000;font-size:14px;line-height:1.6;flex:1;}

    .opts{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;  /* ✅ 1 column */
      gap: 6px;
    }
    .optLine{
      display:grid;
      grid-template-columns: 20px 20px 1fr;
      gap: 8px;
      align-items:flex-start;
      padding: 2px 0;
      font-size: 13px;
      line-height: 1.55;
    }
    .markIcon{
      width:20px;height:20px;border-radius:999px;
      display:grid;place-items:center;
      font-weight:1000;
      font-size:12px;
      border: 1px solid rgba(18,28,55,.14);
      background: rgba(255,255,255,.70);
      color: transparent;
      transform: translateY(1px);
    }
    .markIcon.ok{
      border-color: rgba(22,163,74,.25);
      background: rgba(22,163,74,.10);
      color: rgba(22,163,74,1);
    }
    .markIcon.bad{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.10);
      color: rgba(220,38,38,1);
    }
    .markIcon.warn{
      border-color: rgba(245,158,11,.30);
      background: rgba(245,158,11,.16);
      color: rgba(245,158,11,1);
    }

    .optKey{font-weight:1000;color: var(--muted);}
    .optTxt{font-weight: 900;color: var(--text);}
    .optTxt.ok{color: rgba(22,163,74,1);}
    .optTxt.bad{color: rgba(220,38,38,1);}
    .optTxt.warn{color: rgba(245,158,11,1);}

    /* ✅ no answer note = just red text (no box) */
    .noAnsText{
      margin-top: 8px;
      font-weight: 1000;
      font-size: 13px;
      color: rgba(220,38,38,1);
    }

    .loading{color: var(--muted); font-weight:1000; font-size:13px;}
    .err{color: var(--danger); font-weight:1000; font-size:13px;}

    /* ===== PDF render area (offscreen) ===== */
    .pdfPageArea{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px; /* A4-ish */
      background:#fff;
      color:#111;
      padding: 16px;
      font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .pdfFrame{
      position: relative;
      border: 2px solid #111;
      padding: 14px;
      min-height: 1040px;
      background:#fff;
      overflow:hidden;
    }
    .pdfWatermark{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      user-select:none;
    }
    .pdfWatermark span{
      transform: rotate(-22deg);
      font-size: 84px;
      font-weight: 1000;
      letter-spacing: 2px;
      opacity: .08;
      color:#111;
      white-space:nowrap;
    }

    .pdfMark{
      position:absolute;
      top: 16px;
      left: 16px;
      transform: rotate(-10deg);
      padding: 8px 10px 6px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.35);
      background: rgba(255,255,255,.72);
      min-width: 140px;
    }
    .pdfMark .score{
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 30px;
      font-weight: 700;
      color:#111;
      line-height:1.05;
    }
    .pdfMark .pf{
      margin-top: 2px;
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 18px;
      font-weight: 700;
    }
    .pdfMark .pf.pass{ color: #16a34a; }
    .pdfMark .pf.fail{ color: #dc2626; }

    .pdfH1{text-align:center;font-weight:1000;font-size:16px;margin: 48px 0 2px;} /* leave space for mark */
    .pdfH2{text-align:center;font-weight:900;font-size:13px;margin: 0 0 10px;}
    .pdfMetaRow{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:12px;font-weight:900;margin: 6px 0 10px;
    }
    .pdfMetaRow span{white-space:nowrap;}

    /* PDF questions 2-column */
    .pdfQuestions{
      column-count: 2;
      column-gap: 16px;
      margin-top: 8px;
    }
    .pdfQ{
      break-inside: avoid;
      -webkit-column-break-inside: avoid;
      page-break-inside: avoid;
      font-size:12px;
      line-height:1.45;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px dashed rgba(0,0,0,.18);
    }
    .pdfQ .qline{font-weight:1000;margin-bottom: 4px;}
    .pdfOpt{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 10px;
      font-size:11.6px;
    }
    .pdfOpt .ok{color: #16a34a; font-weight:1000;}
    .pdfOpt .bad{color: #dc2626; font-weight:1000;}
    .pdfOpt .warn{color: #f59e0b; font-weight:1000;}
    .pdfOpt .dim{color: #111;}

    /* ✅ no answer note in PDF = red text (no box) */
    .pdfNoAns{
      margin-top: 4px;
      font-weight: 1000;
      color:#dc2626;
      font-size: 11.6px;
    }

    .pdfFooter{
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:11px;
      font-weight:900;
      opacity:.75;
    }

    /* ===== Footer ===== */
    footer{
      margin-top: 14px;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(900px 320px at 80% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--footTop), var(--footBottom));
      border-top: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
    }
    .footGrid{
      max-width: 1200px;
      margin:0 auto;
      padding: 18px clamp(8px, 2vw, 20px) 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px 18px;
      align-items:start;
    }
    .footTitle{font-weight:1000;color:#fff;font-size:13px;margin-bottom: 8px;}
    .footText{color: rgba(255,255,255,.70);font-size:12px;line-height:1.6;}
    .footLinks{display:flex;flex-direction:column;gap: 8px;}
    .footLinks a{text-decoration:none;color: rgba(255,255,255,.70);font-size:12px;}
    .footLinks a:hover{color:#fff;text-decoration:underline;text-underline-offset:4px;}
    .copy{
      max-width: 1200px;
      margin:0 auto;
      padding: 12px clamp(8px, 2vw, 20px) 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.68);
      font-size:12px;
      text-align:center;
      line-height:1.6;
      white-space:normal;
    }
    @media (max-width: 980px){
      .footGrid{grid-template-columns: repeat(2, minmax(0, 1fr));gap: 10px 10px;}
    }
  </style>
</head>

<body>
  <h1 class="srOnly">Model Test Result Sheet</h1>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="name">eProstutiBD</div>
        <div class="tag" id="headerTag">Result Sheet (Ranking)</div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="#">একাডেমী</a>
        <a href="#">প্রশ্ন ব্যাঙ্ক</a>
        <a href="#">এডমিশন অ্যাসিস্ট্যান্ট</a>
        <a href="#">জব অ্যাসিস্ট্যান্ট</a>
        <a class="active" href="#" aria-current="page">মডেল টেস্ট</a>
        <a href="#">কারেন্ট এফেয়ার্স</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">নোটিশ</a>
        <a href="#">ব্লগ</a>
        <a href="#">ক্যারিয়ার</a>
      </nav>

      <button class="menuBtn" id="menuBtn" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu" onclick="toggleMenu()">☰</button>
    </div>

    <div class="mobileMenu" id="mobileMenu">
      <div class="overlay" onclick="closeMenu()"></div>
      <div class="drawer" role="dialog" aria-label="Menu" onclick="event.stopPropagation()">
        <a href="#">একাডেমী</a>
        <a href="#">প্রশ্ন ব্যাঙ্ক</a>
        <a href="#">এডমিশন অ্যাসিস্ট্যান্ট</a>
        <a href="#">জব অ্যাসিস্ট্যান্ট</a>
        <a class="active" href="#" aria-current="page">মডেল টেস্ট</a>
        <a href="#">কারেন্ট এফেয়ার্স</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">নোটিশ</a>
        <a href="#">ব্লগ</a>
        <a href="#">ক্যারিয়ার</a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- ONLY ONE BOX: Result Sheet (Ranking) -->
    <section class="card" aria-label="Result sheet">
      <h2 class="title" id="pageTitle">Result Sheet (Ranking)</h2>
      <p class="sub" id="rankSub">সব রেজাল্ট লোড হচ্ছে…</p>

      <div class="tableWrap" style="overflow:auto;">
        <table style="min-width:1100px;">
          <thead>
            <tr>
              <th style="width:60px;">Rank</th>
              <th>Name</th>
              <th>Address</th>
              <th>Model test name</th>
              <th style="width:180px;">Submit date &amp; time</th>
              <th style="width:90px;">Right</th>
              <th style="width:90px;">Wrong</th>
              <th style="width:90px;">No Ans</th>
              <th style="width:90px;">Mark</th>
              <th style="width:90px;">Details</th>
            </tr>
          </thead>
          <tbody id="rankBody">
            <tr><td colspan="10">লোড হচ্ছে…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btnGhost btn" type="button" onclick="backToTest()">Back to Test</button>
      </div>
    </section>

    <!-- DETAILS (Only shows after clicking Details) -->
    <section class="detailSheet" id="detailSheet" aria-label="Details sheet">
      <article class="paper">
        <div class="paperFrame" id="paperFrame">
          <!-- ✅ Download moved UP -->
          <div class="detailsTopBar">
            <button class="btn btnDanger" type="button" onclick="downloadResultPDF()">Download Result PDF</button>
          </div>

          <div class="markStamp" id="markStamp"></div>

          <div class="sheetHead">
            <div>
              <p class="sheetTitle" id="sheetTitle">Details</p>
              <p class="sheetSub" id="sheetSub">—</p>
            </div>
            <div class="sheetStats" id="sheetStats"></div>
          </div>

          <div id="detailContent">
            <div class="loading">প্রশ্ন লোড হচ্ছে…</div>
          </div>

          <div class="actions" style="margin-top:14px;">
            <button class="btnGhost btn" type="button" onclick="closeDetails()">Close</button>
          </div>
        </div>
      </article>
    </section>
  </div>

  <!-- hidden offscreen for PDF rendering -->
  <div class="pdfPageArea" id="pdfPageArea" aria-hidden="true"></div>

  <footer>
    <div class="footGrid">
      <div>
        <div class="footTitle">eProstutiBD</div>
        <div class="footText">সকল প্রস্তুতি হোক গভীর থেকে</div>
      </div>

      <div>
        <div class="footTitle">দরকারি পেজ</div>
        <div class="footLinks">
          <a href="#">About</a>
          <a href="#">Privacy Policy</a>
          <a href="#">Terms</a>
          <a href="#">Contact</a>
        </div>
      </div>

      <div>
        <div class="footTitle">অন্যান্য</div>
        <div class="footLinks">
          <a href="#">Notice</a>
          <a href="#">Blog</a>
          <a href="#">Career</a>
          <a href="#">Help</a>
        </div>
      </div>

      <div>
        <div class="footTitle">Support</div>
        <div class="footText">প্রশ্ন থাকলে Help সেকশনে যান বা Contact করুন।</div>
      </div>
    </div>

    <div class="copy">© <span id="year"></span> eProstutiBD — All rights reserved</div>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    const $ = (id)=>document.getElementById(id);

    // ===== menu =====
    function openMenu(){ $("mobileMenu").style.display="block"; $("menuBtn").setAttribute("aria-expanded","true"); }
    function closeMenu(){ $("mobileMenu").style.display="none"; $("menuBtn").setAttribute("aria-expanded","false"); }
    function toggleMenu(){ const m=$("mobileMenu"); (m.style.display==="block")?closeMenu():openMenu(); }
    window.toggleMenu = toggleMenu;
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

    // ===== utils =====
    function esc(str){
      return String(str ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }
    function fmtTime(ms){
      const n = Number(ms);
      if(!Number.isFinite(n) || n <= 0) return "--";
      return new Date(n).toLocaleString("bn-BD", { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function safeNum(x, fallback){
      const n = Number(x);
      return Number.isFinite(n) ? n : fallback;
    }

    function setUrlResultId(resId){
      const u = new URL(location.href);
      u.searchParams.set("modelTestId", modelTestId);
      u.searchParams.set("resultId", resId);
      history.replaceState({}, "", u.toString());
    }
    function clearUrlResultId(){
      const u = new URL(location.href);
      u.searchParams.delete("resultId");
      history.replaceState({}, "", u.toString());
    }

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
      authDomain: "eprostutibd-webapp.firebaseapp.com",
      projectId: "eprostutibd-webapp",
      storageBucket: "eprostutibd-webapp.firebasestorage.app",
      messagingSenderId: "1044069942330",
      appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
      measurementId: "G-T2G55NMDQT"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const COL_RESULTS = "model_test_result";
    const COL_MODELTESTS = "subject_model_tests";
    const QUESTION_COLLECTION_CANDIDATES = [
      "modeltest_questions","model_test_questions","modeltest_question","modelTest_questions","modeltestQuestions"
    ];

    const modelTestId = getParam("modelTestId");
    const resultIdFromUrl = getParam("resultId");

    // ===== state =====
    let resultPayload = null;
    let questions = [];

    // ===== Back =====
    function backToTest(){
      if(!modelTestId) location.href = "Start-model-test.html";
      else location.href = `Start-model-test.html?modelTestId=${encodeURIComponent(modelTestId)}`;
    }
    window.backToTest = backToTest;

    // ===== reading answers (object) =====
    function getMcqMap(p){
      const o = p?.answers?.mcq;
      if(o && typeof o === "object" && !Array.isArray(o)) return o;
      if(Array.isArray(p?.answers?.mcq)){
        const out = {};
        try{ p.answers.mcq.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
        return out;
      }
      return {};
    }
    function getWrittenMap(p){
      const o = p?.answers?.written;
      if(o && typeof o === "object" && !Array.isArray(o)) return o;
      if(Array.isArray(p?.answers?.written)){
        const out = {};
        try{ p.answers.written.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
        return out;
      }
      return {};
    }

    // ===== question helpers =====
    function getQText(q){
      return (q.question ?? q.questionText ?? q.q ?? q.title ?? q.name ?? q.ques ?? q.qus ?? q.question_title ?? "").toString();
    }
    function getOptions(q){
      if(Array.isArray(q.options) && q.options.length) return q.options.slice(0,4).map(x=>String(x ?? ""));
      if(Array.isArray(q.choices) && q.choices.length) return q.choices.slice(0,4).map(x=>String(x ?? ""));
      if(Array.isArray(q.opts) && q.opts.length) return q.opts.slice(0,4).map(x=>String(x ?? ""));
      const o1 = q.option1 ?? q.opt1 ?? q.a ?? q.A ?? q.optionA ?? q.optA ?? q.choiceA;
      const o2 = q.option2 ?? q.opt2 ?? q.b ?? q.B ?? q.optionB ?? q.optB ?? q.choiceB;
      const o3 = q.option3 ?? q.opt3 ?? q.c ?? q.C ?? q.optionC ?? q.optC ?? q.choiceC;
      const o4 = q.option4 ?? q.opt4 ?? q.d ?? q.D ?? q.optionD ?? q.optD ?? q.choiceD;
      return [o1,o2,o3,o4].map(x=>String(x ?? ""));
    }
    function getCorrectIndex(q){
      const v = Number(q.correctIndex);
      return Number.isFinite(v) ? v : -1;
    }
    function isWrittenQuestion(q){
      const t = (q.type ?? q.qType ?? q.questionType ?? q.kind ?? "").toString().toLowerCase();
      return t === "written" || t === "cq" || t === "short" || t === "essay";
    }

    async function fetchQuestionsFromCollection(colName, mtId){
      try{
        const s = await db.collection(colName).where("modelTestId","==", mtId).orderBy("createdAt","asc").get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){
        const s = await db.collection(colName).where("modelTestId","==", mtId).get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }
    }
    async function fetchQuestionsFromSubcollection(mtId){
      const ref = db.collection(COL_MODELTESTS).doc(mtId).collection("questions");
      try{
        const s = await ref.orderBy("createdAt","asc").get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){
        const s = await ref.get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }
    }

    async function loadQuestionsOnce(){
      if(questions.length) return questions;
      let qs = [];
      for(const col of QUESTION_COLLECTION_CANDIDATES){
        try{
          const got = await fetchQuestionsFromCollection(col, modelTestId);
          if(got && got.length){ qs = got; break; }
        }catch(e){}
      }
      if(!qs.length){
        try{ qs = await fetchQuestionsFromSubcollection(modelTestId); }catch(e){}
      }
      questions = qs || [];
      return questions;
    }

    // ===== rank helpers =====
    function calcNoAns(r){
      const totalQ = safeNum(r?.totalQuestion, NaN);
      const right = safeNum(r?.right, NaN);
      const wrong = safeNum(r?.wrong, NaN);

      if(Number.isFinite(safeNum(r?.noAnswer, NaN))) return safeNum(r?.noAnswer, 0);
      if(Number.isFinite(totalQ) && Number.isFinite(right) && Number.isFinite(wrong)){
        const na = totalQ - (right + wrong);
        return na >= 0 ? na : 0;
      }
      return "--";
    }

    function getPassFail(obtained, total){
      const o = safeNum(obtained, 0);
      const t = safeNum(total, 0);
      if(t <= 0) return { ok: null, label: "—" };
      const pct = (o / t) * 100;
      if(pct < 30) return { ok: false, label: "FAIL" };
      return { ok: true, label: "PASS" };
    }

    // ===== Details open/close =====
    function openDetails(){
      $("detailSheet").classList.add("show");
      try{ window.scrollTo({ top: $("detailSheet").offsetTop - 20, behavior:"smooth" }); }catch(e){}
    }
    function closeDetails(){
      $("detailSheet").classList.remove("show");
      $("markStamp").style.display = "none";
      clearUrlResultId();
      try{ window.scrollTo({ top: 0, behavior:"smooth" }); }catch(e){}
    }
    window.closeDetails = closeDetails;

    function buildStatBadges(){
      const r = resultPayload?.result || {};
      const right = (r.right ?? "--");
      const wrong = (r.wrong ?? "--");
      const totalQ = (r.totalQuestion ?? "--");
      const noAns = calcNoAns(r);
      return `
        <span class="badge">${esc(totalQ)} Q</span>
        <span class="badge ok">✓ ${esc(right)} Right</span>
        <span class="badge bad">✗ ${esc(wrong)} Wrong</span>
        <span class="badge warn">${esc(noAns)} No Ans</span>
      `;
    }

    function renderMarkStamp(){
      const r = resultPayload?.result || {};
      const obtained = (r.obtainedMark ?? "--");
      const total = (r.totalMark ?? "--");

      const pf = getPassFail(r.obtainedMark, r.totalMark);

      const el = $("markStamp");
      el.innerHTML = `
        <div class="score">${esc(obtained)} / ${esc(total)}</div>
        <div class="pf ${pf.ok === true ? "pass" : pf.ok === false ? "fail" : ""}">${esc(pf.label)}</div>
        <div class="note">Teacher Checked</div>
      `;
      el.style.display = "block";
    }

    function renderDetails(){
      const p = resultPayload || {};
      const r = p.result || {};
      const name = p.studentName || "--";
      const dist = p.studentDistrict || p.studentAddress || p.address || "--";
      const test = p.modelTestName || "Model Test";

      $("headerTag").textContent = `${test} • Result Sheet`;
      $("sheetTitle").textContent = `${test} — Details Sheet`;
      $("sheetSub").textContent = `${name} (${dist}) • Submitted: ${fmtTime(p.submittedAt)}`;

      $("sheetStats").innerHTML = buildStatBadges();
      renderMarkStamp();

      const mcqMap = getMcqMap(p);
      const wrMap = getWrittenMap(p);
      const letters = ["A","B","C","D"];

      if(!questions.length){
        $("detailContent").innerHTML = `<div class="err">কোনো প্রশ্ন পাওয়া যায়নি।</div>`;
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "qList";

      questions.forEach((q, i)=>{
        const qid = q.id;
        const qno = i + 1;
        const qt = getQText(q) || "(No question text)";

        const row = document.createElement("div");
        row.className = "qRow";
        row.innerHTML = `
          <div class="qHead">
            <span class="qNo">Q${qno}</span>
            <p class="qText">${esc(qt)}</p>
          </div>
        `;

        if(isWrittenQuestion(q)){
          const ans = (wrMap[qid] ?? "").toString().trim();
          const box = document.createElement("div");
          box.style.marginTop = "10px";
          box.style.padding = "10px 12px";
          box.style.border = "1px solid rgba(18,28,55,.12)";
          box.style.borderRadius = "12px";
          box.style.background = "rgba(255,255,255,.75)";
          box.innerHTML = `
            <div style="font-size:12px;color:var(--muted);font-weight:1000;">Your Answer (Written)</div>
            <div style="margin-top:6px;font-weight:900;line-height:1.6;">${esc(ans || "(No Answer)")}</div>
          `;
          row.appendChild(box);
          wrap.appendChild(row);
          return;
        }

        const opts = getOptions(q);
        const correctIdx = getCorrectIndex(q);
        const chosenIdx = Number(mcqMap[qid]);

        const hasChosen = Number.isFinite(chosenIdx) && chosenIdx >= 0;
        const hasCorrect = Number.isFinite(correctIdx) && correctIdx >= 0;

        const optWrap = document.createElement("div");
        optWrap.className = "opts";

        opts.slice(0,4).forEach((op, oi)=>{
          const isCorrect = (hasCorrect && oi === correctIdx);
          const isChosen = (hasChosen && oi === chosenIdx);

          let iconCls = "";
          let iconTxt = "";
          let txtCls = "";

          // rule:
          // - no answer => correct yellow
          // - answered => correct green
          // - chosen wrong => chosen red
          if(!hasChosen && isCorrect){
            iconCls = "warn"; iconTxt = "✓"; txtCls = "warn";
          }else if(hasChosen && isCorrect){
            iconCls = "ok"; iconTxt = "✓"; txtCls = "ok";
          }
          if(isChosen && !isCorrect){
            iconCls = "bad"; iconTxt = "✗"; txtCls = "bad";
          }

          const div = document.createElement("div");
          div.className = "optLine";
          div.innerHTML = `
            <span class="markIcon ${iconCls}">${iconTxt || ""}</span>
            <span class="optKey">${letters[oi]}.</span>
            <span class="optTxt ${txtCls}">${esc(op || "")}</span>
          `;
          optWrap.appendChild(div);
        });

        row.appendChild(optWrap);

        if(!hasChosen){
          const note = document.createElement("div");
          note.className = "noAnsText";
          note.textContent = "আপনি কোনো উত্তর সিলেক্ট করেননি।";
          row.appendChild(note);
        }

        wrap.appendChild(row);
      });

      $("detailContent").innerHTML = "";
      $("detailContent").appendChild(wrap);
    }

    async function openDetailsByResultId(resId){
      try{
        setUrlResultId(resId);

        $("detailContent").innerHTML = `<div class="loading">Details লোড হচ্ছে…</div>`;
        openDetails();

        const doc = await db.collection(COL_RESULTS).doc(resId).get();
        if(!doc.exists){
          $("detailContent").innerHTML = `<div class="err">Result পাওয়া যায়নি।</div>`;
          return;
        }

        resultPayload = { id: doc.id, ...doc.data() };
        await loadQuestionsOnce();
        renderDetails();
      }catch(e){
        console.error(e);
        $("detailContent").innerHTML = `<div class="err">Details লোড করতে সমস্যা হচ্ছে।</div>`;
      }
    }
    window.openDetailsByResultId = openDetailsByResultId;

    // ===== Load ranking table =====
    async function loadResultSheet(){
      try{
        $("rankSub").textContent = "সব রেজাল্ট লোড হচ্ছে…";

        const snap = await db.collection(COL_RESULTS)
          .where("modelTestId","==", modelTestId)
          .get();

        if(snap.empty){
          $("rankBody").innerHTML = `<tr><td colspan="10">এই modelTestId এর কোনো result নেই</td></tr>`;
          $("rankSub").textContent = "কোনো রেজাল্ট পাওয়া যায়নি";
          return;
        }

        let rows = snap.docs.map(d => {
          const p = { id: d.id, ...d.data() };
          const r = p.result || {};
          const obtained = safeNum(r.obtainedMark, 0);
          const submittedAt = safeNum(p.submittedAt, Number.POSITIVE_INFINITY);
          return { p, r, obtained, submittedAt };
        });

        // Rank rule: Mark desc, (tie) SubmittedAt asc
        rows.sort((a,b)=>{
          if(b.obtained !== a.obtained) return b.obtained - a.obtained;
          return a.submittedAt - b.submittedAt;
        });

        const html = rows.map((x, idx)=>{
          const p = x.p, r = x.r;
          const name = p.studentName || "--";
          const addr = p.studentDistrict || p.studentAddress || p.address || "--";
          const test = p.modelTestName || "--";
          const submitted = fmtTime(p.submittedAt);

          const right = (r.right ?? "--");
          const wrong = (r.wrong ?? "--");
          const noAns = calcNoAns(r);
          const mark = (r.obtainedMark ?? x.obtained ?? "--");

          return `
            <tr>
              <td><span class="badge">${idx+1}</span></td>
              <td style="white-space:nowrap;">${esc(name)}</td>
              <td style="white-space:nowrap;">${esc(addr)}</td>
              <td style="white-space:nowrap;">${esc(test)}</td>
              <td style="white-space:nowrap;">${esc(submitted)}</td>
              <td>${esc(right)}</td>
              <td>${esc(wrong)}</td>
              <td>${esc(noAns)}</td>
              <td><span class="badge warn">${esc(mark)}</span></td>
              <td>
                <button class="btn" style="padding:6px 10px;font-size:12px;"
                  type="button" onclick="openDetailsByResultId('${esc(p.id)}')">Details</button>
              </td>
            </tr>
          `;
        }).join("");

        $("rankBody").innerHTML = html;
        $("rankSub").textContent = `মোট রেজাল্ট: ${rows.length} • Rank: Mark ↓, Submit ↑`;
      }catch(e){
        console.error(e);
        $("rankBody").innerHTML = `<tr><td colspan="10">Result Sheet লোড করতে সমস্যা হচ্ছে</td></tr>`;
        $("rankSub").textContent = "Error";
      }
    }

    // ===== PDF =====
    function chunk(arr, size){
      const out = [];
      for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
      return out;
    }

    async function renderPageToCanvas(html){
      const area = $("pdfPageArea");
      area.innerHTML = html;
      try{ await document.fonts.ready; }catch(e){}
      return await html2canvas(area, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
    }

    function buildPdfMark(){
      const r = resultPayload?.result || {};
      const obtained = r.obtainedMark ?? "--";
      const total = r.totalMark ?? "--";
      const pf = getPassFail(r.obtainedMark, r.totalMark);
      return `
        <div class="pdfMark">
          <div class="score">${esc(obtained)} / ${esc(total)}</div>
          <div class="pf ${pf.ok === true ? "pass" : pf.ok === false ? "fail" : ""}">${esc(pf.label)}</div>
        </div>
      `;
    }

    function buildMarkedQuestionPages(){
      const p = resultPayload || {};
      const r = p.result || {};
      const name = p.studentName || "--";
      const dist = p.studentDistrict || p.studentAddress || p.address || "--";
      const test = p.modelTestName || "--";

      const mcqMap = getMcqMap(p);
      const wrMap = getWrittenMap(p);
      const letters = ["A","B","C","D"];

      const pages = chunk(questions, 26);

      return pages.map((pageQs, pageIndex)=>{
        const qHtml = pageQs.map((q, idx)=>{
          const qno = pageIndex * 26 + idx + 1;
          const qt = getQText(q) || "(No question text)";
          const qid = q.id;

          if(isWrittenQuestion(q)){
            const ans = (wrMap[qid] ?? "").toString().trim();
            return `
              <div class="pdfQ">
                <div class="qline">Q${qno}. ${esc(qt)}</div>
                <div class="pdfOpt">
                  <div class="dim" style="grid-column:1 / -1;">Your Answer: ${esc(ans || "(No Answer)")}</div>
                </div>
              </div>
            `;
          }

          const opts = getOptions(q);
          const correctIdx = getCorrectIndex(q);
          const chosenIdx = Number(mcqMap[qid]);
          const hasChosen = Number.isFinite(chosenIdx) && chosenIdx >= 0;
          const hasCorrect = Number.isFinite(correctIdx) && correctIdx >= 0;

          const optHtml = opts.slice(0,4).map((op, oi)=>{
            const isCorrect = (hasCorrect && oi === correctIdx);
            const isChosen = (hasChosen && oi === chosenIdx);

            let cls = "dim";
            let prefix = `${letters[oi]}. `;

            if(!hasChosen && isCorrect){
              cls = "warn"; prefix = `✓ ${letters[oi]}. `;
            }else if(hasChosen && isCorrect){
              cls = "ok"; prefix = `✓ ${letters[oi]}. `;
            }
            if(isChosen && !isCorrect){
              cls = "bad"; prefix = `✗ ${letters[oi]}. `;
            }

            return `<div class="${cls}">${prefix}${esc(op || "")}</div>`;
          }).join("");

          const noAns = !hasChosen ? `<div class="pdfNoAns">আপনি কোনো উত্তর সিলেক্ট করেননি।</div>` : ``;

          return `
            <div class="pdfQ">
              <div class="qline">Q${qno}. ${esc(qt)}</div>
              <div class="pdfOpt">${optHtml}</div>
              ${noAns}
            </div>
          `;
        }).join("");

        return `
          <div class="pdfFrame">
            <div class="pdfWatermark"><span>eProstutiBD</span></div>
            ${buildPdfMark()}

            <div class="pdfH1">${esc(test)} — Marked Question Paper</div>
            <div class="pdfH2">${esc(name)} (${esc(dist)}) • Submitted: ${esc(fmtTime(p.submittedAt))}</div>

            <div class="pdfMetaRow">
              <span>Total Q: ${esc(r.totalQuestion ?? "--")} • Right: ${esc(r.right ?? "--")} • Wrong: ${esc(r.wrong ?? "--")} • No Ans: ${esc(calcNoAns(r))}</span>
              <span>Page: ${pageIndex+1} / ${pages.length}</span>
            </div>

            <div class="pdfQuestions">${qHtml}</div>

            <div class="pdfFooter">
              <span>eProstutiBD</span>
              <span>ModelTestId: ${esc(modelTestId || "--")}</span>
            </div>
          </div>
        `;
      });
    }

    async function downloadResultPDF(){
      try{
        if(!resultPayload){
          alert("Details থেকে একজনের result খুলে তারপর PDF ডাউনলোড করুন।");
          return;
        }
        await loadQuestionsOnce();

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "pt", "a4");
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        let first = true;
        const addCanvas = (canvas)=>{
          const imgData = canvas.toDataURL("image/jpeg", 0.95);
          if(!first) pdf.addPage();
          first = false;
          pdf.addImage(imgData, "JPEG", 0, 0, pageW, pageH);
        };

        // ✅ Requirement #5: no separate first summary page
        for(const html of buildMarkedQuestionPages()){
          addCanvas(await renderPageToCanvas(html));
        }

        const testName = (resultPayload.modelTestName || "model-test").replace(/[\\/:*?"<>|]+/g, "_").trim();
        const name = (resultPayload.studentName || "student").replace(/[\\/:*?"<>|]+/g, "_").trim();
        pdf.save(`${testName}-${name}-result.pdf`);
      }catch(e){
        console.error(e);
        alert("PDF তৈরি করতে সমস্যা হচ্ছে। Console দেখুন।");
      }
    }
    window.downloadResultPDF = downloadResultPDF;

    // ===== Boot =====
    async function boot(){
      if(!modelTestId){
        $("pageTitle").textContent = "modelTestId পাওয়া যায়নি";
        $("rankSub").textContent = "URL এ দিন: model-test-reasult.html?modelTestId=XXXX";
        $("rankBody").innerHTML = `<tr><td colspan="10">Invalid URL</td></tr>`;
        return;
      }

      loadResultSheet();
      loadQuestionsOnce().catch(()=>{});

      // shareable link: auto open
      if(resultIdFromUrl){
        openDetailsByResultId(resultIdFromUrl);
      }
    }

    boot();
  </script>
</body>
</html>
