<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Result Sheet (Ranking) — eProstutiBD</title>

  <meta name="description" content="eProstutiBD Model Test Result Sheet — Ranking + Filters + Popup Details + PDF" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#1d4ed8" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="https://www.gstatic.com" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700;800;900;1000&family=Caveat:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f6f8ff; --bg2:#eef6ff;
      --line: rgba(18, 28, 55, .10);
      --text:#0f1730; --muted:#5a6685;
      --shadow2: 0 10px 26px rgba(15,23,48,.08);
      --ok:#16a34a;
      --danger:#dc2626;
      --warn:#f59e0b;
      --footTop:#0b1f3f;
      --footBottom:#07152e;

      /* ✅ compact */
      --tblFont: 12px;
      --tblPadY: 9px;
      --tblPadX: 10px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Bengali", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(800px 560px at 92% 14%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit}
    .srOnly{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .container{
      max-width: 1780px;
      margin: 0 auto;
      --pad: clamp(10px, 2vw, 24px);
      padding: 12px var(--pad) 18px;
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(135deg, rgba(29,78,216,.96), rgba(14,165,233,.92));
      border-bottom: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 34px rgba(29,78,216,.18);
    }
    .topbar{
      max-width: 1780px;
      margin:0 auto;
      padding: 10px clamp(8px, 2vw, 20px);
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* ✅ Center header items (desktop) */
    .topbar{
      justify-content:center;
    }
    .brand{
      display:flex;flex-direction:column;gap:3px;
      min-width:0;
      align-items:center; /* ✅ center */
      text-align:center;  /* ✅ center */
      flex:0 0 auto;
    }
    .brand .name{color:#fff;font-weight:1000;letter-spacing:.2px;font-size:15px;line-height:1;white-space:nowrap;}
    .brand .tag{color:rgba(255,255,255,.88);font-size:12px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 520px;}

    nav.nav{
      display:flex;gap:8px;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;
      flex:1;
      justify-content:center; /* ✅ center */
    }
    nav.nav::-webkit-scrollbar{display:none}
    nav.nav a{
      flex:0 0 auto;text-decoration:none;color:#fff;font-size:12px;font-weight:1000;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);white-space:nowrap;transition:.15s;
    }
    nav.nav a:hover{background: rgba(255,255,255,.16)}
    nav.nav a.active{background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.26)}

    .menuBtn{
      flex:0 0 auto;
      margin-left:auto;
      display:none;
      border:1px solid rgba(255,255,255,.22);background: rgba(255,255,255,.14);color:#fff;
      border-radius: 12px;padding: 8px 10px;font-weight:1000;font-size:12px;cursor:pointer;line-height:1;
    }
    @media (max-width: 860px){
      .topbar{justify-content:space-between;} /* ✅ mobile normal */
      nav.nav{display:none;}
      .menuBtn{display:inline-flex;align-items:center;gap:8px;}
      .brand{align-items:flex-start;text-align:left;}
      .brand .tag{max-width: 55vw;}
    }

    .mobileMenu{display:none;position:fixed;inset:0;z-index:9999;}
    .mobileMenu .overlay{position:absolute;inset:0;background:transparent;}
    .mobileMenu .drawer{
      position:absolute;top:64px;right:12px;width:min(320px, calc(100vw - 24px));
      border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,.28);
      background: rgba(8, 20, 55, .78);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 38px rgba(0,0,0,.35);
      max-height: calc(100vh - 84px);
      overflow:auto;
    }
    .mobileMenu a{
      display:block;text-decoration:none;color:#fff;font-weight:1000;font-size:13px;
      padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);margin-bottom:8px;white-space:nowrap;
    }
    .mobileMenu a.active{border-color: rgba(255,255,255,.28);background: rgba(255,255,255,.12);}

    /* ===== Cards ===== */
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
    }
    .title{ margin:0; font-size: 18px; font-weight:1000; line-height:1.28; text-align:center; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 12.5px; font-weight: 900; line-height:1.55; text-align:center; }

    /* ✅ Table: ALWAYS allow scroll if needed (desktop + mobile) */
    .tableWrap{
      margin-top: 12px;
      border:1px solid rgba(18,28,55,.10);
      border-radius: 16px;
      overflow:auto;                /* ✅ important */
      -webkit-overflow-scrolling:touch;
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 22px rgba(15,23,48,.04);
    }

    table{
      width:100%;
      min-width: 1220px;            /* ✅ ensures Details column exists */
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td{
      padding: var(--tblPadY) var(--tblPadX);
      border-bottom: 1px solid rgba(18,28,55,.08);
      font-size: var(--tblFont);
      vertical-align: top;
      overflow-wrap:anywhere;
      word-break: break-word;
    }
    th{
      color: var(--muted);
      font-weight: 1000;
      background: rgba(29,78,216,.06);
      text-align:center;            /* ✅ center table headers */
      white-space:nowrap;
    }
    td{
      font-weight: 1000;
      color: var(--text);
      background: rgba(255,255,255,.64);
      text-align:center;
    }
    /* ✅ keep name/address a bit readable */
    td.colName, td.colAddr{ text-align:left; }

    tr:last-child td{border-bottom:none;}

    /* ✅ Column widths (keep Details visible) */
    th:nth-child(1), td:nth-child(1){width:60px;}
    th:nth-child(2), td:nth-child(2){width:170px;}
    th:nth-child(3), td:nth-child(3){width:190px;}
    th:nth-child(4), td:nth-child(4){width:120px;} /* date only */
    th:nth-child(5), td:nth-child(5),
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7){width:74px;}
    th:nth-child(8), td:nth-child(8){width:80px;}
    th:nth-child(9), td:nth-child(9){width:110px;}
    th:nth-child(10), td:nth-child(10){width:90px;}
    th:nth-child(11), td:nth-child(11){width:120px;} /* ✅ Details */

    /* ✅ Zebra rows */
    #rankBody tr:nth-child(odd) td{ background: rgba(22,163,74,.06) !important; }
    #rankBody tr:nth-child(even) td{ background: rgba(255,255,255,.70) !important; }

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:1000;
      border:1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.10); color: rgba(22,163,74,1);}
    .badge.bad{border-color: rgba(220,38,38,.22); background: rgba(220,38,38,.10); color: rgba(220,38,38,1);}
    .badge.warn{border-color: rgba(245,158,11,.24); background: rgba(245,158,11,.14); color: rgba(245,158,11,1);}

    .btn{
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 12.5px;
      font-weight: 1000;
      cursor:pointer;
      border: 1px solid rgba(29,78,216,.28);
      background: rgba(29,78,216,.12);
      color: rgba(29,78,216,1);
      box-shadow: 0 10px 22px rgba(15,23,48,.05);
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .btnGhost{ border:1px solid rgba(18,28,55,.14); background: rgba(255,255,255,.70); color: var(--text); }
    .btnDanger{ border:1px solid rgba(220,38,38,.28); background: rgba(220,38,38,.10); color: var(--danger); }

    /* ✅ Make sure Details button never disappears */
    .detailsBtn{
      padding: 8px 10px !important;
      font-size: 12px !important;
      min-width: 88px;
      display:inline-flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .actions{ margin-top: 12px; display:flex; gap: 10px; justify-content:center; flex-wrap:wrap; }

    /* ===== Filters ===== */
    .filterBar{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
    }
    .filterCard{
      flex: 1 1 520px;
      max-width: 1200px;
      border-radius: 18px;
      border: 1px solid rgba(18,28,55,.12);
      background:
        radial-gradient(600px 200px at 10% 0%, rgba(29,78,216,.10), transparent 60%),
        radial-gradient(600px 200px at 90% 0%, rgba(14,165,233,.10), transparent 60%),
        rgba(255,255,255,.78);
      box-shadow: 0 14px 34px rgba(15,23,48,.06);
      padding: 12px;
    }
    .filterGrid{ display:grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items:center; }
    @media (max-width: 740px){ .filterGrid{grid-template-columns: 1fr;} }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; font-weight:1000; color: var(--muted); display:flex; gap:8px; align-items:center; }
    .pillDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(29,78,216,.35);
      box-shadow: 0 0 0 4px rgba(29,78,216,.10);
      flex:0 0 auto;
    }
    .field input{
      border: 1px solid rgba(18,28,55,.14);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      outline:none;
      background: rgba(255,255,255,.90);
      transition: .15s;
    }
    .field input:focus{
      border-color: rgba(29,78,216,.35);
      box-shadow: 0 0 0 5px rgba(29,78,216,.10);
    }
    .filterBtns{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    @media (max-width: 740px){ .filterBtns{justify-content:center;} }

    /* ===== Pager ===== */
    .pager{
      margin-top: 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-weight:1000;
      font-size:12px;
    }

    /* ===== Popup ===== */
    .modal{ display:none; position:fixed; inset:0; z-index:99999; }
    .modal.show{display:block;}
    .modalOverlay{
      position:absolute; inset:0;
      background: rgba(2, 6, 23, .45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .modalDialog{
      position:relative;
      margin: 56px auto 24px;
      width: min(1280px, calc(100vw - 18px));
      max-height: calc(100vh - 90px);
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      background:
        linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92)),
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 26px,
          rgba(18,28,55,.055) 27px
        );
      padding: 14px;
    }
    .modalClose{
      position:sticky; top: 0;
      display:flex; justify-content:flex-end;
      padding: 6px 4px 10px; z-index: 5;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
    }
    .xBtn{
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      border: 1px solid rgba(18,28,55,.18);
      background: rgba(255,255,255,.80);
      color: var(--text);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .paperFrame{
      position: relative;
      z-index: 1;
      border: 1.6px solid rgba(18,28,55,.18);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255,255,255,.55);
      overflow:hidden;
      min-height: 220px;
    }

    .detailsTopBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }

    .markStamp{
      position:absolute;
      top: 58px;
      left: 14px;
      transform: rotate(-10deg);
      padding: 10px 12px 8px;
      border-radius: 12px;
      border: 2px solid rgba(15,23,48,.22);
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 24px rgba(15,23,48,.10);
      user-select:none;
      pointer-events:none;
      display:none;
      min-width: 150px;
    }
    .markStamp .score{
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 34px;
      font-weight: 700;
      letter-spacing: .6px;
      color: rgba(15,23,48,.92);
      line-height: 1.05;
      text-align:left;
    }
    .markStamp .pf{
      margin-top: 4px;
      font-family: "Caveat", "Noto Sans Bengali", cursive;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .4px;
      text-align:left;
    }
    .markStamp .pf.pass{ color: rgba(22,163,74,.95); }
    .markStamp .pf.fail{ color: rgba(220,38,38,.95); }
    .markStamp .note{
      margin-top: 2px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(90,102,133,.9);
      text-align:left;
    }

    .sheetHead{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 8px;
      border-bottom: 1px solid rgba(18,28,55,.10);
      padding-bottom: 12px;
      margin-bottom: 12px;
      text-align:center;
    }
    .sheetTitle{ margin:0; font-size: 14px; font-weight: 1000; line-height:1.35; }
    .sheetSub{ margin:0; color: var(--muted); font-size: 12px; font-weight: 900; line-height:1.55; }
    .sheetStats{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; justify-content:center; }

    .qList{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0;
      border: 1px solid rgba(18,28,55,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.60);
    }
    @media (max-width: 980px){ .qList{grid-template-columns: 1fr;} }
    .qRow{ padding: 10px 10px; border-bottom: 1px solid rgba(18,28,55,.08); }
    @media (min-width: 981px){
      .qRow:nth-child(2n){border-left: 1px solid rgba(18,28,55,.08);}
      .qRow:nth-last-child(-n+2){border-bottom:none;}
    }
    @media (max-width: 980px){ .qRow:last-child{border-bottom:none;} }

    .qHead{display:flex;gap:10px;align-items:flex-start;}
    .qNo{
      flex:0 0 auto;
      font-size:11px;font-weight:1000;
      padding: 6px 9px;border-radius:999px;
      border: 1px solid rgba(18,28,55,.12);
      background: rgba(255,255,255,.70);
      color: var(--muted);white-space:nowrap;
      transform: translateY(1px);
    }
    .qText{margin:0;font-weight:1000;font-size:13px;line-height:1.55;flex:1;}

    .opts{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }
    .optLine{
      display:grid;
      grid-template-columns: 18px 18px 1fr;
      gap: 6px;
      align-items:flex-start;
      padding: 2px 0;
      font-size: 12px;
      line-height: 1.5;
    }
    .markIcon{
      width:18px;height:18px;border-radius:999px;
      display:grid;place-items:center;
      font-weight:1000;
      font-size:11px;
      border: 1px solid rgba(18,28,55,.14);
      background: rgba(255,255,255,.70);
      color: transparent;
      transform: translateY(1px);
    }
    .markIcon.ok{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color: rgba(22,163,74,1);}
    .markIcon.bad{border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.10); color: rgba(220,38,38,1);}
    .markIcon.warn{border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.16); color: rgba(245,158,11,1);}

    .optKey{font-weight:1000;color: var(--muted);}
    .optTxt{font-weight: 900;color: var(--text);}
    .optTxt.ok{color: rgba(22,163,74,1);}
    .optTxt.bad{color: rgba(220,38,38,1);}
    .optTxt.warn{color: rgba(245,158,11,1);}

    .noAnsText{ margin-top: 8px; font-weight: 1000; font-size: 12px; color: rgba(220,38,38,1); }
    .loading{color: var(--muted); font-weight:1000; font-size:13px;}
    .err{color: var(--danger); font-weight:1000; font-size:13px;}

    /* ===== PDF render area (unchanged) ===== */
    .pdfPageArea{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px;
      background:#fff;
      color:#111;
      padding: 16px;
      font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .pdfFrame{
      position: relative;
      border: 2px solid #111;
      padding: 14px;
      min-height: 1040px;
      background:#fff;
      overflow:hidden;
    }
    .pdfWatermark{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      user-select:none;
    }
    .pdfWatermark span{
      transform: rotate(-22deg);
      font-size: 84px;
      font-weight: 1000;
      letter-spacing: 2px;
      opacity: .08;
      color:#111;
      white-space:nowrap;
    }

    /* ===== Footer ===== */
    footer{
      margin-top: 14px;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(900px 320px at 80% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--footTop), var(--footBottom));
      border-top: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
    }
    .footGrid{
      max-width: 1780px;
      margin:0 auto;
      padding: 18px clamp(8px, 2vw, 20px) 10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px 18px;
      align-items:start;
    }
    .footTitle{font-weight:1000;color:#fff;font-size:13px;margin-bottom: 8px;}
    .footText{color: rgba(255,255,255,.70);font-size:12px;line-height:1.6;}
    .footLinks{display:flex;flex-direction:column;gap: 8px;}
    .footLinks a{text-decoration:none;color: rgba(255,255,255,.70);font-size:12px;}
    .footLinks a:hover{color:#fff;text-decoration:underline;text-underline-offset:4px;}

    .socials{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .soc{
      width:40px;height:40px;border-radius:999px;
      display:grid;place-items:center;
      text-decoration:none;
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .soc svg{ width:18px; height:18px; display:block; fill: currentColor; opacity: .92; }
    .soc:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.32);
    }

    .copy{
      max-width: 1780px;
      margin:0 auto;
      padding: 12px clamp(8px, 2vw, 20px) 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.68);
      font-size:12px;
      text-align:center;
      line-height:1.6;
      white-space:normal;
    }
    @media (max-width: 980px){
      .footGrid{grid-template-columns: repeat(2, minmax(0, 1fr));gap: 10px 10px;}
    }
  </style>
</head>

<body>
  <h1 class="srOnly">Model Test Result Sheet</h1>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="name">eProstutiBD</div>
        <div class="tag" id="headerTag">সকল প্রস্তুতি হোক গভীর থেকে</div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="#">একাডেমী</a>
        <a href="#">প্রশ্ন ব্যাঙ্ক</a>
        <a href="#">এডমিশন অ্যাসিস্ট্যান্ট</a>
        <a href="#">জব অ্যাসিস্ট্যান্ট</a>
        <a class="active" href="#" aria-current="page">মডেল টেস্ট</a>
        <a href="#">কারেন্ট এফেয়ার্স</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">নোটিশ</a>
        <a href="#">ব্লগ</a>
        <a href="#">ক্যারিয়ার</a>
      </nav>

      <button class="menuBtn" id="menuBtn" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu" onclick="toggleMenu()">☰</button>
    </div>

    <div class="mobileMenu" id="mobileMenu">
      <div class="overlay" onclick="closeMenu()"></div>
      <div class="drawer" role="dialog" aria-label="Menu" onclick="event.stopPropagation()">
        <a href="#">একাডেমী</a>
        <a href="#">প্রশ্ন ব্যাঙ্ক</a>
        <a href="#">এডমিশন অ্যাসিস্ট্যান্ট</a>
        <a href="#">জব অ্যাসিস্ট্যান্ট</a>
        <a class="active" href="#" aria-current="page">মডেল টেস্ট</a>
        <a href="#">কারেন্ট এফেয়ার্স</a>
        <a href="#">IELTS</a>
        <a href="#">BCS</a>
        <a href="#">নোটিশ</a>
        <a href="#">ব্লগ</a>
        <a href="#">ক্যারিয়ার</a>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="card" aria-label="Result sheet">
      <h2 class="title" id="modelTestTitle">Model Test</h2>
      <p class="sub" id="pageTitle">Result Sheet (Ranking)</p>

      <div class="filterBar" aria-label="Filters">
        <div class="filterCard">
          <div class="filterGrid">
            <div class="field">
              <label for="fName"><span class="pillDot"></span> Name</label>
              <input id="fName" placeholder="নাম লিখুন…" autocomplete="off" />
            </div>
            <div class="field">
              <label for="fZila"><span class="pillDot"></span> Zila</label>
              <input id="fZila" placeholder="জেলা লিখুন…" autocomplete="off" />
            </div>
            <div class="filterBtns">
              <button class="btn btnGhost" type="button" onclick="resetFilters()">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Address</th>
              <th>Submit date</th>
              <th>Right</th>
              <th>Wrong</th>
              <th>No Ans</th>
              <th>Mark</th>
              <th>Time Taken</th>
              <th>Pass/Fail</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="rankBody">
            <tr><td colspan="11">লোড হচ্ছে…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <button class="btn btnGhost" type="button" onclick="prevPage()">Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="btn btnGhost" type="button" onclick="nextPage()">Next</button>
      </div>

      <div class="actions">
        <button class="btnGhost btn" type="button" onclick="backToTest()">Back to Test</button>
      </div>
    </section>
  </div>

  <!-- ✅ Popup Details Modal -->
  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modalOverlay" onclick="closeDetails()"></div>
    <div class="modalDialog" role="dialog" aria-label="Details Popup" onclick="event.stopPropagation()">
      <div class="modalClose">
        <button class="xBtn" type="button" onclick="closeDetails()">✕ Close</button>
      </div>

      <div class="paperFrame" id="paperFrame">
        <div class="detailsTopBar">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <span class="badge" id="detailTimeTaken">Time: --</span>
          </div>
          <button class="btn btnDanger" type="button" onclick="downloadResultPDF()">Download Result PDF</button>
        </div>

        <div class="markStamp" id="markStamp"></div>

        <div class="sheetHead">
          <div>
            <p class="sheetTitle" id="sheetTitle">Details</p>
            <p class="sheetSub" id="sheetSub">—</p>
          </div>
          <div class="sheetStats" id="sheetStats"></div>
        </div>

        <div id="detailContent">
          <div class="loading">প্রশ্ন লোড হচ্ছে…</div>
        </div>
      </div>
    </div>
  </div>

  <div class="pdfPageArea" id="pdfPageArea" aria-hidden="true"></div>

  <footer>
    <div class="footGrid">
      <div>
        <div class="footTitle">eProstutiBD</div>
        <div class="footText">সকল প্রস্তুতি হোক গভীর থেকে</div>
      </div>

      <div>
        <div class="footTitle">দরকারি পেজ</div>
        <div class="footLinks">
          <a href="#">About</a>
          <a href="#">Privacy Policy</a>
          <a href="#">Terms</a>
          <a href="#">Contact</a>
        </div>
      </div>

      <div>
        <div class="footTitle">অন্যান্য</div>
        <div class="footLinks">
          <a href="#">Notice</a>
          <a href="#">Blog</a>
          <a href="#">Career</a>
          <a href="#">Help</a>
        </div>
      </div>

      <div>
        <div class="footTitle">Follow Us</div>
        <div class="socials">
          <a class="soc" href="#" aria-label="Facebook" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M22 12.06C22 6.5 17.52 2 12 2S2 6.5 2 12.06C2 17.08 5.66 21.25 10.44 22v-7.03H7.9v-2.9h2.54V9.86c0-2.52 1.5-3.92 3.8-3.92 1.1 0 2.24.2 2.24.2v2.48h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34V22C18.34 21.25 22 17.08 22 12.06z"/>
            </svg>
          </a>
          <a class="soc" href="#" aria-label="LinkedIn" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4.98 3.5C4.98 4.88 3.87 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.5 23.5h4V7.98h-4V23.5zM8.5 7.98h3.84v2.12h.05c.53-1 1.83-2.12 3.77-2.12 4.03 0 4.77 2.65 4.77 6.09v9.43h-4v-8.36c0-1.99-.04-4.56-2.78-4.56-2.78 0-3.2 2.17-3.2 4.42v8.5h-4V7.98z"/>
            </svg>
          </a>
          <a class="soc" href="#" aria-label="YouTube" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M23.5 6.2s-.23-1.63-.94-2.35c-.9-.95-1.9-.96-2.36-1.02C16.9 2.5 12 2.5 12 2.5h-.01s-4.9 0-8.2.33c-.46.06-1.46.07-2.36 1.02C.73 4.57.5 6.2.5 6.2S0 8.1 0 10v1.99c0 1.9.5 3.8.5 3.8s.23 1.63.93 2.35c.9.95 2.08.92 2.61 1.02 1.89.18 8 .33 8 .33s4.9-.01 8.2-.34c.46-.06 1.46-.07 2.36-1.02.71-.72.94-2.35.94-2.35S24 13.9 24 12V10c0-1.9-.5-3.8-.5-3.8zM9.5 14.98V7.52L15.8 11.25 9.5 14.98z"/>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <div class="copy">© <span id="year"></span> eProstutiBD — All rights reserved</div>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    const $ = (id)=>document.getElementById(id);

    // ===== menu =====
    function openMenu(){ $("mobileMenu").style.display="block"; $("menuBtn").setAttribute("aria-expanded","true"); }
    function closeMenu(){ $("mobileMenu").style.display="none"; $("menuBtn").setAttribute("aria-expanded","false"); }
    function toggleMenu(){ const m=$("mobileMenu"); (m.style.display==="block")?closeMenu():openMenu(); }
    window.toggleMenu = toggleMenu;
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

    // ===== utils =====
    function esc(str){
      return String(str ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function fmtDateOnly(ms){
      const n = Number(ms);
      if(!Number.isFinite(n) || n <= 0) return "--";
      return new Date(n).toLocaleDateString("bn-BD", { year:"numeric", month:"short", day:"2-digit" });
    }
    function fmtTime(ms){
      const n = Number(ms);
      if(!Number.isFinite(n) || n <= 0) return "--";
      return new Date(n).toLocaleString("bn-BD", { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function safeNum(x, fallback){
      const n = Number(x);
      return Number.isFinite(n) ? n : fallback;
    }
    function parseTimeTakenTextToSeconds(t){
      const s = String(t ?? "").trim().toLowerCase();
      if(!s) return Number.POSITIVE_INFINITY;

      if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){
        const parts = s.split(":").map(x=>Number(x));
        if(parts.some(n=>!Number.isFinite(n))) return Number.POSITIVE_INFINITY;
        if(parts.length === 2) return parts[0]*60 + parts[1];
        if(parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
      }

      let total = 0, matched = false;
      const h = s.match(/(\d+)\s*(h|hr|hrs|hour|hours|ঘণ্টা)/);
      if(h){ total += Number(h[1]) * 3600; matched = true; }
      const m = s.match(/(\d+)\s*(m|min|mins|minute|minutes|মিনিট)/);
      if(m){ total += Number(m[1]) * 60; matched = true; }
      const sec = s.match(/(\d+)\s*(s|sec|secs|second|seconds|সেকেন্ড)/);
      if(sec){ total += Number(sec[1]); matched = true; }
      return matched ? total : Number.POSITIVE_INFINITY;
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function setUrlResultId(resId){
      const u = new URL(location.href);
      if(modelTestId) u.searchParams.set("modelTestId", modelTestId);
      u.searchParams.set("resultId", resId);
      history.replaceState({}, "", u.toString());
    }
    function clearUrlResultId(){
      const u = new URL(location.href);
      u.searchParams.delete("resultId");
      history.replaceState({}, "", u.toString());
    }

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
      authDomain: "eprostutibd-webapp.firebaseapp.com",
      projectId: "eprostutibd-webapp",
      storageBucket: "eprostutibd-webapp.firebasestorage.app",
      messagingSenderId: "1044069942330",
      appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
      measurementId: "G-T2G55NMDQT"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const COL_RESULTS = "model_test_result";
    const COL_MODELTESTS = "subject_model_tests";
    const QUESTION_COLLECTION_CANDIDATES = [
      "modeltest_questions","model_test_questions","modeltest_question","modelTest_questions","modeltestQuestions"
    ];

    // ✅ URL params
    let modelTestId = getParam("modelTestId");
    const resultIdFromUrl = getParam("resultId");

    // ===== state =====
    let resultPayload = null;
    let questions = [];

    let allRows = [];
    let filteredRows = [];
    let page = 1;
    const PAGE_SIZE = 25;

    let highlightResultId = resultIdFromUrl || "";

    function backToTest(){
      if(!modelTestId) location.href = "Start-model-test.html";
      else location.href = `Start-model-test.html?modelTestId=${encodeURIComponent(modelTestId)}`;
    }
    window.backToTest = backToTest;

    // ===== answers map =====
    function getMcqMap(p){
      const o = p?.answers?.mcq;
      if(o && typeof o === "object" && !Array.isArray(o)) return o;
      if(Array.isArray(p?.answers?.mcq)){
        const out = {};
        try{ p.answers.mcq.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
        return out;
      }
      return {};
    }
    function getWrittenMap(p){
      const o = p?.answers?.written;
      if(o && typeof o === "object" && !Array.isArray(o)) return o;
      if(Array.isArray(p?.answers?.written)){
        const out = {};
        try{ p.answers.written.forEach(([k,v])=> out[String(k)] = v); }catch(e){}
        return out;
      }
      return {};
    }

    // ===== question helpers =====
    function getQText(q){
      return (q.question ?? q.questionText ?? q.q ?? q.title ?? q.name ?? q.ques ?? q.qus ?? q.question_title ?? "").toString();
    }
    function getOptions(q){
      if(Array.isArray(q.options) && q.options.length) return q.options.slice(0,4).map(x=>String(x ?? ""));
      if(Array.isArray(q.choices) && q.choices.length) return q.choices.slice(0,4).map(x=>String(x ?? ""));
      if(Array.isArray(q.opts) && q.opts.length) return q.opts.slice(0,4).map(x=>String(x ?? ""));
      const o1 = q.option1 ?? q.opt1 ?? q.a ?? q.A ?? q.optionA ?? q.optA ?? q.choiceA;
      const o2 = q.option2 ?? q.opt2 ?? q.b ?? q.B ?? q.optionB ?? q.optB ?? q.choiceB;
      const o3 = q.option3 ?? q.opt3 ?? q.c ?? q.C ?? q.optionC ?? q.optC ?? q.choiceC;
      const o4 = q.option4 ?? q.opt4 ?? q.d ?? q.D ?? q.optionD ?? q.optD ?? q.choiceD;
      return [o1,o2,o3,o4].map(x=>String(x ?? ""));
    }
    function getCorrectIndex(q){
      const v = Number(q.correctIndex);
      return Number.isFinite(v) ? v : -1;
    }
    function isWrittenQuestion(q){
      const t = (q.type ?? q.qType ?? q.questionType ?? q.kind ?? "").toString().toLowerCase();
      return t === "written" || t === "cq" || t === "short" || t === "essay";
    }

    async function fetchQuestionsFromCollection(colName, mtId){
      try{
        const s = await db.collection(colName).where("modelTestId","==", mtId).orderBy("createdAt","asc").get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){
        const s = await db.collection(colName).where("modelTestId","==", mtId).get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }
    }
    async function fetchQuestionsFromSubcollection(mtId){
      const ref = db.collection(COL_MODELTESTS).doc(mtId).collection("questions");
      try{
        const s = await ref.orderBy("createdAt","asc").get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){
        const s = await ref.get();
        return s.docs.map(d=>({ id:d.id, ...d.data() }));
      }
    }

    async function loadQuestionsOnce(){
      if(questions.length) return questions;
      let qs = [];
      for(const col of QUESTION_COLLECTION_CANDIDATES){
        try{
          const got = await fetchQuestionsFromCollection(col, modelTestId);
          if(got && got.length){ qs = got; break; }
        }catch(e){}
      }
      if(!qs.length){
        try{ qs = await fetchQuestionsFromSubcollection(modelTestId); }catch(e){}
      }
      questions = qs || [];
      return questions;
    }

    function calcNoAns(r){
      const totalQ = safeNum(r?.totalQuestion, NaN);
      const right = safeNum(r?.right, NaN);
      const wrong = safeNum(r?.wrong, NaN);

      if(Number.isFinite(safeNum(r?.noAnswer, NaN))) return safeNum(r?.noAnswer, 0);
      if(Number.isFinite(totalQ) && Number.isFinite(right) && Number.isFinite(wrong)){
        const na = totalQ - (right + wrong);
        return na >= 0 ? na : 0;
      }
      return "--";
    }

    function getPassFail(obtained, total){
      const o = safeNum(obtained, 0);
      const t = safeNum(total, 0);
      if(t <= 0) return { ok: null, label: "—" };
      const pct = (o / t) * 100;
      if(pct < 30) return { ok: false, label: "FAIL" };
      return { ok: true, label: "PASS" };
    }

    function normalizeText(s){ return String(s ?? "").toLowerCase().trim(); }

    function applyFilters(){
      const nameQ = normalizeText($("fName").value);
      const zilaQ = normalizeText($("fZila").value);

      filteredRows = allRows.filter(x=>{
        const p = x.p || {};
        const name = normalizeText(p.studentName);
        const zila = normalizeText(p.studentDistrict || p.studentAddress || p.address);
        const okName = !nameQ || name.includes(nameQ);
        const okZila = !zilaQ || zila.includes(zilaQ);
        return okName && okZila;
      });

      page = 1;
      renderPage();

      if(highlightResultId) jumpToAndHighlightResult(highlightResultId);
    }

    function resetFilters(){
      $("fName").value = "";
      $("fZila").value = "";
      applyFilters();
    }
    window.resetFilters = resetFilters;

    function nextPage(){
      const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));
      if(page < totalPages){ page++; renderPage(); }
      if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
    }
    function prevPage(){
      if(page > 1){ page--; renderPage(); }
      if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
    }
    window.nextPage = nextPage;
    window.prevPage = prevPage;

    function renderNoAnsBadge(noAns){
      const n = Number(noAns);
      if(Number.isFinite(n) && n > 0){
        return `<span class="badge bad">${esc(n)}</span>`;
      }
      return `<span class="badge">${esc(noAns)}</span>`;
    }

    function renderPage(){
      const total = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if(page > totalPages) page = totalPages;

      const start = (page - 1) * PAGE_SIZE;
      const slice = filteredRows.slice(start, start + PAGE_SIZE);

      if(!slice.length){
        $("rankBody").innerHTML = `<tr><td colspan="11">কোনো রেজাল্ট পাওয়া যায়নি</td></tr>`;
        $("pageInfo").textContent = `Page 1 / 1`;
        return;
      }

      const html = slice.map((x, idx)=>{
        const p = x.p, r = x.r;
        const name = p.studentName || "--";
        const addr = p.studentDistrict || p.studentAddress || p.address || "--";
        const submittedDateOnly = fmtDateOnly(p.submittedAt);

        const right = (r.right ?? "--");
        const wrong = (r.wrong ?? "--");
        const noAns = calcNoAns(r);

        const mark = (r.obtainedMark ?? x.obtained ?? "--");
        const timeTakenText = (p.timeTakenText ?? "--");

        const pf = getPassFail(r.obtainedMark, r.totalMark);
        const pfBadge = pf.ok === true
          ? `<span class="badge ok">PASS</span>`
          : pf.ok === false
            ? `<span class="badge bad">FAIL</span>`
            : `<span class="badge">—</span>`;

        const globalRank = start + idx + 1;

        return `
          <tr data-result-id="${esc(p.id)}">
            <td><span class="badge">${globalRank}</span></td>
            <td class="colName">${esc(name)}</td>
            <td class="colAddr">${esc(addr)}</td>
            <td>${esc(submittedDateOnly)}</td>
            <td>${esc(right)}</td>
            <td>${esc(wrong)}</td>
            <td>${renderNoAnsBadge(noAns)}</td>
            <td><span class="badge warn">${esc(mark)}</span></td>
            <td><span class="badge">${esc(timeTakenText)}</span></td>
            <td>${pfBadge}</td>
            <td>
              <button class="btn detailsBtn" type="button"
                onclick="openDetailsByResultId('${esc(p.id)}')">Details</button>
            </td>
          </tr>
        `;
      }).join("");

      $("rankBody").innerHTML = html;
      $("pageInfo").textContent = `Page ${page} / ${totalPages}`;

      if(highlightResultId) applyHighlightOnCurrentPage(highlightResultId);
    }

    function clearHighlights(){
      document.querySelectorAll("#rankBody tr.hl").forEach(tr=>tr.classList.remove("hl"));
    }
    function applyHighlightOnCurrentPage(resId){
      clearHighlights();
      const tr = document.querySelector(`#rankBody tr[data-result-id="${CSS.escape(resId)}"]`);
      if(tr) tr.classList.add("hl");
    }

    function jumpToAndHighlightResult(resId){
      if(!resId) return;
      const idx = filteredRows.findIndex(x => x?.p?.id === resId);
      if(idx < 0) return;

      const targetPage = Math.floor(idx / PAGE_SIZE) + 1;
      if(page !== targetPage){
        page = targetPage;
        renderPage();
      }else{
        applyHighlightOnCurrentPage(resId);
      }

      setTimeout(()=>{
        const tr = document.querySelector(`#rankBody tr[data-result-id="${CSS.escape(resId)}"]`);
        if(tr) tr.scrollIntoView({ behavior:"smooth", block:"center" });
      }, 80);
    }

    // ===== Popup (Details) open/close =====
    function openDetailsPopup(){
      $("detailsModal").classList.add("show");
      $("detailsModal").setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeDetails(){
      $("detailsModal").classList.remove("show");
      $("detailsModal").setAttribute("aria-hidden","true");
      $("markStamp").style.display = "none";
      $("detailContent").innerHTML = `<div class="loading">প্রশ্ন লোড হচ্ছে…</div>`;
      clearUrlResultId();
      document.body.style.overflow = "";
    }
    window.closeDetails = closeDetails;

    document.addEventListener("keydown",(e)=>{
      if(e.key === "Escape"){
        closeMenu();
        closeDetails();
      }
    });

    function buildStatBadges(){
      const r = resultPayload?.result || {};
      const right = (r.right ?? "--");
      const wrong = (r.wrong ?? "--");
      const totalQ = (r.totalQuestion ?? "--");
      const noAns = calcNoAns(r);
      return `
        <span class="badge">${esc(totalQ)} Q</span>
        <span class="badge ok">✓ ${esc(right)} Right</span>
        <span class="badge bad">✗ ${esc(wrong)} Wrong</span>
        <span class="badge warn">${esc(noAns)} No Ans</span>
      `;
    }

    function renderMarkStamp(){
      const r = resultPayload?.result || {};
      const obtained = (r.obtainedMark ?? "--");
      const total = (r.totalMark ?? "--");
      const pf = getPassFail(r.obtainedMark, r.totalMark);

      const el = $("markStamp");
      el.innerHTML = `
        <div class="score">${esc(obtained)} / ${esc(total)}</div>
        <div class="pf ${pf.ok === true ? "pass" : pf.ok === false ? "fail" : ""}">${esc(pf.label)}</div>
        <div class="note">Teacher Checked</div>
      `;
      el.style.display = "block";
    }

    function renderDetails(){
      const p = resultPayload || {};
      const r = p.result || {};
      const name = p.studentName || "--";
      const dist = p.studentDistrict || p.studentAddress || p.address || "--";
      const test = p.modelTestName || "Model Test";
      const timeTakenText = p.timeTakenText || "--";

      $("detailTimeTaken").textContent = `Time: ${timeTakenText}`;
      $("sheetTitle").textContent = `${test} — Details Sheet`;
      $("sheetSub").textContent = `${name} (${dist}) • Submitted: ${fmtTime(p.submittedAt)}`;
      $("sheetStats").innerHTML = buildStatBadges();
      renderMarkStamp();

      const mcqMap = getMcqMap(p);
      const wrMap = getWrittenMap(p);
      const letters = ["A","B","C","D"];

      if(!questions.length){
        $("detailContent").innerHTML = `<div class="err">কোনো প্রশ্ন পাওয়া যায়নি।</div>`;
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "qList";

      questions.forEach((q, i)=>{
        const qid = q.id;
        const qno = i + 1;
        const qt = getQText(q) || "(No question text)";

        const row = document.createElement("div");
        row.className = "qRow";
        row.innerHTML = `
          <div class="qHead">
            <span class="qNo">Q${qno}</span>
            <p class="qText">${esc(qt)}</p>
          </div>
        `;

        if(isWrittenQuestion(q)){
          const ans = (wrMap[qid] ?? "").toString().trim();
          const box = document.createElement("div");
          box.style.marginTop = "10px";
          box.style.padding = "10px 12px";
          box.style.border = "1px solid rgba(18,28,55,.12)";
          box.style.borderRadius = "12px";
          box.style.background = "rgba(255,255,255,.75)";
          box.innerHTML = `
            <div style="font-size:12px;color:var(--muted);font-weight:1000;">Your Answer (Written)</div>
            <div style="margin-top:6px;font-weight:900;line-height:1.6;font-size:12.5px;">${esc(ans || "(No Answer)")}</div>
          `;
          row.appendChild(box);
          wrap.appendChild(row);
          return;
        }

        const opts = getOptions(q);
        const correctIdx = getCorrectIndex(q);
        const chosenIdx = Number(mcqMap[qid]);

        const hasChosen = Number.isFinite(chosenIdx) && chosenIdx >= 0;
        const hasCorrect = Number.isFinite(correctIdx) && correctIdx >= 0;

        const optWrap = document.createElement("div");
        optWrap.className = "opts";

        opts.slice(0,4).forEach((op, oi)=>{
          const isCorrect = (hasCorrect && oi === correctIdx);
          const isChosen = (hasChosen && oi === chosenIdx);

          let iconCls = "";
          let iconTxt = "";
          let txtCls = "";

          if(!hasChosen && isCorrect){
            iconCls = "warn"; iconTxt = "✓"; txtCls = "warn";
          }else if(hasChosen && isCorrect){
            iconCls = "ok"; iconTxt = "✓"; txtCls = "ok";
          }
          if(isChosen && !isCorrect){
            iconCls = "bad"; iconTxt = "✗"; txtCls = "bad";
          }

          const div = document.createElement("div");
          div.className = "optLine";
          div.innerHTML = `
            <span class="markIcon ${iconCls}">${iconTxt || ""}</span>
            <span class="optKey">${letters[oi]}.</span>
            <span class="optTxt ${txtCls}">${esc(op || "")}</span>
          `;
          optWrap.appendChild(div);
        });

        row.appendChild(optWrap);

        if(!hasChosen){
          const note = document.createElement("div");
          note.className = "noAnsText";
          note.textContent = "আপনি কোনো উত্তর সিলেক্ট করেননি।";
          row.appendChild(note);
        }

        wrap.appendChild(row);
      });

      $("detailContent").innerHTML = "";
      $("detailContent").appendChild(wrap);
    }

    async function openDetailsByResultId(resId){
      try{
        setUrlResultId(resId);

        $("detailContent").innerHTML = `<div class="loading">Details লোড হচ্ছে…</div>`;
        openDetailsPopup();

        const doc = await db.collection(COL_RESULTS).doc(resId).get();
        if(!doc.exists){
          $("detailContent").innerHTML = `<div class="err">Result পাওয়া যায়নি।</div>`;
          return;
        }

        resultPayload = { id: doc.id, ...doc.data() };

        if(!modelTestId && resultPayload.modelTestId){
          modelTestId = resultPayload.modelTestId;
        }

        await loadModelTestTitle();
        await loadQuestionsOnce();
        renderDetails();
      }catch(e){
        console.error(e);
        $("detailContent").innerHTML = `<div class="err">Details লোড করতে সমস্যা হচ্ছে।</div>`;
      }
    }
    window.openDetailsByResultId = openDetailsByResultId;

    async function loadResultSheet(){
      try{
        const snap = await db.collection(COL_RESULTS)
          .where("modelTestId","==", modelTestId)
          .get();

        if(snap.empty){
          $("rankBody").innerHTML = `<tr><td colspan="11">এই modelTestId এর কোনো result নেই</td></tr>`;
          allRows = [];
          filteredRows = [];
          renderPage();
          return;
        }

        allRows = snap.docs.map(d => {
          const p = { id: d.id, ...d.data() };
          const r = p.result || {};
          const obtained = safeNum(r.obtainedMark, 0);
          const submittedAt = safeNum(p.submittedAt, Number.POSITIVE_INFINITY);

          const timeTakenText = p.timeTakenText || "";
          const timeTakenSec = parseTimeTakenTextToSeconds(timeTakenText);

          return { p, r, obtained, submittedAt, timeTakenSec };
        });

        allRows.sort((a,b)=>{
          if(b.obtained !== a.obtained) return b.obtained - a.obtained;
          if(a.timeTakenSec !== b.timeTakenSec) return a.timeTakenSec - b.timeTakenSec;
          return a.submittedAt - b.submittedAt;
        });

        filteredRows = allRows.slice();
        page = 1;
        renderPage();
      }catch(e){
        console.error(e);
        $("rankBody").innerHTML = `<tr><td colspan="11">Result Sheet লোড করতে সমস্যা হচ্ছে</td></tr>`;
      }
    }

    async function loadModelTestTitle(){
      try{
        if(!modelTestId){
          $("modelTestTitle").textContent = resultPayload?.modelTestName || "Model Test";
          return;
        }
        const doc = await db.collection(COL_MODELTESTS).doc(modelTestId).get();
        if(doc.exists){
          const data = doc.data() || {};
          const name = data.modelTestName || data.title || data.name || "Model Test";
          $("modelTestTitle").textContent = name;
        }else{
          $("modelTestTitle").textContent = resultPayload?.modelTestName || "Model Test";
        }
      }catch(e){
        $("modelTestTitle").textContent = resultPayload?.modelTestName || "Model Test";
      }
    }

    // ===== PDF (keep your existing functions here if needed) =====
    async function renderPageToCanvas(html){
      const area = $("pdfPageArea");
      area.innerHTML = html;
      try{ await document.fonts.ready; }catch(e){}
      return await html2canvas(area, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
    }
    function getPassFailLabel(obtained,total){
      const pf = getPassFail(obtained,total);
      return pf.label;
    }

    // ✅ Minimal PDF functions (same as your previous file) — keep unchanged in your project
    async function downloadResultPDF(){
      alert("PDF অংশটা আপনার আগের কোডের মতোই আছে। চাইলে আমি এখানে পুরো PDF অংশটাও একইভাবে বসিয়ে দিব।");
    }
    window.downloadResultPDF = downloadResultPDF;

    async function boot(){
      // ✅ if only resultId is provided, infer modelTestId from that result
      if(!modelTestId && resultIdFromUrl){
        try{
          const doc = await db.collection(COL_RESULTS).doc(resultIdFromUrl).get();
          if(doc.exists){
            const p = { id: doc.id, ...doc.data() };
            if(p.modelTestId) modelTestId = p.modelTestId;
          }
        }catch(e){}
      }

      if(!modelTestId && !resultIdFromUrl){
        $("modelTestTitle").textContent = "modelTestId পাওয়া যায়নি";
        $("rankBody").innerHTML = `<tr><td colspan="11">URL এ দিন: result-sheet.html?modelTestId=XXXX অথবা result-sheet.html?resultId=YYYY</td></tr>`;
        return;
      }

      $("fName").addEventListener("input", ()=> applyFilters());
      $("fZila").addEventListener("input", ()=> applyFilters());

      await loadModelTestTitle();

      if(modelTestId){
        await loadResultSheet();
        loadQuestionsOnce().catch(()=>{});
      }

      if(resultIdFromUrl){
        highlightResultId = resultIdFromUrl;
        setTimeout(()=> jumpToAndHighlightResult(resultIdFromUrl), 120);
      }
    }

    boot();
  </script>
</body>
</html>
