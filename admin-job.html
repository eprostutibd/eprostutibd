<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Job Assistant (Final)</title>

  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial;background:#f6f7fb;color:#111}
    .wrap{max-width:1250px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:#111827;color:#fff;display:grid;place-items:center;font-weight:900}
    .title{font-weight:900}
    .sub{font-size:12px;color:#6b7280}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb}
    .help{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px;font-size:12px;margin-bottom:12px}

    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .tab{border:1px solid #e5e7eb;background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    .tab.active{background:#111827;color:#fff;border-color:#111827}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1050px){ .grid{grid-template-columns: 430px 1fr;} }

    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;box-shadow:0 10px 26px rgba(0,0,0,.06)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px;font-weight:800}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;outline:none;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .btn{padding:10px 12px;border:0;border-radius:12px;cursor:pointer;font-weight:900}
    .btn.primary{background:#2563eb;color:#fff}
    .btn.danger{background:#e53935;color:#fff}
    .btn.gray{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{font-size:12px;color:#6b7280}
    .msg{font-size:12px;white-space:pre-wrap;margin-top:10px}
    .msg.ok{color:#0f766e}
    .msg.err{color:#b91c1c}
    .hr{height:1px;background:#eee;margin:12px 0}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{font-size:12px;color:#6b7280;font-weight:900}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .kpi .box{border:1px solid #eee;border-radius:12px;padding:10px;background:#f9fafb}
    .badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid #e5e7eb;background:#f9fafb}
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:9999
    }
    .modal{
      width:min(920px,100%);background:#fff;border-radius:14px;border:1px solid #eee;
      box-shadow:0 20px 60px rgba(0,0,0,.2);padding:14px
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalTop h3{margin:0}
  </style>

  <!-- SheetJS for Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">EP</div>
        <div>
          <div class="title">Job Assistant • Admin (Final)</div>
          <div class="sub">Subjects • Question Banks • Exams • Upload MCQ/Written • Manage Questions • Model Tests</div>
        </div>
      </div>
      <div class="muted">
        <span class="pill">Firestore</span>
        <span class="pill">CSV/XLSX Upload</span>
        <span class="pill">Edit/Delete</span>
      </div>
    </div>

    <div class="help">
      <b>তোমার নিয়ম:</b>
      <ul style="margin:6px 0 0 18px;padding:0">
        <li><b>Upload শুধু MCQ / Written</b> (CSV/Excel) ✅</li>
        <li>Subject / Question Bank / Exam / Model Test নাম — <b>ম্যানুয়াল</b> ✅</li>
        <li>Model Test: <b>৩০ প্রশ্ন</b>, <b>৫০ মিনিট</b> fixed ✅ | Written = ২ মার্ক/প্রশ্ন (Total 60), MCQ = ১ মার্ক/প্রশ্ন (Total 30)</li>
      </ul>
    </div>

    <div class="tabs">
      <button class="tab active" data-view="subjects">Subjects</button>
      <button class="tab" data-view="banks">Question Banks</button>
      <button class="tab" data-view="exams">Exam Names</button>
      <button class="tab" data-view="upload">Upload MCQ/Written</button>
      <button class="tab" data-view="questions">Questions Manager</button>
      <button class="tab" data-view="modeltests">Model Tests</button>
    </div>

    <div class="grid">
      <div class="card" id="leftCard"></div>
      <div class="card" id="rightCard"></div>
    </div>

    <p class="muted" style="margin-top:10px">
      ✅ Upload format (MCQ): <code>question, optionA, optionB, optionC, optionD, answer, explanation</code><br/>
      ✅ Upload format (Written): <code>question, answer, explanation</code><br/>
      ✅ Model Test upload: <code>type, question, optionA, optionB, optionC, optionD, answer, explanation</code> (type = mcq/written) — ঠিক ৩০টা row দরকার।
    </p>
  </div>

  <!-- Edit Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Edit</h3>
        <button class="btn gray" id="modalClose">Close</button>
      </div>
      <div class="hr"></div>
      <div id="modalBody"></div>
      <div class="hr"></div>
      <div class="actions">
        <button class="btn primary" id="modalSave">Save</button>
        <button class="btn danger" id="modalDelete">Delete</button>
      </div>
      <p class="msg muted" id="modalMsg"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs,
      onSnapshot, query, orderBy, where, limit, serverTimestamp, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---- Firebase config (yours) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBUBwLuNDSJF1xrkUVTTOXs76f_o4YkBiI",
      authDomain: "eprostutibd-webapp.firebaseapp.com",
      projectId: "eprostutibd-webapp",
      storageBucket: "eprostutibd-webapp.firebasestorage.app",
      messagingSenderId: "1044069942330",
      appId: "1:1044069942330:web:b3fc6c8b75d7b80686a103",
      measurementId: "G-T2G55NMDQT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- Collections ----
    const colSubjects   = collection(db, "job_subjects");        // manual
    const colBanks      = collection(db, "job_question_banks");  // manual
    const colExams      = collection(db, "job_exams");           // manual
    const colQuestions  = collection(db, "job_questions");       // uploaded only
    const colModelTests = collection(db, "job_model_tests");     // manual + rules
    // model test questions -> job_model_tests/{id}/questions (uploaded only)

    // ---- UI refs ----
    const leftCard = document.getElementById("leftCard");
    const rightCard = document.getElementById("rightCard");
    const tabs = document.querySelectorAll(".tab");

    const modalBack = document.getElementById("modalBack");
    const modalClose = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalSave = document.getElementById("modalSave");
    const modalDelete = document.getElementById("modalDelete");
    const modalMsg = document.getElementById("modalMsg");

    let currentView = "subjects";

    // caches
    let subjects = [];
    let banks = [];
    let exams = [];
    let modelTests = [];

    // question manager cache (latest 200)
    let questionsCache = [];
    let modelTestQuestionsCache = []; // for selected model test

    // active modal context
    let modalCtx = null;

    // ---- helpers ----
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
    const show = (el)=>el.style.display="flex";
    const hide = (el)=>el.style.display="none";
    const fmtTS = (ts) => ts?.toDate ? ts.toDate().toLocaleString() : "";
    const byId = (id, arr) => arr.find(x=>x.id===id);

    function setActiveTab(view){
      currentView = view;
      tabs.forEach(t => t.classList.toggle("active", t.dataset.view === view));
      render();
    }
    tabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.view)));

    async function confirmDelete(name){
      return confirm(`ডিলিট করতে চান?\n\n${name}`);
    }

    // ---- CSV/XLSX parsing ----
    function csvToJson(text){
      const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length);
      if(!lines.length) return [];
      const headers = parseCsvLine(lines[0]).map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const vals = parseCsvLine(lines[i]);
        const obj = {};
        headers.forEach((h, idx)=>obj[h] = (vals[idx] ?? "").trim());
        out.push(obj);
      }
      return out;
    }
    function parseCsvLine(line){
      const res=[]; let cur=""; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=!inQ;
        } else if(ch===',' && !inQ){
          res.push(cur); cur="";
        } else cur+=ch;
      }
      res.push(cur);
      return res;
    }
    function readFileToRows(file){
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("File read failed"));

        if(ext === "csv"){
          reader.onload = () => resolve(csvToJson(reader.result));
          reader.readAsText(file);
        } else if(ext === "xlsx" || ext === "xls"){
          reader.onload = () => {
            try{
              const data = new Uint8Array(reader.result);
              const wb = XLSX.read(data, { type: "array" });
              const ws = wb.Sheets[wb.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
              resolve(rows);
            }catch(e){ reject(e); }
          };
          reader.readAsArrayBuffer(file);
        } else reject(new Error("Only CSV/XLSX supported"));
      });
    }

    async function batchInsert(docsArray, targetCollection){
      const chunkSize = 450; // safe under 500 writes
      let total = 0;
      for(let i=0;i<docsArray.length;i+=chunkSize){
        const chunk = docsArray.slice(i, i+chunkSize);
        const batch = writeBatch(db);
        chunk.forEach(d => batch.set(doc(targetCollection), d));
        await batch.commit();
        total += chunk.length;
      }
      return total;
    }

    // ---- subscribe core data ----
    onSnapshot(query(colSubjects, orderBy("createdAt","desc")), (snap)=>{
      subjects = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(["subjects","upload","questions","modeltests"].includes(currentView)) render();
    });
    onSnapshot(query(colBanks, orderBy("createdAt","desc")), (snap)=>{
      banks = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(["banks","upload","questions"].includes(currentView)) render();
    });
    onSnapshot(query(colExams, orderBy("createdAt","desc")), (snap)=>{
      exams = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(["exams","upload","questions","modeltests"].includes(currentView)) render();
    });
    onSnapshot(query(colModelTests, orderBy("createdAt","desc")), (snap)=>{
      modelTests = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(["modeltests"].includes(currentView)) render();
    });

    // ---- modal ----
    modalClose.onclick = ()=> { hide(modalBack); modalCtx=null; };
    modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack){ hide(modalBack); modalCtx=null; } });

    function openModal(ctx){
      modalCtx = ctx;
      modalMsg.className="msg muted";
      modalMsg.textContent="";
      modalTitle.textContent = ctx.title;
      modalBody.innerHTML = ctx.bodyHTML;
      show(modalBack);

      modalSave.onclick = ctx.onSave;
      modalDelete.onclick = ctx.onDelete;
      modalDelete.style.display = ctx.onDelete ? "inline-block" : "none";
    }

    // ---- render router ----
    function render(){
      if(currentView === "subjects") renderSubjects();
      if(currentView === "banks") renderBanks();
      if(currentView === "exams") renderExams();
      if(currentView === "upload") renderUpload();
      if(currentView === "questions") renderQuestionsManager();
      if(currentView === "modeltests") renderModelTests();
    }

    // =========================
    // SUBJECTS (manual CRUD)
    // =========================
    function renderSubjects(){
      leftCard.innerHTML = `
        <h3>Subject Add (Manual)</h3>
        <div class="row">
          <div class="col">
            <label>Subject Name</label>
            <input id="subName" placeholder="যেমন: বাংলা / ইংরেজি / সাধারণ জ্ঞান" />
          </div>
          <button id="subAdd" class="btn primary">Add</button>
        </div>
        <p id="subMsg" class="msg muted"></p>
      `;

      rightCard.innerHTML = `
        <h3>All Subjects <span class="pill">${subjects.length}</span></h3>
        <table>
          <thead><tr><th>Name</th><th>Created</th><th>Action</th></tr></thead>
          <tbody>
            ${subjects.map(s=>`
              <tr>
                <td><b>${esc(s.name)}</b></td>
                <td class="muted">${fmtTS(s.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn gray" data-edit="${s.id}">Edit</button>
                    <button class="btn danger" data-del="${s.id}">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="3" class="muted">No subjects yet.</td></tr>`}
          </tbody>
        </table>
      `;

      document.getElementById("subAdd").onclick = async ()=>{
        const msg = document.getElementById("subMsg");
        msg.className="msg muted";
        const name = document.getElementById("subName").value.trim();
        if(!name){ msg.textContent="Subject name দিন"; return; }
        msg.textContent="Saving...";
        try{
          await addDoc(colSubjects, { name, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
          document.getElementById("subName").value="";
          msg.className="msg ok"; msg.textContent="✅ Added";
        }catch(e){ msg.className="msg err"; msg.textContent=e.message||"Failed"; }
      };

      rightCard.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick = ()=>{
          const item = byId(b.dataset.edit, subjects);
          openModal({
            title: "Edit Subject",
            bodyHTML: `
              <div class="row">
                <div class="col">
                  <label>Subject Name</label>
                  <input id="m_name" value="${esc(item?.name||"")}" />
                </div>
              </div>
            `,
            onSave: async ()=>{
              const newName = document.getElementById("m_name").value.trim();
              if(!newName){ modalMsg.className="msg err"; modalMsg.textContent="Name required"; return; }
              try{
                await updateDoc(doc(db,"job_subjects",item.id), { name:newName, updatedAt: serverTimestamp() });
                modalMsg.className="msg ok"; modalMsg.textContent="✅ Saved";
              }catch(e){ modalMsg.className="msg err"; modalMsg.textContent=e.message||"Failed"; }
            },
            onDelete: async ()=>{
              if(!(await confirmDelete(item?.name||item.id))) return;
              await deleteDoc(doc(db,"job_subjects",item.id));
              hide(modalBack);
            }
          });
        };
      });

      rightCard.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = async ()=>{
          const item = byId(b.dataset.del, subjects);
          if(!(await confirmDelete(item?.name||item.id))) return;
          await deleteDoc(doc(db,"job_subjects",item.id));
        };
      });
    }

    // =========================
    // QUESTION BANKS (manual CRUD)
    // =========================
    function renderBanks(){
      leftCard.innerHTML = `
        <h3>Question Bank Add (Manual)</h3>
        <div class="row">
          <div class="col">
            <label>Bank Name</label>
            <input id="bankName" placeholder="যেমন: ব্যাংক জব প্রশ্ন ব্যাংক / প্রাইমারি প্রশ্ন ব্যাংক" />
          </div>
          <button id="bankAdd" class="btn primary">Add</button>
        </div>
        <p id="bankMsg" class="msg muted"></p>
      `;

      rightCard.innerHTML = `
        <h3>All Question Banks <span class="pill">${banks.length}</span></h3>
        <table>
          <thead><tr><th>Name</th><th>Created</th><th>Action</th></tr></thead>
          <tbody>
            ${banks.map(s=>`
              <tr>
                <td><b>${esc(s.name)}</b></td>
                <td class="muted">${fmtTS(s.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn gray" data-edit="${s.id}">Edit</button>
                    <button class="btn danger" data-del="${s.id}">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="3" class="muted">No banks yet.</td></tr>`}
          </tbody>
        </table>
      `;

      document.getElementById("bankAdd").onclick = async ()=>{
        const msg = document.getElementById("bankMsg");
        msg.className="msg muted";
        const name = document.getElementById("bankName").value.trim();
        if(!name){ msg.textContent="Bank name দিন"; return; }
        msg.textContent="Saving...";
        try{
          await addDoc(colBanks, { name, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
          document.getElementById("bankName").value="";
          msg.className="msg ok"; msg.textContent="✅ Added";
        }catch(e){ msg.className="msg err"; msg.textContent=e.message||"Failed"; }
      };

      rightCard.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick = ()=>{
          const item = byId(b.dataset.edit, banks);
          openModal({
            title: "Edit Question Bank",
            bodyHTML: `
              <div class="row">
                <div class="col">
                  <label>Bank Name</label>
                  <input id="m_name" value="${esc(item?.name||"")}" />
                </div>
              </div>
            `,
            onSave: async ()=>{
              const newName = document.getElementById("m_name").value.trim();
              if(!newName){ modalMsg.className="msg err"; modalMsg.textContent="Name required"; return; }
              try{
                await updateDoc(doc(db,"job_question_banks",item.id), { name:newName, updatedAt: serverTimestamp() });
                modalMsg.className="msg ok"; modalMsg.textContent="✅ Saved";
              }catch(e){ modalMsg.className="msg err"; modalMsg.textContent=e.message||"Failed"; }
            },
            onDelete: async ()=>{
              if(!(await confirmDelete(item?.name||item.id))) return;
              await deleteDoc(doc(db,"job_question_banks",item.id));
              hide(modalBack);
            }
          });
        };
      });

      rightCard.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = async ()=>{
          const item = byId(b.dataset.del, banks);
          if(!(await confirmDelete(item?.name||item.id))) return;
          await deleteDoc(doc(db,"job_question_banks",item.id));
        };
      });
    }

    // =========================
    // EXAMS (manual CRUD)
    // =========================
    function renderExams(){
      leftCard.innerHTML = `
        <h3>Exam Name Add (Manual)</h3>
        <div class="row">
          <div class="col">
            <label>Exam Name</label>
            <input id="examName" placeholder="যেমন: ব্যাংক / এনটিআরসি / প্রাইমারি" />
          </div>
          <button id="examAdd" class="btn primary">Add</button>
        </div>
        <p id="examMsg" class="msg muted"></p>
      `;

      rightCard.innerHTML = `
        <h3>All Exam Names <span class="pill">${exams.length}</span></h3>
        <table>
          <thead><tr><th>Name</th><th>Created</th><th>Action</th></tr></thead>
          <tbody>
            ${exams.map(s=>`
              <tr>
                <td><b>${esc(s.name)}</b></td>
                <td class="muted">${fmtTS(s.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn gray" data-edit="${s.id}">Edit</button>
                    <button class="btn danger" data-del="${s.id}">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="3" class="muted">No exams yet.</td></tr>`}
          </tbody>
        </table>
      `;

      document.getElementById("examAdd").onclick = async ()=>{
        const msg = document.getElementById("examMsg");
        msg.className="msg muted";
        const name = document.getElementById("examName").value.trim();
        if(!name){ msg.textContent="Exam name দিন"; return; }
        msg.textContent="Saving...";
        try{
          await addDoc(colExams, { name, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
          document.getElementById("examName").value="";
          msg.className="msg ok"; msg.textContent="✅ Added";
        }catch(e){ msg.className="msg err"; msg.textContent=e.message||"Failed"; }
      };

      rightCard.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick = ()=>{
          const item = byId(b.dataset.edit, exams);
          openModal({
            title: "Edit Exam Name",
            bodyHTML: `
              <div class="row">
                <div class="col">
                  <label>Exam Name</label>
                  <input id="m_name" value="${esc(item?.name||"")}" />
                </div>
              </div>
            `,
            onSave: async ()=>{
              const newName = document.getElementById("m_name").value.trim();
              if(!newName){ modalMsg.className="msg err"; modalMsg.textContent="Name required"; return; }
              try{
                await updateDoc(doc(db,"job_exams",item.id), { name:newName, updatedAt: serverTimestamp() });
                modalMsg.className="msg ok"; modalMsg.textContent="✅ Saved";
              }catch(e){ modalMsg.className="msg err"; modalMsg.textContent=e.message||"Failed"; }
            },
            onDelete: async ()=>{
              if(!(await confirmDelete(item?.name||item.id))) return;
              await deleteDoc(doc(db,"job_exams",item.id));
              hide(modalBack);
            }
          });
        };
      });

      rightCard.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = async ()=>{
          const item = byId(b.dataset.del, exams);
          if(!(await confirmDelete(item?.name||item.id))) return;
          await deleteDoc(doc(db,"job_exams",item.id));
        };
      });
    }

    // =========================
    // UPLOAD (only MCQ/Written)
    // - subject required
    // - bank optional
    // - exam optional
    // =========================
    function renderUpload(){
      const subjectOpt = subjects.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");
      const bankOpt = `<option value="">(Optional) None</option>` + banks.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");
      const examOpt = `<option value="">(Optional) None</option>` + exams.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");

      leftCard.innerHTML = `
        <h3>Upload MCQ/Written (CSV/XLSX)</h3>

        <div class="row">
          <div class="col">
            <label>Subject (required)</label>
            <select id="uplSubject">
              <option value="">-- select subject --</option>
              ${subjectOpt}
            </select>
          </div>
          <div class="col">
            <label>Question Bank (optional)</label>
            <select id="uplBank">${bankOpt}</select>
          </div>
          <div class="col">
            <label>Exam (optional)</label>
            <select id="uplExam">${examOpt}</select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Type</label>
            <select id="uplType">
              <option value="mcq">MCQ</option>
              <option value="written">Written</option>
            </select>
          </div>
          <div class="col">
            <label>Upload File (CSV/XLSX)</label>
            <input id="uplFile" type="file" accept=".csv,.xlsx,.xls" />
          </div>
          <button id="uplBtn" class="btn primary">Upload</button>
        </div>

        <p id="uplMsg" class="msg muted"></p>

        <div class="hr"></div>
        <div class="muted">
          <b>MCQ columns:</b> question, optionA, optionB, optionC, optionD, answer, explanation<br/>
          <b>Written columns:</b> question, answer, explanation
        </div>
      `;

      rightCard.innerHTML = `
        <h3>Upload Rules</h3>
        <div class="kpi">
          <div class="box"><b>Upload only</b><div class="muted">MCQ / Written ✅</div></div>
          <div class="box"><b>Manual</b><div class="muted">Subject / Bank / Exam ✅</div></div>
          <div class="box"><b>After upload</b><div class="muted">Edit/Delete in Questions Manager ✅</div></div>
        </div>
        <div class="hr"></div>
        <p class="muted">
          Upload complete হলে “Questions Manager” tab থেকে subject/bank/exam/type দিয়ে filter করে Edit/Delete করতে পারবে।
        </p>
      `;

      document.getElementById("uplBtn").onclick = async ()=>{
        const msg = document.getElementById("uplMsg");
        msg.className="msg muted";
        const subjectId = document.getElementById("uplSubject").value;
        const bankId = document.getElementById("uplBank").value || "";
        const examId = document.getElementById("uplExam").value || "";
        const type = document.getElementById("uplType").value;
        const file = document.getElementById("uplFile").files?.[0];

        if(!subjectId){ msg.textContent="Subject required"; return; }
        if(!file){ msg.textContent="File required"; return; }

        msg.textContent="Reading file...";
        try{
          const rows = await readFileToRows(file);
          if(!rows.length){ msg.textContent="No rows found"; return; }

          const docs = [];
          for(const r of rows){
            const q = String(r.question ?? r.Question ?? "").trim();
            if(!q) continue;

            if(type === "mcq"){
              const A = String(r.optionA ?? r.A ?? "").trim();
              const B = String(r.optionB ?? r.B ?? "").trim();
              const C = String(r.optionC ?? r.C ?? "").trim();
              const D = String(r.optionD ?? r.D ?? "").trim();
              const ans = String(r.answer ?? r.Answer ?? "").trim();
              const exp = String(r.explanation ?? r.Explanation ?? "").trim();

              docs.push({
                subjectId, bankId, examId,
                type:"mcq",
                question:q,
                options:[A,B,C,D],
                answer:ans,
                explanation:exp,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
            } else {
              const ans = String(r.answer ?? r.Answer ?? "").trim();
              const exp = String(r.explanation ?? r.Explanation ?? "").trim();

              docs.push({
                subjectId, bankId, examId,
                type:"written",
                question:q,
                answer:ans,
                explanation:exp,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
            }
          }

          if(!docs.length){
            msg.className="msg err";
            msg.textContent="Valid rows নেই। কলাম নাম ঠিক আছে তো?";
            return;
          }

          msg.textContent=`Uploading ${docs.length} questions...`;
          const inserted = await batchInsert(docs, colQuestions);
          msg.className="msg ok";
          msg.textContent=`✅ Uploaded: ${inserted}`;
          document.getElementById("uplFile").value="";
        }catch(e){
          msg.className="msg err";
          msg.textContent=e.message||"Upload failed";
        }
      };
    }

    // =========================
    // QUESTIONS MANAGER
    // - list/filter
    // - edit/delete (after upload)
    // =========================
    function renderQuestionsManager(){
      const subjectOpt = `<option value="">All</option>` + subjects.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");
      const bankOpt = `<option value="">All</option>` + banks.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");
      const examOpt = `<option value="">All</option>` + exams.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");

      leftCard.innerHTML = `
        <h3>Questions Manager</h3>
        <div class="row">
          <div class="col">
            <label>Subject</label>
            <select id="qSub">${subjectOpt}</select>
          </div>
          <div class="col">
            <label>Bank</label>
            <select id="qBank">${bankOpt}</select>
          </div>
          <div class="col">
            <label>Exam</label>
            <select id="qExam">${examOpt}</select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Type</label>
            <select id="qType">
              <option value="">All</option>
              <option value="mcq">MCQ</option>
              <option value="written">Written</option>
            </select>
          </div>
          <div class="col">
            <label>Search text</label>
            <input id="qSearch" placeholder="question text..." />
          </div>
          <button id="qLoad" class="btn primary">Load</button>
        </div>

        <p class="msg muted" id="qMsg"></p>
      `;

      rightCard.innerHTML = `
        <h3>Loaded Questions <span class="pill" id="qCount">0</span></h3>
        <div class="muted">Load চাপলে সর্বোচ্চ 200টা recent প্রশ্ন দেখাবে। Edit/Delete available ✅</div>
        <div id="qTableWrap" class="small muted" style="margin-top:10px">No data loaded.</div>
      `;

      async function loadQuestions(){
        const msg = document.getElementById("qMsg");
        msg.className="msg muted";
        msg.textContent="Loading...";
        const sub = document.getElementById("qSub").value;
        const bank = document.getElementById("qBank").value;
        const exam = document.getElementById("qExam").value;
        const type = document.getElementById("qType").value;
        const search = document.getElementById("qSearch").value.trim().toLowerCase();

        try{
          // Firestore: for simplicity, we load recent 200 then filter in JS
          const snap = await getDocs(query(colQuestions, orderBy("createdAt","desc"), limit(200)));
          let rows = snap.docs.map(d=>({id:d.id, ...d.data()}));

          if(sub) rows = rows.filter(r=>r.subjectId===sub);
          if(bank) rows = rows.filter(r=>r.bankId===bank);
          if(exam) rows = rows.filter(r=>r.examId===exam);
          if(type) rows = rows.filter(r=>r.type===type);
          if(search) rows = rows.filter(r=>String(r.question||"").toLowerCase().includes(search));

          questionsCache = rows;

          document.getElementById("qCount").textContent = String(rows.length);

          const table = `
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Question</th>
                  <th>Subject/Bank/Exam</th>
                  <th>Created</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(q=>`
                  <tr>
                    <td><span class="badge">${esc(q.type)}</span></td>
                    <td>
                      <b>${esc(q.question)}</b>
                      ${q.type==="mcq" ? `<div class="muted">A:${esc(q.options?.[0]||"")} • B:${esc(q.options?.[1]||"")} • C:${esc(q.options?.[2]||"")} • D:${esc(q.options?.[3]||"")}</div>
                      <div class="muted">Ans: ${esc(q.answer||"")}</div>` : `<div class="muted">Ans: ${esc(q.answer||"")}</div>`}
                    </td>
                    <td class="muted">
                      <div>Sub: ${esc(byId(q.subjectId, subjects)?.name || "-")}</div>
                      <div>Bank: ${esc(q.bankId ? (byId(q.bankId,banks)?.name || "-") : "-")}</div>
                      <div>Exam: ${esc(q.examId ? (byId(q.examId,exams)?.name || "-") : "-")}</div>
                    </td>
                    <td class="muted">${fmtTS(q.createdAt)}</td>
                    <td>
                      <div class="actions">
                        <button class="btn gray" data-qedit="${q.id}">Edit</button>
                        <button class="btn danger" data-qdel="${q.id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join("") || `<tr><td colspan="5" class="muted">No match.</td></tr>`}
              </tbody>
            </table>
          `;
          document.getElementById("qTableWrap").innerHTML = table;

          document.querySelectorAll("[data-qedit]").forEach(b=>{
            b.onclick = ()=> openQuestionEditModal(byId(b.dataset.qedit, questionsCache));
          });
          document.querySelectorAll("[data-qdel]").forEach(b=>{
            b.onclick = async ()=>{
              const item = byId(b.dataset.qdel, questionsCache);
              if(!(await confirmDelete(item?.question || item.id))) return;
              await deleteDoc(doc(db,"job_questions", item.id));
              await loadQuestions();
            };
          });

          msg.className="msg ok";
          msg.textContent=`✅ Loaded ${rows.length}`;
        }catch(e){
          msg.className="msg err";
          msg.textContent=e.message||"Failed";
        }
      }

      document.getElementById("qLoad").onclick = loadQuestions;
    }

    function openQuestionEditModal(item){
      if(!item) return;
      const isMcq = item.type === "mcq";
      openModal({
        title: `Edit Question (${item.type})`,
        bodyHTML: `
          <div class="row">
            <div class="col">
              <label>Question</label>
              <textarea id="m_q">${esc(item.question||"")}</textarea>
            </div>
          </div>

          ${isMcq ? `
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Option A</label><input id="m_a" value="${esc(item.options?.[0]||"")}" /></div>
              <div class="col"><label>Option B</label><input id="m_b" value="${esc(item.options?.[1]||"")}" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Option C</label><input id="m_c" value="${esc(item.options?.[2]||"")}" /></div>
              <div class="col"><label>Option D</label><input id="m_d" value="${esc(item.options?.[3]||"")}" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Answer</label><input id="m_ans" value="${esc(item.answer||"")}" placeholder="A/B/C/D or text"/></div>
              <div class="col"><label>Explanation</label><input id="m_exp" value="${esc(item.explanation||"")}" /></div>
            </div>
          ` : `
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Answer</label><textarea id="m_ans">${esc(item.answer||"")}</textarea></div>
              <div class="col"><label>Explanation</label><textarea id="m_exp">${esc(item.explanation||"")}</textarea></div>
            </div>
          `}
        `,
        onSave: async ()=>{
          modalMsg.className="msg muted";
          modalMsg.textContent="Saving...";
          try{
            const q = document.getElementById("m_q").value.trim();
            if(!q){ modalMsg.className="msg err"; modalMsg.textContent="Question required"; return; }

            if(isMcq){
              const A = document.getElementById("m_a").value.trim();
              const B = document.getElementById("m_b").value.trim();
              const C = document.getElementById("m_c").value.trim();
              const D = document.getElementById("m_d").value.trim();
              const ans = document.getElementById("m_ans").value.trim();
              const exp = document.getElementById("m_exp").value.trim();
              await updateDoc(doc(db,"job_questions",item.id), {
                question:q, options:[A,B,C,D], answer:ans, explanation:exp, updatedAt: serverTimestamp()
              });
            } else {
              const ans = document.getElementById("m_ans").value.trim();
              const exp = document.getElementById("m_exp").value.trim();
              await updateDoc(doc(db,"job_questions",item.id), {
                question:q, answer:ans, explanation:exp, updatedAt: serverTimestamp()
              });
            }
            modalMsg.className="msg ok";
            modalMsg.textContent="✅ Saved";
          }catch(e){
            modalMsg.className="msg err";
            modalMsg.textContent=e.message||"Failed";
          }
        },
        onDelete: async ()=>{
          if(!(await confirmDelete(item?.question||item.id))) return;
          await deleteDoc(doc(db,"job_questions", item.id));
          hide(modalBack);
        }
      });
    }

    // =========================
    // MODEL TESTS (manual CRUD + upload questions exactly 30 + edit/delete)
    // =========================
    function renderModelTests(){
      const mtOpt = modelTests.map(m=>`<option value="${m.id}">${esc(m.name)}</option>`).join("");

      leftCard.innerHTML = `
        <h3>Model Test (Manual)</h3>
        <div class="row">
          <div class="col">
            <label>Model Test Name (manual)</label>
            <input id="mtName" placeholder="যেমন: Model Test - 01" />
          </div>
          <div class="col">
            <label>Type</label>
            <select id="mtType">
              <option value="written">Written (2 mark/question)</option>
              <option value="monthly">Monthly (1 mark/question)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col"><label>Questions (fixed)</label><input value="30" disabled /></div>
          <div class="col"><label>Time (fixed)</label><input value="50 minutes" disabled /></div>
          <div class="col"><label>Total Marks (auto)</label><input id="mtTotal" value="60" disabled /></div>
          <button id="mtAdd" class="btn primary">Add</button>
        </div>
        <p id="mtMsg" class="msg muted"></p>

        <div class="hr"></div>

        <h3>Upload Model Test Questions (CSV/XLSX)</h3>
        <div class="row">
          <div class="col">
            <label>Select Model Test</label>
            <select id="mtPick">
              <option value="">-- select --</option>
              ${mtOpt}
            </select>
          </div>
          <div class="col">
            <label>Upload File (must be exactly 30 rows)</label>
            <input id="mtFile" type="file" accept=".csv,.xlsx,.xls" />
          </div>
          <button id="mtUpl" class="btn primary">Upload</button>
        </div>
        <p id="mtUplMsg" class="msg muted"></p>

        <div class="hr"></div>
        <h3>Manage Model Test Questions</h3>
        <div class="row">
          <div class="col">
            <label>Select Model Test</label>
            <select id="mtPickManage">
              <option value="">-- select --</option>
              ${mtOpt}
            </select>
          </div>
          <button id="mtLoadQ" class="btn gray">Load Questions</button>
        </div>
        <p id="mtLoadMsg" class="msg muted"></p>
      `;

      rightCard.innerHTML = `
        <h3>All Model Tests <span class="pill">${modelTests.length}</span></h3>
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Type</th><th>Q</th><th>Time</th><th>Total</th><th>Created</th><th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${modelTests.map(m=>`
              <tr>
                <td><b>${esc(m.name)}</b></td>
                <td><span class="badge">${esc(m.type)}</span></td>
                <td>${m.questionCount ?? 30}</td>
                <td>${m.durationMinutes ?? 50} min</td>
                <td>${m.totalMarks ?? ""}</td>
                <td class="muted">${fmtTS(m.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn gray" data-mtedit="${m.id}">Edit</button>
                    <button class="btn danger" data-mtdel="${m.id}">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="7" class="muted">No model tests yet.</td></tr>`}
          </tbody>
        </table>

        <div class="hr"></div>
        <div id="mtQWrap" class="muted">Select a model test and load questions to edit/delete.</div>
      `;

      // auto total
      const mtType = document.getElementById("mtType");
      const mtTotal = document.getElementById("mtTotal");
      mtType.onchange = ()=> mtTotal.value = (mtType.value==="written" ? 60 : 30);

      document.getElementById("mtAdd").onclick = async ()=>{
        const msg = document.getElementById("mtMsg");
        msg.className="msg muted";
        const name = document.getElementById("mtName").value.trim();
        const type = document.getElementById("mtType").value;
        if(!name){ msg.textContent="Model test name required"; return; }

        const questionCount = 30;
        const durationMinutes = 50;
        const perQuestionMark = (type==="written") ? 2 : 1;
        const totalMarks = questionCount * perQuestionMark;

        msg.textContent="Saving...";
        try{
          await addDoc(colModelTests, {
            name, type,
            questionCount, durationMinutes,
            perQuestionMark, totalMarks,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          document.getElementById("mtName").value="";
          msg.className="msg ok"; msg.textContent="✅ Added";
        }catch(e){ msg.className="msg err"; msg.textContent=e.message||"Failed"; }
      };

      rightCard.querySelectorAll("[data-mtedit]").forEach(b=>{
        b.onclick = ()=>{
          const item = byId(b.dataset.mtedit, modelTests);
          openModal({
            title: "Edit Model Test",
            bodyHTML: `
              <div class="row">
                <div class="col">
                  <label>Name</label>
                  <input id="m_name" value="${esc(item?.name||"")}" />
                </div>
                <div class="col">
                  <label>Type</label>
                  <select id="m_type">
                    <option value="written" ${item?.type==="written"?"selected":""}>written</option>
                    <option value="monthly" ${item?.type==="monthly"?"selected":""}>monthly</option>
                  </select>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">Rules fixed: 30 questions, 50 minutes. Marks auto update.</div>
            `,
            onSave: async ()=>{
              const name = document.getElementById("m_name").value.trim();
              const type = document.getElementById("m_type").value;
              if(!name){ modalMsg.className="msg err"; modalMsg.textContent="Name required"; return; }

              const per = (type==="written") ? 2 : 1;
              const total = 30 * per;

              try{
                await updateDoc(doc(db,"job_model_tests", item.id), {
                  name, type, perQuestionMark: per, totalMarks: total, updatedAt: serverTimestamp()
                });
                modalMsg.className="msg ok"; modalMsg.textContent="✅ Saved";
              }catch(e){ modalMsg.className="msg err"; modalMsg.textContent=e.message||"Failed"; }
            },
            onDelete: async ()=>{
              if(!(await confirmDelete(item?.name||item.id))) return;
              await deleteDoc(doc(db,"job_model_tests", item.id));
              hide(modalBack);
            }
          });
        };
      });

      rightCard.querySelectorAll("[data-mtdel]").forEach(b=>{
        b.onclick = async ()=>{
          const item = byId(b.dataset.mtdel, modelTests);
          if(!(await confirmDelete(item?.name||item.id))) return;
          await deleteDoc(doc(db,"job_model_tests", item.id));
        };
      });

      // Upload model test questions (exactly 30)
      document.getElementById("mtUpl").onclick = async ()=>{
        const msg = document.getElementById("mtUplMsg");
        msg.className="msg muted";
        const mtId = document.getElementById("mtPick").value;
        const file = document.getElementById("mtFile").files?.[0];
        if(!mtId){ msg.textContent="Select model test"; return; }
        if(!file){ msg.textContent="Select file"; return; }

        msg.textContent="Reading file...";
        try{
          const rows = await readFileToRows(file);

          // count only valid rows with question
          const valid = rows
            .map(r=>({
              type:String(r.type ?? r.Type ?? "mcq").trim().toLowerCase(),
              question:String(r.question ?? r.Question ?? "").trim(),
              optionA:String(r.optionA ?? r.A ?? "").trim(),
              optionB:String(r.optionB ?? r.B ?? "").trim(),
              optionC:String(r.optionC ?? r.C ?? "").trim(),
              optionD:String(r.optionD ?? r.D ?? "").trim(),
              answer:String(r.answer ?? r.Answer ?? "").trim(),
              explanation:String(r.explanation ?? r.Explanation ?? "").trim()
            }))
            .filter(x=>x.question);

          if(valid.length !== 30){
            msg.className="msg err";
            msg.textContent=`❌ Model Test এর জন্য ঠিক ৩০টা প্রশ্ন লাগবে। এখন আছে: ${valid.length}`;
            return;
          }

          const subCol = collection(db, "job_model_tests", mtId, "questions");

          // before upload, optional: clear old questions (so always exactly 30)
          msg.textContent="Clearing old questions...";
          const oldSnap = await getDocs(query(subCol, limit(500)));
          if(!oldSnap.empty){
            const batch = writeBatch(db);
            oldSnap.docs.forEach(d=>batch.delete(d.ref));
            await batch.commit();
          }

          msg.textContent="Uploading 30 questions...";
          const docs = [];
          let order = 1;
          for(const r of valid){
            const type = (r.type==="written") ? "written" : "mcq";
            if(type==="mcq"){
              docs.push({
                order: order++,
                type:"mcq",
                question:r.question,
                options:[r.optionA,r.optionB,r.optionC,r.optionD],
                answer:r.answer,
                explanation:r.explanation,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
            }else{
              docs.push({
                order: order++,
                type:"written",
                question:r.question,
                answer:r.answer,
                explanation:r.explanation,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
            }
          }

          await batchInsert(docs, subCol);

          msg.className="msg ok";
          msg.textContent="✅ Uploaded 30 questions";
          document.getElementById("mtFile").value="";
        }catch(e){
          msg.className="msg err";
          msg.textContent=e.message||"Upload failed";
        }
      };

      // Load model test questions to manage
      document.getElementById("mtLoadQ").onclick = async ()=>{
        const msg = document.getElementById("mtLoadMsg");
        msg.className="msg muted";
        const mtId = document.getElementById("mtPickManage").value;
        if(!mtId){ msg.textContent="Select model test"; return; }

        msg.textContent="Loading...";
        try{
          const subCol = collection(db, "job_model_tests", mtId, "questions");
          const snap = await getDocs(query(subCol, orderBy("order","asc"), limit(200)));
          modelTestQuestionsCache = snap.docs.map(d=>({id:d.id, ...d.data()}));

          msg.className="msg ok";
          msg.textContent=`✅ Loaded: ${modelTestQuestionsCache.length}`;

          const wrap = document.getElementById("mtQWrap");
          wrap.innerHTML = `
            <h4 style="margin:0 0 8px">Model Test Questions (${modelTestQuestionsCache.length})</h4>
            <table>
              <thead><tr><th>#</th><th>Type</th><th>Question</th><th>Action</th></tr></thead>
              <tbody>
                ${modelTestQuestionsCache.map(q=>`
                  <tr>
                    <td>${q.order ?? ""}</td>
                    <td><span class="badge">${esc(q.type)}</span></td>
                    <td>
                      <b>${esc(q.question)}</b>
                      ${q.type==="mcq" ? `<div class="muted">A:${esc(q.options?.[0]||"")} • B:${esc(q.options?.[1]||"")} • C:${esc(q.options?.[2]||"")} • D:${esc(q.options?.[3]||"")}</div>
                      <div class="muted">Ans: ${esc(q.answer||"")}</div>` : `<div class="muted">Ans: ${esc(q.answer||"")}</div>`}
                    </td>
                    <td>
                      <div class="actions">
                        <button class="btn gray" data-mtqedit="${q.id}">Edit</button>
                        <button class="btn danger" data-mtqdel="${q.id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `;

          wrap.querySelectorAll("[data-mtqedit]").forEach(b=>{
            b.onclick = ()=>{
              const item = modelTestQuestionsCache.find(x=>x.id===b.dataset.mtqedit);
              openModelTestQuestionModal(mtId, item);
            };
          });
          wrap.querySelectorAll("[data-mtqdel]").forEach(b=>{
            b.onclick = async ()=>{
              const item = modelTestQuestionsCache.find(x=>x.id===b.dataset.mtqdel);
              if(!(await confirmDelete(item?.question||item.id))) return;
              await deleteDoc(doc(db, "job_model_tests", mtId, "questions", item.id));
              // reload
              document.getElementById("mtLoadQ").click();
            };
          });

        }catch(e){
          msg.className="msg err";
          msg.textContent=e.message||"Failed";
        }
      };
    }

    function openModelTestQuestionModal(mtId, item){
      if(!item) return;
      const isMcq = item.type==="mcq";
      openModal({
        title: `Edit Model Test Q (${item.type})`,
        bodyHTML: `
          <div class="row">
            <div class="col">
              <label>Question</label>
              <textarea id="m_q">${esc(item.question||"")}</textarea>
            </div>
          </div>

          ${isMcq ? `
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Option A</label><input id="m_a" value="${esc(item.options?.[0]||"")}" /></div>
              <div class="col"><label>Option B</label><input id="m_b" value="${esc(item.options?.[1]||"")}" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Option C</label><input id="m_c" value="${esc(item.options?.[2]||"")}" /></div>
              <div class="col"><label>Option D</label><input id="m_d" value="${esc(item.options?.[3]||"")}" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Answer</label><input id="m_ans" value="${esc(item.answer||"")}" /></div>
              <div class="col"><label>Explanation</label><input id="m_exp" value="${esc(item.explanation||"")}" /></div>
            </div>
          ` : `
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Answer</label><textarea id="m_ans">${esc(item.answer||"")}</textarea></div>
              <div class="col"><label>Explanation</label><textarea id="m_exp">${esc(item.explanation||"")}</textarea></div>
            </div>
          `}
        `,
        onSave: async ()=>{
          modalMsg.className="msg muted";
          modalMsg.textContent="Saving...";
          try{
            const q = document.getElementById("m_q").value.trim();
            if(!q){ modalMsg.className="msg err"; modalMsg.textContent="Question required"; return; }

            if(isMcq){
              const A = document.getElementById("m_a").value.trim();
              const B = document.getElementById("m_b").value.trim();
              const C = document.getElementById("m_c").value.trim();
              const D = document.getElementById("m_d").value.trim();
              const ans = document.getElementById("m_ans").value.trim();
              const exp = document.getElementById("m_exp").value.trim();
              await updateDoc(doc(db,"job_model_tests",mtId,"questions",item.id), {
                question:q, options:[A,B,C,D], answer:ans, explanation:exp, updatedAt: serverTimestamp()
              });
            }else{
              const ans = document.getElementById("m_ans").value.trim();
              const exp = document.getElementById("m_exp").value.trim();
              await updateDoc(doc(db,"job_model_tests",mtId,"questions",item.id), {
                question:q, answer:ans, explanation:exp, updatedAt: serverTimestamp()
              });
            }

            modalMsg.className="msg ok";
            modalMsg.textContent="✅ Saved";
          }catch(e){
            modalMsg.className="msg err";
            modalMsg.textContent=e.message||"Failed";
          }
        },
        onDelete: async ()=>{
          if(!(await confirmDelete(item?.question||item.id))) return;
          await deleteDoc(doc(db,"job_model_tests",mtId,"questions",item.id));
          hide(modalBack);
        }
      });
    }

    // ---- initial render ----
    render();
  </script>
</body>
</html>
